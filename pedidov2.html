<!DOCTYPE html>  
<html ng-app="appV2">  
<head> 
	<meta charset="utf 8">
<!-- Imports CSS-->

	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/bootstrap.min.css">
	<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"> <!-- Icones -->
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/jquery.dataTables.min.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/angular-datatables.min.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.colVis.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.tableTools.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/datatables.bootstrap.min.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/isteven-multi-select.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/font-awesome/css/all.min.css">
	<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.min.css">
<!-- Imports CSS-->

<!-- View --> 
</head>  
<body>
	<div>
		<div ng-controller="MainController">

			<div ng-show="exibeFormulario" class="container col-sm-12">
				<button class="btn btn_acao_header btn_cor_padrao" ng-click="listarDocumentos()"> Listar </button>

				<!-- Header formulario -->
				<div class="divider-titulo col-sm-12">
					<div class="spacer titulo vcenter">
						Novo pedido
					</div>			
				</div>
				<!-- Header formulario -->
				
				<!-- Capa do pedido -->
				<div class="row spacer">
					
					<div class="col-sm-12">

						<!-- Body formulario -->
						<div class="col-sm-4 spacer">
							<label>Tipo venda:</label>	
							<div class="input-group">
								<input 
									type="text" 
									ng-model="frmTipoVenda"
									id="frmTipoVenda" 
									placeholder="Informe o tipo de venda" 
									uib-typeahead="tpv.tipoVenda for tpv in getTipoPedido($viewValue)" 
									typeahead-on-select="onSelectTipoPedido($item, $model, $label)" 
									class="form-control" 
									required="true" 
									autocomplete="off" 
									typeahead-min-length="0" 
								>
								<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaTipoPedido()"><i class="glyphicon glyphicon-remove"></i></span>  
							</div>
							<i ng-show="loadingFrmTipoVenda" class="glyphicon glyphicon-refresh"></i>
						</div>

						<div class="col-sm-4 spacer">
							<label>Tabela de preço:</label>	
							<input type="text" placeholder="Informe a tabela de preço" class="form-control" ng-model="tabelaPreco">
						</div>

						<div class="col-sm-4 spacer">
							<label>Cliente</label>	
							<input type="text" placeholder="Informe o cliente" class="form-control" ng-model="cliente">
						</div>

						<div class="col-sm-4 spacer">
							<label>Endereço de entrega</label>	
							<input type="text" placeholder="Informe o endereço de entrega" class="form-control" ng-model="endEntrega">
						</div>
						
						<div class="col-sm-4 spacer">
							<label>Previsão entrega</label>	
							<input type="text" placeholder="Informe a previsão de entrega" class="form-control" ng-model="prevEntrega">
						</div>

						<div class="form-group col-md-12  col-sm-12 spacer">
							<label for="frmObservacao">Descrição: <span ng-show="frmOrcamentoEmail.frmObservacao.$error.required" style="color: red">*</span></label>
							<textarea class="form-control" rows="3" id="frmObservacao" ng-model="frmObservacao" name="frmObservacao" ng-trim="false" maxlength="249"></textarea>
							<span>Restam {{249 - frmObservacao.length}} caracteres.</span>
						</div>
				
					</div>		

				</div>
				<!-- Capa do pedido -->
				<hr class="divider">

				<div class="row spacer">
					<div class="col-sm-12">
						<h1>TESTE</h1>
						<h1>TESTE</h1>
						<h1>TESTE</h1>
						<h1>TESTE</h1>
					</div>
				</div>
				
				<hr class="divider">
				<!-- Ações sob o formulario -->
				<div class="row spacer">
					<div class="pull-right" style="padding-right: 10px;">
						<div class="btn-group">
							<button class="btn btn_grid btn_cor_padrao" ng-click="listarDocumentos()"> Cancelar </button>
						</div>
						<div class="btn-group">
							<button class="btn btn_grid btn_cor_padrao" ng-click="salvarForm()"> Salvar </button>
						</div>	
					</div>
				</div>
			
				<hr class="divider">				

			</div>
		</div>

		<div ng-controller="ColumnsController">			
			<!-- Listagem de documentos na tabela  -->
			<div ng-show="exibeListaDocumentos">
				<table id="gridPedidoV2" dt-options="dtOptions" dt-columns="dtColumns" dt-instance="dtInstance" class="row-border hover table-striped table-bordered"/>
			</div>
			<!-- Listagem de documentos na tabela  -->
		</div>
	</div>
<!-- View --> 

<!-- Scripts importados -->
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/jquery-3.1.1.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/easytimer.min.js"></script>	
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-route.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-ui-router.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-cookies.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angular-ui-notification/angular-ui-notification.min.js"></script>  
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/ui-bootstrap-tpls-2.5.0.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/dist/jquery.dataTables.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/dist/angular-datatables.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/bootstrap.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.bootstrap.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.factory.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.options.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/dataTables.buttons.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.colVis.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.flash.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.html5.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.print.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.buttons.min.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-locale_pt-br.js"></script>
	<script src="http://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-sanitize.min.js"></script>
<!-- Scripts importados -->	
</body>  
</html>

<!-- Regra de negócio -->
<script>	
	(function () {
		'use strict';
		angular
			.module("appV2",['ngRoute', 'ngSanitize', 'ui.bootstrap', 'datatables', 'datatables.buttons']);

			var app = angular.module('appV2');

			app.controller("MainController", MainController);
			function MainController($scope, $http, $rootScope, $timeout) {  

				$rootScope.exibeFormulario 		= false; 
				$rootScope.exibeListaDocumentos = true; 

				$rootScope.listarDocumentos = () => {
					$rootScope.exibeListaDocumentos = true;
					$rootScope.exibeFormulario 		= false;

					$rootScope.getListaDocumentos();
				};
								
				$scope.executaRequisicaoExterna = async ($json) => {
					try{
						let response = await $http.post(parent.dadosUserLogado().cContextIntegracao + '/rest/Listas/executarRequisicaoExterna', $json);
						
						return response.data;
					}catch(response){
						SrvMsg.geraMensagem("erro", "Não foi possível completar a requisição. Por favor, tente novamente mais tarde.");
					}
				};
				
				/*Irá retornar os documentos para o usuario - EX: Pedidos
					Funcionalidade: Chama 'executarRequisicaoExterna', passando o json esperado pela regra;
					------
					View: $scope.listaDocs - Listagem de documentos, EX: Pedidos
				*/
				$rootScope.getListaDocumentos = async () =>{
					console.log('a');
					let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj	: parent.dadosUserLogado().cId,
						numreg		: 750, 
						pRotina		: "listarProdutoB2B",
						pCodCli     : parent.dadosUserLogado().rId,
						pNomPro     : "",
						pTipPro     : "",
					});

					console.log(result);
					$scope.listaDocs = result;
					$scope.$apply();
				};
				//$rootScope.getListaDocumentos();

				$scope.getTipoPedido = function(val) {
					return $http.post('/clicVendas/rest/Listas/tipoPedido', {
						params: {
							filtro		: val || '', 
							idCvTccnpj	: parent.dadosUserLogado().cId 
						}
					}).then(function(response){     
						if (response.data.length == 1) {
							$rootScope.objVenda.tipoVenda	= response.data[0];
							$scope.frmTipoVenda				= response.data[0].tipoVenda;					
						}
						return response.data.map(function(item){					
							return item;
						});
					});
				};

				$scope.limpaTipoPedido = function () {						
					$scope.frmTipoVenda	= "";
					//$rootScope.objVenda.tipoVenda	= null;
					let cTipoPedido		= angular.element(document.querySelector('#frmTipoVenda'));
					$timeout(function () {
						cTipoPedido.focus();
					}, 200);                  
				};

				$scope.onSelectTipoPedido = function ($item, $model, $label) {
					$rootScope.objVenda.tipoVenda = $item;						
				};    

				$rootScope.salvarForm = () => {
					console.log($rootScope.objVenda)
					let dados = {
						tipoVenda		: $scope.tipoVenda,
						tabelaPreco		: $scope.tabelaPreco,
						cliente			: $scope.cliente,
						endEntrega		: $scope.endEntrega,
						prevEntrega 	: $scope.prevEntrega,
						frmObservacao	: $scope.frmObservacao,
					};

					
					console.log(dados);
				};
				
			};

			app.controller("ColumnsController", ColumnsController);
			function ColumnsController(DTOptionsBuilder, DTColumnDefBuilder, DTColumnBuilder, DTDefaultOptions, $scope, $rootScope, $compile, $http, $timeout, $window){

				var vm = this;

				$rootScope.abreFormPedido = ($id) =>{					
					delete $rootScope.objVenda;
					$rootScope.ehNovoPedido = false;

					if (angular.isDefined($id)){
						$http({
							method	: 'POST',
							url		: '/clicVendas/rest/pedido/consulta/' + $id,
							data	: {idCvTccnpj : parent.dadosUserLogado().cId}				
						}).then(
							function successCallback(response) {
								if	(response.resultado == 'ERRO'){
									console.log(response.data.resultado, response.data.mensagem);
								} else {					
									$rootScope.objVenda		= response.data.parametros.venda;										
									$rootScope.idPedido		= $rootScope.objVenda.id; 
								};					
							}, 
							function errorCallback(response) {
								console.log("critica", "Não foi possível carregar o pedido. Tente novamente mais tarde. ");
							}
						);
					} else {
						$rootScope.ehNovoPedido	= true;	
						$rootScope.idPedido		= 0; 
						$rootScope.objVenda 	= {};
					};
					
					$rootScope.exibeListaDocumentos = false;
					$rootScope.exibeFormulario 		= true;

					console.log($rootScope.objVenda);

					$scope.$apply();
				};
				
				// Define o idioma usado no Datatables
				DTDefaultOptions.setLanguageSource('plugins/pt-br.json');

				console.log(parent.dadosUserLogado());
				
				var idGridDB = 3; /* Código Cadastro Grid banco */
				$http({
					url: '/clicVendas/rest/Listas/listaColunasGrid',
					method: 'POST',
					data : {cId : parent.dadosUserLogado().cId, idGrid : idGridDB} 	
				}).then(function(response) {

					$scope.dtOptions = DTOptionsBuilder.newOptions()            
					.withOption('ajax', {
						url		: '/clicVendas/rest/pedido/lista',
						type	: 'POST',
						data	: function(d) {
									var	parametros = {
										idGrid : idGridDB
									};
									d.parametros = parametros;
									
									var filtros = {
											dtEmissaoInicio			: ((angular.isUndefined($rootScope.dtEmissaoInicio) || $rootScope.dtEmissaoInicio == null)?"":$rootScope.dtEmissaoInicio.toLocaleDateString()),
											dtEmissaoFim			: ((angular.isUndefined($rootScope.dtEmissaoFim) || $rootScope.dtEmissaoFim == null)?"":$rootScope.dtEmissaoFim.toLocaleDateString()),
											dtPrevisaoInicio		: ((angular.isUndefined($rootScope.dtPrevisaoInicio) || $rootScope.dtPrevisaoInicio == null)?"":$rootScope.dtPrevisaoInicio.toLocaleDateString()),
											dtPrevisaoFim 			: ((angular.isUndefined($rootScope.dtPrevisaoFim) || $rootScope.dtPrevisaoFim == null)?"":$rootScope.dtPrevisaoFim.toLocaleDateString()),
											idCvtccnpj 				: (angular.isUndefined(parent.dadosUserLogado().cId)?0:parent.dadosUserLogado().cId),
											rId 					: parent.dadosUserLogado().rId,
											rTipoId 				: parent.dadosUserLogado().rTipoId,
											listaStatusPed		  	: $rootScope.statusPedSel,
											listaFilSincronizacao	: $rootScope.filSincronizacaoSel,
											listaTipoPed			: $rootScope.tipoPedSel,
											filEhOrcamento			: $rootScope.filEhOrcamento,
											listaFiltroRamoAtividade: $rootScope.filRamoAtividade,	
											listaFiltroOrigem		: $rootScope.filOrigem	
									};
									d.filtros = filtros;
									return JSON.stringify(d);
								}
							})
							.withDataProp('data')
							.withOption('processing', true)
							.withOption('serverSide', true)
							.withOption('searchDelay', 1000)
							.withOption('scrollY', "100%")            
							.withPaginationType('full_numbers')            
							.withDisplayLength(20)
							.withDOM('<"toolbar">ftrip')
							.withButtons([
						{
							// enabled: parent.dadosUserLogado().params.paramPermiteCadastrarPedido == 'S',
							text: 'Novo',
							key: '1',
							className: 'btn_grid btn_cor_padrao',
							action: function (e, dt, node, config) {
								$rootScope.usarItensCarrinho = false;
								$scope.dadosExternosNovoPedido = 'undefined';						
								$rootScope.abreFormPedido();						
							}
						},
						{
							text: 'Filtrar',
							key: '2',
							className: 'btn_grid btn_cor_padrao',
							action: function (e, dt, node, config) {
								vm.abreModalFiltro();
							}
						},
						{
							text: 'Atualizar',
							key: '4',
							className: 'btn_grid btn_cor_padrao',
							action: function (e, dt, node, config) {
								vm.atualizarPedidos();
							}
						},
							
					]);	

					

					var montaColunas = response.data.columns;									
					$scope.dtColumns = montaColunas;

					/* Personalizar as Colunas */
					angular.forEach($scope.dtColumns, function (item,index){								
						switch (item.data) {
											
							
							// case 'mobile':					
							// 	montaColunas[index].mRender		= function(data, type, row) {return vm.retornaMobile(row.mobile)};
							// 	montaColunas[index].sClass 		= 'text-center';											
							// break;
							
							// case 'status':					
							// 	montaColunas[index].mRender		= function(data, type, row) {return vm.retornaIcStatus(row.status)};
							// 	montaColunas[index].sClass 		= 'text-center';											
							// break;
							
							// case 'sincronizado':						
							// 	montaColunas[index].mRender		= function(data, type, row) {return vm.retornaIcSinc(row.sincronizado, row.logIntegracao)};
							// 	montaColunas[index].sClass 		= 'text-center';					
							// break;
							
							case 'tipoVenda':						
								montaColunas[index].mRender		= function(data, type, row) {return (row.tipoVenda != null)?row.tipoVenda.tipoVenda:""};						
							break;
							
							case 'dataEmissao':						
								montaColunas[index].mRender		= function(data, type, row) {return row.dataEmissaoFormat};			
							break;
							
							case 'previsaoEntrega':						
								montaColunas[index].mRender		= function(data, type, row) {return row.previsaoEntregaFormat};	
							break;
							
							case 'totalVenda':						
								montaColunas[index].mRender		= function(data, type, row) {return row.totalVendaFormat};
							break;

							case 'origem':						
								montaColunas[index].mRender		= function(data, type, row) {return row.origem};
							break;

							case 'ramoAtividade':						
								montaColunas[index].mRender		= function(data, type, row) {return row.ramoAtividade};
							break;

							// case 'botoes':						
							// 	montaColunas[index].mRender		= vm.retornaBotoes;
							// 	montaColunas[index].sClass 		= 'colBtn';						
							// break;
							default:
						}
					});
					
					$scope.dtOptions.withOption('order', response.data.order);	
													
					//Inicializa DataTable
					angular.element('#gridPedidoV2').attr('datatable', '');
					$compile(angular.element('#gridPedidoV2'))($scope);
					
					$scope.dtOptions.withOption('fnRowCallback',
						function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
							$compile(nRow)($scope);
					});		
					
				});
				
			};

			app.controller("UtilsController", UtilsController);
			function UtilsController($scope, $rootScope, $http){
								
			};
	})();
</script> 
				
<style>
	:root {
			--cor_principal: #047cca;
	}
				
	.btn_grid{
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
	}

	.btn_acao_header{
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
		width: 80px;
		height: 35px;
		font-size: 0.88em;
	}

	.btn_cor_padrao {
		background-color: var(--cor_principal) !important;
		border-color: var(--cor_principal) !important; 
	}

	.container{
		height: calc(100% - 40px); 
		position: relative;
	}

	.divider{
		border-top: 1px solid #bbb;
	}
	
	.divider-titulo{
		border-top: 0.8px solid #bbb;
		border-bottom: 0.8px solid #bbb;
		height: 50px;
		margin-top: 5px;
	}

	.spacer{
		margin-top:20px;
	}

	.titulo{
		font-size: 15px;
		font-weight: 900;
	}

	.vcenter {
		display: flex;
		align-items: center;
	}
	
</style>