<!DOCTYPE html>
<html ng-app="appV2">
<head>
	<meta charset="utf-8" />
	<!-- Imports CSS-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"
		crossorigin="anonymous">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/angular-datatables.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.colVis.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.tableTools.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.css">
	<link rel="stylesheet"
		href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/datatables.bootstrap.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/isteven-multi-select.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/font-awesome/css/all.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.min.css">
	<!-- Imports CSS-->
	<!-- View -->
</head>
<body>
	<div class="container" ng-controller="MainController">
		<!--Primeira pagina-->
		<div ng-show="exibeListaDocumentos">
			<!-- Sidebar Menu FILTRO -->
			<div id="mySidebar" class="sidebar">
				<div class="header-filtro-tabela">
					<p style="text-align: center; color:white; font-weight: 900; ">Filtro<span ng-click="openNav()"
							style="color: white; margin-left:70%" class="glyphicon glyphicon-minus"></span></p>
				</div>
				<form style="margin-top:5px">
					<div class="form-group">
						<label for="filFornecedores">Pesquisar</label>
						<input 
							type="text" 
							style="width: 220px;" 
							class="form-control spacer-input" 
							id="filPesquisaGeral"
							ng-model="filPesquisaGeral" 
							autocomplete="off" 
							aria-describedby=" "
							placeholder="Digite a palavra chave. Ex: '123'">
					</div>
					<div class="form-group">
						<label for="filCliente">Cliente</label>
						<input 
							type="text" 
							style="width: 220px;" 
							class="form-control spacer-input" 
							id="filCliente"
							autocomplete="off" 
							ng-model="filCliente" 
							aria-describedby=" " 
							placeholder=" ">
					</div>
					<div class="form-group">
						<label for="filCarteira">Data Emissão</label>
						<input 
							type="text" 
							style="width: 220px;" 
							ui-mask="99/99/9999" 
							class="form-control spacer-input"
							autocomplete="off" 
							id="filDataEmissao" 
							ng-model="filDataEmissao" 
							aria-describedby=" ">
					</div>
					<div class="form-group">
						<label for="projeto">Sincronização</label>
						<input 
							type="text" 
							style="width: 220px;" 
							class="form-control spacer-input"
							ng-value="filSincronizado.nome" 
							ng-model="filSincronizado" 
							id="filSincronizado"
							uib-typeahead="(sincronizado.nome) for sincronizado in getFilScinronizacao($viewValue)"
							autocomplete="off" 
							typeahead-min-length="0"
							typeahead-on-select="onSelectFilSincronizacao($item, $model, $label)">
					</div>
				</form>
				<div class="text-center" style="height: 50px;">
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-click="aplicarFiltros()"> Buscar </button>
					</div>
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-click="limparFiltros();"> Limpar </button>
					</div>
				</div>
			</div>
			<!--Sidebar Menu FILTRO-->
			<!-- Tabela -->
			<div id="main">
				<!-- Tabela Simplificada -->
				<div class="col-sm-12 col-md-12 col-xs-12">
					<table id="listDocuments" dt-options="dtOptions" dt-columns="dtColumns" dt-instance="dtInstance"
						class="row-border responsive hover"></table>
				</div>
			</div>
			<!-- Tabela -->
		</div>
		<!--Primeira pagina-->
		<!-- FORM NOVO DOCUMENTO -->
		<div ng-show="exibeFormulario">
			<!-- Header formulario -->
			<div class="divider-titulo row">
				<div class="spacer titulo vcenter col-sm-12">
					<div class="col-sm-6 itens-titulo">
						<button class="btn btn_acao_header btn_cor_padrao" ng-click="changeView()"><span
								class="glyphicon glyphicon-menu-left"></span> Voltar</button>
						<button style="text-align: center; width: 120px;" class="btn btn_acao_header btn_cor_padrao"
							ng-hide="exibeHistoricos" ng-click="abreHistoricos()"><span
								class="glyphicon glyphicon-list-alt"></span> Histórico </button>
					</div>
					<div class="col-sm-6">
						<h5 style="margin-top: 0; margin-left:-15%; font-size: 14px;">{{tipoFormulario}}</h5>
					</div>
				</div>
			</div>
			<!-- Header formulario -->
			<!-- Capa do pedido -->
			<div class="row">
				<form name="cadastroPedido">
					<div ng-hide="exibeHistoricos" class="col-sm-12 spacer">
						<!-- Informações resumidas do pedido / Pedido ja laçado no ERP-->
						<div class="row">
							<div ng-show="sincronizado === 'DOCUMENTO_SINCRONIZADO'" class="form-group col-md-12">
								<div style="background-color: #FBFBFB">
									<div class="col-sm-12">
										<div class="panel panel-default spacer-input">
											<div class="panel-heading">Sobre o orçamento</div>
												<div class="panel-body">
													<div class="col-sm-4 spacer-input">
														<h5>Tipo de orçamento</h5>
														<p>{{tipoOrcamento}}</p>
													</div>
													<div class="col-sm-4 spacer-input">
														<h5>Emissão do Orçamento</h5>
														<p>{{emissaoOrcamento || 'não informado'}}</p>
													</div>
													<div class="col-sm-4 spacer-input">
														<h5>Validade do Orçamento</h5>
														<p>{{validadeOrcamento || 'não informado'}}</p>
													</div>
											</div>
										</div>
									</div>
									<div class="col-sm-12">
										<div class="panel panel-default spacer-input">
											<div class="panel-heading">Informações sobre o frete</div>
												<div class="panel-body">
													<div class="col-sm-4 spacer-input">
														<h5>Tipo de Frete</h5>
														<p>{{tabTipoFrete || 'não informado'}}</p>
													</div>
													<div class="col-sm-4 spacer-input ">
														<h5>Tabela de Frete</h5>
														<p>{{tabFrete || 'não informado'}}</p>
													</div>
													<div class="col-sm-4 spacer-input ">
														<h5>Total de Frete</h5>
														<p>{{totalFrete || 'não informado'}}</p>
													</div>
											</div>
										</div>
									</div>
									<div class="col-sm-12">
										<div class="panel panel-default spacer-input">
											<div class="panel-heading">Orçamento Feito</div>
												<div class="panel-body">
													<div class="col-sm-4 spacer-input">
														<h5>Usuario digitação</h5>
														<p>{{usuarioDigitacao || 'não informado'}}</p>
													</div>
													<div class="col-sm-4 spacer-input">
														<h5>Filial</h5>
														<p>{{filial}}</p>
													</div>
													<div class="col-sm-4 spacer-input">
														<h5>Representante</h5>
														<p>{{representante || 'não informado'}}</p>
													</div>
												</div>
											</div>
									</div>
									<div class="col-sm-12">
										<div class="panel panel-default spacer-input">
											<div class=" panel-heading">Sobre o pagamento</div>
												<div class="panel-body">
													<div class="col-sm-4 spacer-input">
														<h5>Condição de pagamento</h5>
														<p>{{condPagamento.nome || 'não informado'}}</p>
													</div>
													<div class="col-sm-4 spacer-input">
														<h5>Forma de pagamento</h5>
														<p>{{formaPagamento.nome || 'não informado'}}</p>
													</div>
													<div class="col-sm-4 spacer-input">
														<h5>Total</h5>
														<p>R${{valorPrecoTotal || 'não informado'}}</p>
													</div>
												</div>
											</div>
									</div>
									<div class="col-sm-12">
										<div class="panel panel-default spacer-input">
											<div class=" panel-heading">Sobre o cliente</div>
												<div class="panel-body">
													<div class="col-sm-4 spacer-input">
														<h5>Previsao de entrega do cliente</h5>
														<p>{{prevEntregCli || 'não informado'}}</p>
													</div>
													<div class="col-sm-4 spacer-input">
														<h5>Cliente</h5>
														<p>{{frmCliente.nome}}</p>
													</div>
													<div class="col-sm-4 spacer-input ">
														<h5>Tabela de preço</h5>
														<p>{{tabPreco.nome}}</p>
													</div>
												</div>
											</div>
									</div>
									<div class="col-sm-6">
										<div class="panel panel-default spacer-input">
											<div class=" panel-heading">Outros</div>
												<div class="panel-body">
													<div class="col-sm-6 spacer-input">
														<h5>Situação</h5>
														<p>{{situacao || 'não informado'}}</p>
													</div>
													<div class="col-sm-6 spacer-input">
														<h5>Observação</h5>
														<p>{{observacao || 'não informado'}}</p>
													</div>
												</div>
											</div>
									</div>
								</div>
								<!--Tabela onde mostra os produtos-->
								<div style="margin-top: 2%; padding:0;" class="col-sm-12 spacer">
									<pre>
										<div class="scroll-div">
											<table style="margin-top: 1%;" id="tabelaProdutos" class="table-bordered">
												<thead>
													<tr>
														<th>OC/PO                 </th>
														<th>it.OC/PO              </th>
														<th>Cod.Prod.Cliente      </th>
														<th>Descr.Produto.Cliente </th>
														<th>Preço Venda(FOB)      </th>
														<th>Preço do Frete        </th>
														<th>Preço da venda(CIF)   </th>
														<th>QTD.Pedida            </th>
														<th>%Oferta Preço         </th>
														<th>Preço Liquido         </th>
														<th>Vlr.Liquido           </th>
														<th>Peso(KG)              </th>
														<th>Volume(M3)            </th>
														<th>Qtd Emb               </th>
														<th>Desc Emb              </th>
														<th>Qtd.Sub.Emb           </th>
														<th>Descr.Sub Emb         </th>
														<th>Data(PCP)             </th>
														<th>Data(ETD)             </th>
														<th>%Acres.Preço          </th>
														<th>%Desconto Fin         </th>
														<th>Vlr. Desconto         </th>
														<th>Vlr. Bruto            </th>
														<th>Cod.Pro               </th>
														<th>Deriv                 </th>
														<th>UM                    </th>
														<th>Previsao do cliente   </th>
														<th>Emb					  </th>
														<th>Sub Emb				  </th>
														<th>Descr. Produto		  </th>
														<th>Descr. Deriv          </th>
														<th>Nr. Pedido			  </th>
														<th>Seq. Ped			  </th>
													</tr>
												</thead>
												<tbody>
													<tr ng-repeat="produto in produtos">
														<td>
															<div>
																{{produto.ocpo}}
															</div>
														</td>
														<td>
															<div>
																{{produto.itocpo}}
															</div>
														</td>
														<td>
															<div>
																{{produto.codProCli}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descrProCli}}
															</div>
														</td>
														<td>
															<div>
															   {{produto.precoVendFOB}}
															</div>
														</td>
														<td>
															<div>
																{{produto.precoFrete}}
															</div>
														</td>
														<td>
															<div>
																{{produto.precoVendaCIF}}
															</div>
														</td>
														<td>
															<div>
																<input
																readonly
																value="0"
																ng-change="calcularProdutos()"
																type="number"
																class="inputNumberTable"
																ng-model="produto.qtdPedida"
																typeahead-min-lenght = "1">
															</div>
														</td>
														<td>
															<div>
																<input
																readonly
																value="0"
																ng-change="calcularProdutos()"
																type="number"
																class="inputNumberTable"
																ng-model="produto.ofertaPreco"
																typeahead-min-lenght = "1">
															</div>
														</td>
														<td>
															<div>
																{{produto.precoLiquido}}
															</div>
														</td>
														<td>
															<div>
																{{produto.vlrLiquido | currency:'R$'}}
															</div>
														</td>
														<td>
															<div>
																{{produto.pesoKG}}
															</div>
														</td>
														<td>
															<div>
																{{produto.volumeM3}}
															</div>
														</td>
														<td>
															<div>
																{{produto.qtdEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.qtdSubEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descrSubEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.dataPCP}}
															</div>
														</td>
														<td>
															<div>
																{{produto.dataETD}}
															</div>
														</td>
														<td>
															<div>
																{{produto.acresPreco}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descontoFin}}
															</div>
														</td>
														<td>
															<div>
																{{produto.vlrDesconto}}
															</div>
														</td>
														<td>
															<div>
																{{produto.vlrBruto}}
															</div>
														</td>
														<td>
															<div>
																{{produto.codPro}}
															</div>
														</td>
														<td>
															<div>
																{{produto.derivacao}}
															</div>
														</td>
														<td>
															<div>
																{{produto.um}}
															</div>
														</td>
														<td>
															<div>
																{{produto.previsaoCli}}
															</div>
														</td>
														<td>
															<div>
																{{produto.emb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.subEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descrProduto}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descrDeriv}}
															</div>
														</td>
														<td>
															<div>
																{{produto.nrPedido}}
															</div>
														</td>
														<td>
															<div>
																{{produto.seqPed}}
															</div>
														</td>
													</tr>
												</tbody>
											</table>
										</div>
									</pre>
								</div>
							</div>
								<div style="margin-top:-25px" ng-show="sincronizado != 'DOCUMENTO_SINCRONIZADO' "
									class="form-group col-md-12">
									<div class="col-sm-6 spacer ">
										<label for="tipoOrcamento">Tipo de orçamento</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="tipoOrcamento" 
											readonly>
									</div>
									<div class="col-sm-6 spacer ">
										<label for="filial">Filial</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="filial" 
											readonly>
									</div>
									<div class="col-sm-6 spacer ">
										<label for="cliente">Cliente</label>
										<div class="input-button">
											<input 
												required id="frmCliente" 
												autocomplete="off" 
												type="text"
												class="form-control" 
												ng-model="frmCliente"
												uib-typeahead="teste.nome for teste in getClientesERP($viewValue)"
												typeahead-on-select="onSelectCli($item, $model, $label)"
												typeahead-min-lenght="0">
											<span 
												class="input-group-addon" 
												style="cursor: pointer;" 
												ng-click="limpaCliente()">
												<i class="glyphicon glyphicon-remove"></i>
											</span>
										</div>
									</div>
									<div class="col-sm-6 spacer ">
										<label for="tabPreco">Tabela de preço</label>
										<div class="input-button">
											<input 
												id="frmTabelaPreco" 
												autocomplete="off" 
												type="text" 
												class="form-control"
												ng-model="tabPreco"
												uib-typeahead="teste.nome for teste in getTabelaPreco($viewValue)"
												typeahead-min-lenght="0"
												ng-disabled="codigoCliente == undefined || codigoCliente == ''">
											<span 
												class="input-group-addon" 
												style="cursor: pointer;"
												ng-click="limpaTabPreco()">
												<i class="glyphicon glyphicon-remove"></i>
											</span>
										</div>
									</div>
									<div class="col-sm-4 spacer ">
										<label for="frete">Tipo de frete</label>
										<div class="input-button">
											<input 
												required 
												id="frmFrete" 
												autocomplete="off" 
												type="text"
												class="form-control" 
												ng-model="frete"
												uib-typeahead="teste.tipo + ' - ' + teste.desc for teste in getTipoFrete($viewValue)"
												typeahead-min-lenght="0"
												typeahead-on-select="inputsControlFrete($item, $model, $label)">
											<span 
												class="input-group-addon" 
												style="cursor: pointer;"
												ng-click="limpaTipoFrete()">
												<i class="glyphicon glyphicon-remove"></i>
											</span>
										</div>
									</div>
									<div class="col-sm-4 spacer ">
										<label for="tabelaFrete">Tabela de frete</label>
										<div class="input-button">
											<input 
												ng-required="requiredTabFrete" 
												id="tabTabelaFrete" 
												autocomplete="off"
												type="text" 
												class="form-control" 
												ng-model="tabelaFrete"
												ng-disabled="!habilitado"
												uib-typeahead="frete.nom for frete in getTabelaFrete($viewValue)"
												typeahead-on-select="onSelectTabFrete($item, $model, $label)"
												typeahead-min-lenght="0">
											<span 
												class="input-group-addon" 
												style="cursor: pointer;"
												ng-click="limpaTabelaFrete()">
												<i class="glyphicon glyphicon-remove"></i>
											</span>
										</div>
									</div>
									<div class="col-sm-4 spacer ">
										<label for="totalFrete">Total de frete</label>
										<input 
											type="text"
											class="form-control" 
											ng-model="totalFrete" 
											readonly>
									</div>
									<div class="col-sm-4 spacer ">
										<label for="emissaoOrcamento">Emissão do orçamento</label>
										<input 
											type="date" 
											class="form-control" 
											ng-model="emissaoOrcamento" 
											min="2022-01-01"
											readonly>
									</div>
									<div class="col-sm-4 spacer ">
										<label for="validadeOrcamento">Validade do orçamento</label>
										<input 
											type="date" 
											class="form-control" 
											ng-model="validadeOrcamento"
											min="2022-01-01">
									</div>
									<div class="col-sm-4 spacer ">
										<label for="prevEntregCli">Previsão de entrega do cliente</label>
										<input 
											type="date" 
											class="form-control" 
											ng-model="prevEntregCli"
											min="2022-01-01">
									</div>
									<div class="col-sm-6 spacer ">
										<label for="situacao">Situação</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="situacao" 
											readonly>
									</div>
									<div class="col-sm-6 spacer ">
										<label for="usuarioDigitacao">Usuario de digitação</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="usuarioDigitacao" 
											readonly>
									</div>
									<div class="col-sm-6 spacer ">
										<label for="representante">Representante</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="representante"
											readonly>
									</div>
									<div class="col-sm-6 spacer ">
										<label for="condPagamento">Condição de pagamento</label>
										<input 
											type="text" 
											required 
											class="form-control" 
											ng-model="condPagamento" 
											required
											uib-typeahead="teste.nome for teste in getCondicaoPagamentoERP($viewValue)"
											typeahead-min-lenght="2">
									</div>
									<div class="col-sm-6 spacer ">
										<label for="formaPagamento">Forma de pagamento</label>
										<input 
											type="text" 
											required 
											class="form-control" 
											ng-model="formaPagamento" 
											required
											uib-typeahead="teste.codExterno + ' - ' + teste.nome for teste in getFormasPagamentoERP($viewValue)"
											typeahead-min-lenght="3">
									</div>
									<div class="col-sm-6 spacer ">
										<label for="numPedClienteOCPO">Numero pedido do cliente (OC/PO)</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="numPedClienteOCPO">
									</div>
									<div class="col-sm-6 spacer ">
										<label for="observação">Observação</label>
										<textarea 
											class="form-control spacer-input ng-pristine ng-valid ng-empty ng-touched"
											ng-model="observacao" 
											rows="1">
										</textarea>
									</div>
									<div class="col-sm-12 spacer ">
										<button class="btn btn_grid btn_cor_padrao" ng-click="getInfoTabela()" required>
											Carregar Produtos </button>
									</div>
									<div class="col-sm-6 spacer ">
										<label for="searchtxt.descrProCli">Filtrar por descrição</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="searchtxt.descrProCli">
									</div>

									<div class="col-sm-6 spacer ">
										<label for="searchtxt.codProCli">Filtrar por codigo de produto</label>
										<input 
											type="text" 
											class="form-control" 
											ng-model="searchtxt.codProCli">
									</div>
									<!--Tabela onde mostra os produtos para orçamento-->
									<div style="margin-top:5px" class="form-group col-md-12">
										<div style="padding:0;" class="col-xl-12 spacer">
											<!--Pre para barra de rolagem inferior -->
											<pre>
											<div class="scroll-div">
											<table id ="tabelaProdutos" class="table-bordered">
												<thead>
													<tr>
														<th>OC/PO                 </th>
														<th>it.OC/PO              </th>
														<th>Cod.Prod.Cliente      </th>
														<th>Descr.Produto.Cliente </th>
														<th>Preço Venda(FOB)      </th>
														<th>Preço do Frete        </th>
														<th>Preço da venda(CIF)   </th>
														<th>QTD.Pedida            </th>
														<th>%Oferta Preço         </th>
														<th>Preço Liquido         </th>
														<th>Vlr.Liquido           </th>
														<th>Peso(KG)              </th>
														<th>Volume(M3)            </th>
														<th>Qtd Emb               </th>
														<th>Desc Emb              </th>
														<th>Qtd.Sub.Emb           </th>
														<th>Descr.Sub Emb         </th>
														<th>Data(PCP)             </th>
														<th>Data(ETD)             </th>
														<th>%Acres.Preço          </th>
														<th>%Desconto Fin         </th>
														<th>Vlr. Desconto         </th>
														<th>Vlr. Bruto            </th>
														<th>Cod.Pro               </th>
														<th>Deriv                 </th>
														<th>UM                    </th>
														<th>Previsao do cliente   </th>
														<th>Emb					  </th>
														<th>Sub Emb				  </th>
														<th>Descr. Produto		  </th>
														<th>Descr. Deriv          </th>
														<th>Nr. Pedido			  </th>
														<th>Seq. Ped			  </th>
													</tr>
												</thead>
												<tbody>
													<tr ng-repeat = "produto in produtos | filter : searchtxt">
														<td>
															<div>
																{{produto.ocpo}}
															</div>
														</td>
														<td>
															<div>
																{{produto.itocpo}}
															</div>
														</td>
														<td>
															
															{{produto.codProCli}}
															
														</td>
														<td>
															
															{{produto.descrProCli}}
															
														</td>
														<td>
															<div>
															{{produto.precoVendFOB}}
															</div>
														</td>
														<td>
															<div>
																{{produto.precoFrete}}
															</div>
														</td>
														<td>
															<div>
																{{produto.precoVendaCIF}}
															</div>
														</td>
														<td>
															<div>
																<input
																min="0"
																value="0"
																ng-change="calcularProdutos()"
																type="number"
																class="inputNumberTable"
																ng-model="produto.qtdPedida"
																typeahead-min-lenght = "1">
															</div>
														</td>
														<td>
															<div>
																<input
																min="0"
																value="0"
																ng-change="calcularProdutos()"
																type="number"
																class="inputNumberTable"
																ng-model="produto.ofertaPreco"
																typeahead-min-lenght = "1">
															</div>
														</td>
														<td>
															<div>
																{{produto.precoLiquido}}
															</div>
														</td>
														<td>
															<div>
																{{produto.vlrLiquido | currency:'R$'}}
															</div>
														</td>
														<td>
															<div>
																{{produto.pesoKG}}
															</div>
														</td>
														<td>
															<div>
																{{produto.volumeM3}}
															</div>
														</td>
														<td>
															<div>
																{{produto.qtdEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.qtdSubEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descrSubEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.dataPCP}}
															</div>
														</td>
														<td>
															<div>
																{{produto.dataETD}}
															</div>
														</td>
														<td>
															<div>
																{{produto.acresPreco}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descontoFin}}
															</div>
														</td>
														<td>
															<div>
																{{produto.vlrDesconto}}
															</div>
														</td>
														<td>
															<div>
																{{produto.vlrBruto}}
															</div>
														</td>
														<td>
															<div>
																{{produto.codPro}}
															</div>
														</td>
														<td>
															<div>
																{{produto.derivacao}}
															</div>
														</td>
														<td>
															<div>
																{{produto.um}}
															</div>
														</td>
														<td>
															<div>
																{{produto.previsaoCli}}
															</div>
														</td>
														<td>
															<div>
																{{produto.emb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.subEmb}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descrProduto}}
															</div>
														</td>
														<td>
															<div>
																{{produto.descrDeriv}}
															</div>
														</td>
														<td>
															<div>
																{{produto.nrPedido}}
															</div>
														</td>
														<td>
															<div>
																{{produto.seqPed}}
															</div>
														</td>
													</tr>
												</tbody>
											</table>
										</div>
									</pre>
										<table>
											<thead>
												<tr>
													<th>
														Valor total:
													</th>
													<th>
														Quantidade:
													</th>
													<th>
														Peso:
													</th>
													<th>
														Volume:
													</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td>
														{{valorPrecoTotal | currency:'R$ '}}
													</td>
													<td>
														{{valorQuantidadeTotal}}
													</td>
													<td>
														{{valorPesoTotal}}
													</td>
													<td>
														{{valorVolumeTotal}}
													</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
								</div>
							</div>
						</form>
					</div>
				<hr class="divider">
				<div ng-show="exibeHistoricos" class="col-sm-12">
					<div class="form-row">
						<div class="col-sm-12 spacer">
							<label for="histOportunidade">Histórico</label>
							<textarea readonly class="form-control spacer-input"
								ng-disabled="inputDesabilitado" ng-model="histOportunidade"
								id="histOportunidade" rows="10"></textarea>
						</div>
					</div>
					<div class="form-row">
						<div class="col-sm-12 spacer">
							<hr class="divider">
						</div>
					</div>
					<div class="form-row">
						<div class="col-sm-11 spacer">
							<label for="obsOportunidade">Observação</label>
							<textarea class="form-control spacer-input" ng-model="obsOportunidade"
								id="obsOportunidade" rows="3"></textarea>
						</div>
						<div class="col-sm-1 spacer" style="padding-top: 30px;">
							<label for="obsOportunidade"> </label>
							<div class="btn-group">
								<button class="btn btn_grid btn_cor_padrao"
									ng-disabled="obsOportunidade=='' || obsOportunidade==undefined || isLoading"
									ng-click="addObservacaoHistorico()"> Incluir </button>
							</div>
						</div>
					</div>
				</div>
				<!-- Ações sob o formulario -->
				<div class="row spacer">
					<div class="pull-right" style="padding-right: 35px; margin-top:10px">
						<div class="btn-group">
							<button 
								class = "btn" 
								ng-disabled="produtos.length == 0 || cadastroPedido.$error.required || isLoading "
								ng-click="imprimeOrcamento()"
								ng-show="idDocumento > 0">
								Imprimir Orçamento
							</button>
						</div>
						<div class="btn-group">
							<button 
								class="btn btn_grid btn-success" 
								title="O pedido será finalizado e enviado ao ERP"
								ng-disabled="produtos.length == 0 || cadastroPedido.$error.required || isLoading"
								ng-show="pedido == 0" 
								ng-click="finalizarDocumento()"> 
								Finalizar 
							</button>
						</div>
						<div class="btn-group">
							<button 
								class="btn" 
								ng-click="changeView()"> 
								Cancelar 
							</button>
						</div>
						<div class="btn-group">
							<button 
								class="btn btn_grid btn_cor_padrao"
								title="O pedido será salvo. Voce ainda poderá editar e finalizar o pedido."
								ng-disabled="cadastroPedido.$error.required || isLoading "
								ng-show="pedido == 0" 
								ng-click="salvarDocumento(1)">
								Salvar
							</button>
							<!--"produtos.length == 0-->
						</div>
					</div>
				</div>
				<!-- Açõees sob o formulario -->
				<hr class="divider">
			</div>
			<!-- Capa do pedido -->
		</div>
	</div>
	<script type="text/ng-template" id="templateAutoCompleteProduto">
		<a>
			<table>
				<tr>
					<td style="padding-right: 25px;">
						<div ng-show="match.model.codVariacao == ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src="/clicvenda/produtos/{{$parent.$parent.$parent.subdomain}}/{{match.model.codExterno}}.jpg" onerror='this.src="images/icon/semimagem.png"' style='width: 64px;'/></div>
						<div ng-show="match.model.codVariacao != ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src="/clicvenda/produtos/{{$parent.$parent.$parent.subdomain}}/{{match.model.codExterno}}_{{match.model.codVariacao}}.jpg" onerror='this.src="images/icon/semimagem.png"' style='width: 64px;'/></div>
					</td>			
					<td>
						<div class="row">
							<div class="col-md-12">{{match.model.codExterno}} <b>|</b> {{match.model.nome}} <b>-</b> {{match.model.codVariacao}}</div>				
						</div>
						<div class="row">
							<div class="col-md-12">Estoque: {{match.model.qtdeEstoque}}</div>				
						</div>				
						<div class="row">
							<div class="col-md-12">Preço: {{match.model.preco}}</div>				
						</div>
						<div class="row">
							<div class="col-md-12">Tab. Preço: {{match.model.codTpr}}</div>				
						</div>												
					</td>
				</tr>
			</table>
		</a>
	 </script>
	<!-- View -->
	<!-- Scripts importados -->
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/jquery-3.1.1.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/easytimer.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-route.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-ui-router.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-cookies.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angular-ui-notification/angular-ui-notification.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/ui-bootstrap-tpls-2.5.0.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/dist/jquery.dataTables.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/dist/angular-datatables.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/bootstrap.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.bootstrap.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.factory.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.options.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/dataTables.buttons.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.colVis.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.flash.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.html5.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.print.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.buttons.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-locale_pt-br.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-sanitize.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/fullcalendar-3.10.0/lib/moment.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/ui-mask-master/dist/mask.min.js"></script>
	<!-- Scripts importados -->
	<script>
		var dadosUserLogado = parent.dadosUserLogadoPersonalizado();
		angular
			.module("appV2", ['ngRoute', 'ngSanitize', 'ui.bootstrap', 'datatables', 'datatables.buttons', 'ui.mask'])
			.controller("MainController",
				function (DTOptionsBuilder, DTColumnDefBuilder, DTColumnBuilder, DTDefaultOptions, $scope, $rootScope, $compile, $http, $timeout, $window) {

					$scope.exibeFormulario = false;
					$scope.exibeListaDocumentos = true;
					$scope.exibeHistoricos = false;
					$rootScope.isLoading = false;
					$rootScope.subdomain = dadosUserLogado.cSubdominio;

					/* Inicializa filtros */
					$scope.filCliente = "";
					$scope.filRepresentante = "";
					$scope.filDataEmissao = "";
					$scope.filPesquisaGeral = "";
					$scope.filSincronizado = { nome: "", send: "" };

					/*Incializa produtos*/
					$rootScope.produtos = [];

					/*Incializa cliente*/
					$rootScope.cliente = {};

					$scope.consultaDocumento = async (hash) => {
						/*Consulta na base ClicVenda - pedidov2*/
						$rootScope.listAllDocs = [];

						let result = await $http({
							method: 'POST',
							url: '/clicVendas/rest/pedidov2/consulta',
							data: { param: { idCvTccnpj: dadosUserLogado.cId, id: hash } }
						});

						let listAllDocs = result.data.parametros.documentos;

						for (doc of listAllDocs) {
							doc.jsonDocs = JSON.parse(doc.jsonDocs);
						}
						$rootScope.listAllDocs = listAllDocs;

						return listAllDocs;
					};

					$rootScope.changeView = ($dados) => {
						$scope.pedidoInfos = $dados

						if ($scope.exibeFormulario == false) {

							$scope.exibeFormulario = true;
							$scope.exibeListaDocumentos = false;

							if ($dados == undefined) {
								$scope.tipoFormulario = 'Novo';

								$scope.inputDesabilitado = false;
								$scope.permiteEditar = true;

								$scope.$apply();

							} else {
								$scope.tipoFormulario = $dados.jsonDocs[0].sincronizado === 'DOCUMENTO_SINCRONIZADO' ? 'Pedido ERP Nº ' + $dados.jsonDocs[0].pedido : "Pedido Nº " + $dados.id
								$scope.inputDesabilitado = true;
								$scope.permiteEditar = false;
							};

						} else if ($scope.exibeFormulario == true && !$scope.exibeHistoricos) {
							$scope.exibeFormulario = false;
							$scope.exibeListaDocumentos = true;
							$scope.atualizaTabela();

						} else if ($scope.exibeFormulario == true && $scope.exibeHistoricos) {
							$scope.exibeHistoricos = false;
						}
					};

					$scope.abreHistoricos = (acao) => {
						$scope.exibeHistoricos = true;
					};

					//requisicao para tipo de frete
					$scope.getTipoFrete = async (consulta) => {

						try {

							let result = await $scope.executaRequisicaoExterna(

								{
									idCvtccnpj: dadosUserLogado.cId,
									numreg: 750,
									pRotina: 'getTipoFrete',
									pCodCli: dadosUserLogado.rId,
									pFilter: { filtro: { filtrotipFrete: consulta } }
								},

							);

							if (result != undefined && result.resultado != undefined) {

								return result.resultado.map((item) => {

									return item

								})

							} else {

								return []

							}

						} catch (err) {

							console.log("ocorreu em erro na requisição ", err);

						};

					}

					//lista
					$scope.onSelectTipoFrete = function ($item, $model, $label) {

						$scope.frete = $item;

					};
					//limpa campo
					$scope.limpaTipoFrete = function ($item, $model, $label) {

						$scope.frete = ""

						$scope.tabelaFrete = ""

						$scope.totalFrete = ""

						//desabilita o campo de tabela de frete
						$scope.habilitado = false

						//volta o foco para o input
						var tabTipoFrete = angular.element(document.querySelector('#tabTipoFrete'));

						$timeout(function () {

							tabTipoFrete.focus();

						},

						 200);

					};

					//requisicao para tabela de frete
					$scope.getTabelaFrete = async (consulta) => {

						try {

							let result = await $scope.executaRequisicaoExterna(

								{
									idCvtccnpj: dadosUserLogado.cId,
									numreg: 750,
									pRotina: 'getTabelaFrete',
									pCodCli: dadosUserLogado.rId,
									pFilter: { filtro: { filtroTabelaFrete: consulta } }
								},

							);

							if (result != undefined && result.resultado != undefined) {

								return result.resultado.map((item) => {

									$scope.precoFrete = result.resultado.valor

									return item
								})

							} else {

								return []

							}
						} catch (err) {

							console.log("ocorreu em erro na requisição ", err);

						};
					}

					//limpa o campo
					$scope.limpaTabelaFrete = function ($item, $model, $label) {

						$scope.tabelaFrete = ""

						//volta o foco para o input
						var tabFrete = angular.element(document.querySelector('#tabTabelaFrete'));

						$timeout(function () {

							tabFrete.focus();

						}, 

						200);

					};

					$scope.onSelectTabFrete = ($item, $model, $label) => {

						$scope.totalFrete = $item.valor

					}

					//controla inputs com base no tipo de frete
					$scope.inputsControlFrete = function ($item, $model, $label) {

						switch ($item.desc) {

							case 'Sem Frete':
								$scope.habilitado = false
								$scope.tabelaFrete = ''
								$scope.totalFrete = '';
								break;

							case 'CIF':
								$scope.habilitado = true
								break;

							case 'FOB':
								$scope.habilitado = false
								$scope.tabelaFrete = ''
								$scope.totalFrete = '';
								break;

							default:
								console.log("Não atendeu nenhuma das alternativas")
						}

					}

					$scope.imprimeOrcamento = async($item) => {

						let dados  = $item != undefined ? $item : $scope.pedidoInfos
						console.log(dados)
						let dialog = bootbox.dialog({

							message: '<div class="alert alert-light popup"role="alert"><p style="font-size:1.0em; font-weight:bold; text-align:center;">Gerando relátorio...</p></div>',
							
							closeButton: false
						});

						try {

							let result = await $scope.executaRequisicaoExterna(

								{
									idCvtccnpj: dadosUserLogado.cId,
									numreg: 750,
									pRotina: 'imprimeRelatorio',
									pCodCli: dadosUserLogado.rId,
									pFilter: { filtro: {dados} },
								},

							);

							dialog.modal('hide');
							$scope.exibeOrcamento(result);

						} catch (err){

							console.log("ocorreu um erro na requisição ", err);
							
						};
					}

					$scope.exibeOrcamento = ($item) => {

						let pdfWindow = window.open("")

						pdfWindow.document.write(
							"<title>Relatório</title>"+
							"<iframe width='100%' height='100%' src='data:application/pdf;base64, " +
							encodeURI($item) + "'></iframe>"
						)
					}

					// requisicao para tabela de preco
					$scope.getTabelaPreco = async (consulta, opcao) => {

						let codCli = $scope.codigoCliente

						let tabPreco = $scope.tabPreco

						try {

							let result = await $scope.executaRequisicaoExterna(
								{
									idCvtccnpj: dadosUserLogado.cId,
									numreg: 750,
									pRotina: 'filtrarTabelaPreco',
									pCodCli: dadosUserLogado.rId,
									pFilter: { filtro: { filtroTabPreco: tabPreco, filtroCli: codCli } },
								},

							);

							if (result != undefined && result.resultado != undefined) {

								if (opcao && opcao != undefined) {

									$scope.tabPreco = result.resultado[0]

								} else {

									return result.resultado.map((item) => {
										return item
									})
								}

							} else {

								return []

							}

						} catch (err) {

							console.log("ocorreu um erro na requisição ", err);
						};
					}
					//lista
					$scope.onSelectTabPreco = function ($item, $model, $label) {
						$scope.tabPreco = $item;
					};
					//limpa o campo
					$scope.limpaTabPreco = function () {
						$scope.tabPreco = "";
						//volta o foco para input
						var tabPrecLIMPA = angular.element(document.querySelector('#frmTabelaPreco'));
						$timeout(function () {
							tabPrecLIMPA.focus();
						}, 200);
					}

					// faz o calculo na tabela de produtos para calculo de peso/volume/valorLiquido
					$scope.calcularProdutos = () => {

						let volumeM3 = 0;
						let peso = 0
						let vlrLiquido = 0

						// valores totais para mostrar na tabela inferior
						// valor total 
						let valorCalculoPrecoTotal = 0
						// peso total
						let valorCalculoPesoTotal = 0
						// volume
						let valorCalculoVolumeTotal = 0
						// quantidade 
						let valorCalculoQuantidadeTotal = 0
						// oferta de preco
						
						//loop para percorrer os produtos na tabela
						for (let i = 0; i < $rootScope.produtos.length; i++) {

							$rootScope.produtos[i].emb = 0
							
							//quantidade
							let qtd = parseFloat($rootScope.produtos[i].qtdPedida)

							//oferta de preco
							let valorOfertaPreco = parseFloat($rootScope.produtos[i].ofertaPreco)

							if (isNaN(valorOfertaPreco)){
								
								valorOfertaPreco = 0
								
							}

							//valor do BD
							let qtdm3 = parseFloat($rootScope.produtos[i].qtdm3.replace(',', '.'))

							//preco liquido de produto
							let precoLiquido = parseFloat($rootScope.produtos[i].precoLiquido.replace(',', '.'))
							//console.log("preço liquido: ",precoLiquido)

							let testeConta = parseFloat($rootScope.produtos[i].precoLiquido.replace(',', '.'))
							//testeConta = testeConta - (testeConta * (25 / 100));
							//console.log("teste de conta: ",testeConta)

							if ((qtd != null && qtd > 0) && $rootScope.produtos[i].qtdm3 != null) {


								precoLiquido = precoLiquido - (precoLiquido * (valorOfertaPreco/100))
								precoLiquido = precoLiquido.toFixed(3)
								//console.log(precoLiquido)

								vlrLiquido = qtd * precoLiquido
								 
								//console.log(vlrLiquido)
								// vlrLiquido = precoLiquido * qtd 

								$rootScope.produtos[i].vlrLiquido = vlrLiquido;

								// calculando volume
								volumeM3 = qtd * qtdm3;
								$rootScope.produtos[i].volumeM3 = volumeM3.toFixed('3');

								//calculando peso 
								peso = volumeM3 * 790
								$rootScope.produtos[i].pesoKG = peso.toFixed('3');

								valorCalculoPrecoTotal += vlrLiquido;
								valorCalculoVolumeTotal += volumeM3;
								valorCalculoPesoTotal += peso;
								valorCalculoQuantidadeTotal += qtd;
								
							}
						}

						//atribui os valores tratados
						$scope.valorPrecoTotal 		= valorCalculoPrecoTotal 
						$scope.valorPesoTotal 		= valorCalculoPesoTotal.toFixed('3');
						$scope.valorVolumeTotal 	= valorCalculoVolumeTotal.toFixed('3');
						$scope.valorQuantidadeTotal = valorCalculoQuantidadeTotal.toFixed('0');

					}

					//carrega os produtos na tabela
					$scope.getInfoTabela = async () => {

						let codCli = $scope.codigoCliente
						let tabPreco = $scope.codTpr

						let result = await $scope.executaRequisicaoExterna(
							{
								idCvtccnpj: dadosUserLogado.cId,
								numreg: 750,
								pRotina: 'filtrarInfoTabela',
								pCodCli: dadosUserLogado.rId,
								pFilter: { filtro: { filtroTab: tabPreco, filtroCli: codCli } }
							},
						);

						let newResult = result.resultado

						for (let i = 0; i < newResult.length; i++) {

							$scope.adicionarProduto(newResult[i])
							$scope.qtdm3 = newResult[i].qtdm3
							$scope.emb = newResult[i].emb
							$scope.emb = 0

						}
					}

					//requisicao para condicao de pagamento
					$scope.getCondicaoPagamentoERP = async (consulta) => {

						try {

							let result = await $scope.executaRequisicaoExterna(

								{
									idCvtccnpj: dadosUserLogado.cId,
									numreg: 750,
									pRotina: 'filtrarCondPagamento',
									pCodCli: dadosUserLogado.rId,
									pFilter: { filtro: { filtroCondPag: consulta } },
								}
							);

							if (result.resultado != undefined) {

								return result.resultado.map((item) => {

									return item

								})

							} else {

								return [];
							}
						} catch (err) {
							console.log("Ocorreu um erro na requisição: ", err);
						};
					}

					$scope.onSelectCond = function ($item, $model, $label) {
						$scope.condPagamento = $item;
					};

					$scope.limpaCondicaoPagamento = function () {
						$scope.condPagamento = "";
					}

					//requisicao para forma de pagamento
					$scope.getFormasPagamentoERP = async (consulta) => {
						try {
							let result = await $scope.executaRequisicaoExterna(
								{
									idCvtccnpj: dadosUserLogado.cId,
									numreg: 750,
									pRotina: 'filtrarFormPagamento',
									pCodCli: dadosUserLogado.rId,
									pFilter: { filtro: { filtroFormaPag: consulta } },
								}
							);

							if (result != undefined && result.resultado != undefined) {
								if (opcao && opcao != undefined) {
									$scope.formaPagamento = result.resultado[0]
								} else {
									return result.resultado.map((item) => {
										return item
									})
								}
							} else {
								return [];
							}
						} catch (err) {
							console.log("Ocorreu um erro na requisição: ", err);
						};
					}

					$scope.onSelectForma = function ($item, $model, $label) {
						$scope.formaPagamento = $item;
					};

					$scope.limpaFormaPagamento = function () {
						$scope.formaPagamento = "";
					}

					//requisicao para busca de clientes
					$scope.getClientesERP = async (consulta) => {
						try {
							let result = await $scope.executaRequisicaoExterna(
								{
									idCvtccnpj: dadosUserLogado.cId,
									numreg: 750,
									pRotina: 'filtrarCliente',
									pCodCli: dadosUserLogado.rId,
									pCodRep: dadosUserLogado.rCod,
									pFilter: { filtro: { filtroCliente: consulta } },
								},
							);
							if (result != undefined && result.resultado != undefined) {
								return result.resultado.map((item) => {
									return item
								})
							} else {
								return [];
							}
						} catch (err) {
							console.log("Ocorreu um erro na requisição: ", err);
						};
					}

					//funcao para atribuir valores vindo da requisição de clientes 
					$scope.onSelectCli = ($item, $model, $label) => {
						$rootScope.cliente = $item;
						$scope.codTpr = $item.codTpr
						$scope.codigoCliente = $rootScope.cliente.codExterno

						//atribui o representante
						$scope.representante = $scope.cliente.nomRep 
						//atribiu tabela de preco
						$scope.tabPreco = { nome: $scope.cliente.desTpr }
						//atribui forma de pagamento
						$scope.formaPagamento = { codExterno: $scope.cliente.codFpg, nome: $scope.cliente.desFpg }
						//atribui condicao de pagamento
						$scope.condPagamento = { codExterno: $scope.cliente.codCpg, nome: $scope.cliente.desCpg }

						//validacao de valores vindos
						if ($item.codFpg == "0") {
							$scope.formaPagamento = ""
						}
						if ($item.codTpr == " ") {
							$scope.tabPreco = ""
						}
					};

					//limpa campo
					$scope.limpaCliente = () => {
						$scope.frmCliente = '';
						$scope.codigoCliente = '';
						$scope.tabPreco = '';

						//volta o foco
						var cCliente = angular.element(document.querySelector('#frmCliente'));
						$timeout(function () {
							cCliente.focus();
						}, 200);
					};

					$scope.getFilScinronizacao = () => {
						$scope.listaFilSincronizacao = [
							{
								nome: 'Não sincronizados',
								send: "DOCUMENTO_NAO_SINCRONIZADO"
							},
							{
								nome: 'Sincronizados',
								send: "DOCUMENTO_SINCRONIZADO"
							},
							{
								nome: 'Falha na sincronização',
								send: 'ERRO: '
							},
						];
						return $scope.listaFilSincronizacao;
					};

					$scope.onSelectFilSincronizacao = ($item, $model, $label) => {
						$scope.filSincronizado = $item;
					};

					/*Tempo limite para funções*/
					const setAsyncTimeout = (cb, timeout = 0) => new Promise((resolve, reject) => {
						cb(resolve);
						setTimeout(() => reject('A requisição demorou muito para responder, por favor tente novamente mais tarde.'), timeout);
					});

					$scope.executaRequisicaoExterna = async ($json, timeLimit = 15) => {
						try {
							let response;
							await setAsyncTimeout(async done => {
								response = await $http.post(dadosUserLogado.cContextIntegracao + '/rest/Listas/executarRequisicaoExterna', $json);
								done();/*Aguarda a requisição - Se estourar o tempo, gera erro.*/
							}, timeLimit * 1000); // limite em segundos
							return response.data;
						} catch (err) {
							$scope.geraNotificacao("Não foi possível se comunicar com o ERP. " + err + "", 5000, 'danger')
							console.error('[Timeout] Não foi possível se comunicar com o ERP.', err);
						};
					};

					$scope.consultaPedidosERP = async () => {
						// FILTRO PARA QTD DE PRODUTOS
						let pedidosGravadosERP = $rootScope.dadosGrid.filter(doc => doc && Number(doc.jsonDocs[0].pedido) > 0);
						let consulta = [];
						/*Ira consultar com base apenas no numero do pedido*/
						for (i = 0; i < pedidosGravadosERP.length; i++) {
							consulta.push(
								{
									numPed: pedidosGravadosERP[i].jsonDocs[0].pedido
								}
							)
						};

						let dialog = bootbox.dialog({
							message: '<div class="alert alert-light popup"role="alert"><p style="font-size:1.0em; font-weight:bold; text-align:center;">Sincronizando com o ERP...</p></div>',
							closeButton: false
						});
						$rootScope.isLoading = true;

						let result = await $scope.executaRequisicaoExterna(
							{
								idCvtccnpj: dadosUserLogado.cId,
								numreg: 752,
								pRotina: 'listarPedidosAmostras',
								pCodCli: dadosUserLogado.rId,
								pListaPedido: { lista: { pedidos: consulta } },
							},
							15//limite de espera em segundos
						);

						dialog.modal('hide');
						$rootScope.isLoading = false;

						if (result != "" && !isNaN(parseInt(result))) {
							for (k = 0; k < pedidosGravadosERP.length; k++) {

								let dadosAtualizados = result.resultado.filter(res => res.numped == pedidosGravadosERP[k].jsonDocs[0].pedido);

								if (dadosAtualizados && dadosAtualizados.length > 0) {
									for (l = 0; l < $rootScope.dadosGrid.length; l++) {
										/*Verifica -
											Codigo externo - Codigo variacao - Numero pedido ERP*/
										if ($rootScope.dadosGrid[l].jsonDocs[0].pedido == pedidosGravadosERP[k].jsonDocs[0].pedido) {

											/*Itens que serão atualizados*/
											/*Atualiza informações do produto vinculado ao pedido*/
											//pedidosGravadosERP[k].jsonDocs[0].produtos.		= "5"

											continue;
										};
									};
								};
							};
						}

						$scope.atualizaTabela(1);/* 1 - Atualiza apenas a view, não busca da base de dados */
					};

					$scope.gravaDocumentoERP = async ($item) => {


						let dialog = bootbox.dialog({
							message: '<div class="alert alert-light popup"role="alert"><p style="font-size:1.0em; font-weight:bold; text-align:center;">Enviando pedido para o ERP...</p></div>',
							closeButton: false
						});

						$rootScope.isLoading = true;

						let result = await $scope.executaRequisicaoExterna(
							{
								idCvtccnpj: dadosUserLogado.cId,
								numreg: 750,
								pRotina: 'criarPedidoNovo',
								pCodCli: dadosUserLogado.rId,
								pDocumento: $item
							},
							20//limite tempo
						);

						$rootScope.isLoading = false;

						if (!isNaN(parseInt(result))) {
							dialog.modal('hide');
							$scope.geraNotificacao('O pedido ' + result + ' foi gravado com sucesso no ERP.', 2000, 'success')
						} else {
							let formatText = result != undefined ? result.replace(/[\\"]/g, '').replace(/[''"]/g, "") : " Ocorreu uma falha de comunicação com o ERP. Por favor, tente novamente mais tarde."
							result = formatText
							dialog.modal('hide');
							$scope.geraNotificacao('Houve uma falha na gravação do pedido.', 2000, 'danger');
						};

						return result
					};


					$scope.abreFormulario = ($dados) => {
						//data do dia / data de emissao 
						var today = new Date();
						var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();

						//data fotura +30 dias data de vencimento
						var future = new Date();
						future.setDate(future.getDate() + 30)

						var validadeOrcamento = future.getFullYear() + '-' + (future.getMonth() + 1) + '-' + future.getDate();

						$scope.habilitarFrete = false

						if ($dados == undefined) {
							//para um novo pedido
							$rootScope.idDocumento 		= 0;
							$scope.pedido 				= 0,
							$rootScope.produtos 		= [];
							// inputs
							$scope.codTpr 				= '';
							$scope.representante 		= '';
							$scope.qtdm3 				= '';
							$scope.tabPreco 			= '';
							$scope.frmCliente 			= '';
							$scope.totalFrete 			= '';
							$scope.tabelaFrete 			= '';
							$scope.prevEntregCli 		= '';
							$scope.prevEntregPcp 		= '';
							$scope.usuarioDigitacao 	= '';
							$scope.condPagamento 		= '';
							$scope.formaPagamento 		= '';
							$scope.observacao 			= '';
							$scope.numPedClienteOCPO 	= '';
							$scope.frmCliente 			= '';
							$scope.codigoCliente 		= '';
							$scope.codigoProduto 		= '';
							// codigos padroes da tela malinski
							$scope.emissaoOrcamento 	= new Date(date)
							$scope.validadeOrcamento 	= new Date(validadeOrcamento);
							$scope.habilitado 			= false
							$scope.ofertaPreco 			= 0; 
							$scope.valorPrecoTotal 		= 0;
							$scope.valorPesoTotal		= 0;
							$scope.valorVolumeTotal 	= 0;
							$scope.valorQuantidadeTotal = 0;
							//produtos
							$scope.frete 				= 'X-Sem Frete';
							$scope.situacao 			= 'Em digitação';
							$scope.tipoOrcamento 		= 'Normal';
							$scope.filial 				= "Filial 8"
							$scope.usuarioDigitacao		= dadosUserLogado.rNome;
							$scope.obsOportunidade		= '';
							$scope.histOportunidade 	= '';
							$rootScope.hashDoc 			= '';
							$scope.sincronizado 		= 'DOCUMENTO_NAO_SINCRONIZADO';
							$scope.dataEmissaoFormat 	= '';
							$scope.dataPrevEntregaFormatada = "";
							$scope.valorTotal 			= 0;

						} else {
							//para editar o pedido
							let docs 					= $dados.jsonDocs[0];
							$rootScope.hashDoc 			= docs.docCtrl;
							$rootScope.idDocumento 		= $dados.id;
							$rootScope.cliente 			= docs.cliente;
							$scope.tipoOrcamento 		= docs.tipoOrcamento;
							$scope.filial 				= docs.filial;
							$scope.tabPreco 			= docs.tabPreco;
							$scope.codTpr 				= docs.codTpr
							$scope.representante 		= docs.representante;
							$scope.qtdm3 				= docs.qtdm3
							$scope.frmCliente 			= docs.frmCliente;
							$scope.frete 				= docs.frete;
							$scope.totalFrete 			= docs.totalFrete;
							$scope.tabelaFrete 			= docs.tabelaFrete;
							$scope.validadeOrcamento 	= docs.validadeOrcamento != null ? new Date(docs.validadeOrcamento) : null
							//emissao de orcamento (date do sistema)
							$scope.emissaoOrcamento 	= docs.emissaoOrcamento != null ? new Date(docs.emissaoOrcamento) : null
							$scope.situacao 			= docs.situacao;
							$scope.prevEntregCli 		= docs.prevEntregCli != null ? new Date(docs.prevEntregCli) : null
							$scope.usuarioDigitacao 	= docs.usuarioDigitacao;
							$scope.condPagamento 		= docs.condPagamento;
							$scope.formaPagamento 		= docs.formaPagamento;
							$scope.observacao 			= docs.observacao;
							$scope.numPedClienteOCPO 	= docs.numPedClienteOCPO;
							//dois clientes
							$scope.frmCliente 			= docs.cliente;
							$scope.codigoCliente 		= docs.cliente.codExterno;
							$scope.nomeCliente 			= docs.cliente.nome;
							$scope.usuarioDigitacao 	= docs.usuarioDigitacao.nome;

							//datas formatadas 
							$scope.datEmiERP 			= docs.datEmiERP;
							$scope.dataEmissaoFormat 	= docs.datEmiERP != null ? docs.datEmiERP.substr(0, 10) : "";
							$scope.dataValidadeEmiFormat = docs.emissaoOrcamento != null ?  docs.emissaoOrcamento.substr(0,10) : "";

							$scope.obsOportunidade 		= '';
							$scope.histOportunidade 	= docs.histOportunidade;
							$scope.pedido 				= docs.pedido;
							$scope.sincronizado 		= docs.sincronizado;
							$scope.valorTotal 			= docs.valorTotal;
							/*Informações sobre o produto*/
							$rootScope.produtos 		= docs.produtos;
							$scope.codigoProduto 		= docs.produtos.codigoProduto;
							$scope.descricao 			= docs.produtos.descricao;
							$scope.codExternoProduto 	= docs.produtos.codExterno;
							$scope.ofertaPreco 			= docs.ofertaPreco;
							$scope.valorPrecoTotal 		= docs.valorPrecoTotal;
							$scope.valorPesoTotal 		= docs.valorPesoTotal;
							$scope.valorVolumeTotal 	= docs.valorVolumeTotal;
							$scope.valorQuantidadeTotal = docs.valorQuantidadeTotal;
							$scope.prevEntrega 			= $scope.prevEntrega != "" ? $scope.prevEntrega : null; 
							$scope.dataPrevEntregaFormatada = $scope.prevEntrega != "" ? new Date($scope.prevEntrega) : null;
						};
						$rootScope.changeView($dados);
					};

					$scope.calculoValidacaoProdutoERP = async ($dados) => {
						try {
							result = {
								erro: "",
								aprovado: true,
							}

							$rootScope.pedidoAprovado = {
								erro: result.erro,
								aprovado: result.aprovado
							}

							return $rootScope.pedidoAprovado

						} catch (err) {
							console.log("Ocorreu um erro na requisição: ", err);
						};
					}

					$scope.adicionarProduto = (resultTest) => {
						$rootScope.produtos.unshift(
							{
								preCli          : resultTest.precli,
								qtdm3			: resultTest.qtdm3,
								seq				: resultTest.seq,
								ocpo			: resultTest.ocpo,
								itocpo			: resultTest.itocpo,
								codProCli		: resultTest.usu_procli,
								descrProCli		: resultTest.desProdCli,
								precoVendFOB	: resultTest.usu_preliq,
								precoFrete		: resultTest.precoFrete,
								precoVendaCIF	: resultTest.precoVendaCIF,
								qtdPedida		: resultTest.qtdPedida,
								seqvpp			: resultTest.seqvpp,
								idxpre			: resultTest.idxpre,
								ofertaPreco		: resultTest.ofertaPreco,
								precoLiquido	: resultTest.precoLiquido,
								vlrLiquido		: resultTest.vlrLiquido,
								pesoKG			: resultTest.pesoKG,
								volumeM3		: resultTest.volumeM3,
								qtdEmb			: resultTest.usu_qtdemb,
								descEmb			: resultTest.descEmb,
								qtdSubEmb		: resultTest.qtdSubEmb,
								descrSubEmb		: resultTest.descrSubEmb,
								dataPCP			: resultTest.dataPCP,
								dataETD			: resultTest.dataETD,
								acresPreco		: resultTest.acresPreco,
								descontoFin		: resultTest.descontoFin,
								vlrDesconto		: resultTest.vlrDesconto,
								vlrBruto		: resultTest.vlrBruto,
								codPro			: resultTest.usu_codpro,
								derivacao		: resultTest.usu_codder,
								um				: resultTest.um,
								previsaoCli		: resultTest.previsaoCli,
								emb				: resultTest.emb,
								subEmb			: resultTest.usu_subemb,
								descrProduto	: resultTest.descrProd,
								descrDeriv		: resultTest.descDeriv,
								nrPedido		: resultTest.nrPedido,
								seqPed			: resultTest.seqPed
							}
						);

						var buscaProduto = angular.element(document.querySelector('#itemProd'));
						$timeout(function () {
							buscaProduto.blur();
							$scope.itemProd = '';
							$("table tbody tr:first-child").addClass("new-row-enter");
							$("table tbody tr:first-child input#quantidadeProdutoAdd").focus();
						}, 200);
						$timeout(() => {
							$("table tbody tr:first-child").removeClass("new-row-enter");
						}, 1000)
					};

					$scope.removerProduto = ($item) => {
						$rootScope.produtos = $rootScope.produtos.filter(item => item.codExterno !== $item.codExterno && item.codVariacao !== $item.codVariacao);
						$scope.calcularProdutos();
					};

					$scope.addObservacaoHistorico = () => {
						/*Data*/
						var dataAtual = new Date();
						var horas = (dataAtual.getHours() < 10 ? '0' : '') + dataAtual.getHours()
						var minutos = (dataAtual.getMinutes() < 10 ? '0' : '') + dataAtual.getMinutes()
						let strHistorico = [];
						strHistorico.push({
							item: $scope.obsOportunidade
						});
						for (let i = 0; i < strHistorico.length; i++) {
							$scope.histOportunidade += `
							- Descrição: ${strHistorico[i].item}
							- Registrado em: ${dataAtual.toLocaleDateString('pt-BR')} às ${horas}:${minutos}`
						}
						$scope.obsOportunidade = "";
					};

					$scope.finalizarDocumento = () => {
						bootbox.confirm({
							message: '<div class="alert alert-light" "role="alert"><p style="text-center; font-size:1.0em; text-align:center; padding:5px;">Confirma a finalização do pedido?</p></div>',
							closeButton: false,
							callback: function (confirmacao) {
								if (confirmacao) {
									$scope.salvarDocumento(2);
								}
							},
							buttons: {
								confirm: { label: 'Confirmar', className: 'btn_grid btn_cor_padrao' },
								cancel: { label: 'Cancelar', className: 'btn-default' },
							},
						});
					}

					// testando o salvamento do pedido 
					$scope.salvarDocumento = async (rotina) => {
						$scope.calcularProdutos()
						if($scope.valorPrecoTotal == NaN){
							console.log("valor vazio")
						}
						/*
						Rotinas:
							1 - Salvar (Mantém apenas no ClicVenda)
							2 - Finalizar (Envia o pedido para ERP)
						*/
						let hashDoc = $rootScope.hashDoc == '' ? '_' + Math.random().toString(36).substr(2, 9) : $rootScope.hashDoc;
						let id = $rootScope.idDocumento;
						let jsonDocs = [];
						let dados = {};

						$scope.messageNotific = '';

						dados.cnpj = { id: dadosUserLogado.cId };

						if ($scope.prevEntregCli == null || $scope.prevEntregCli == undefined){
							$scope.prevEntregCli = ""
						}

						jsonDocs = [{
							/*Historico*/
							obsOportunidade		: $scope.obsOportunidade,
							histOportunidade	: $scope.histOportunidade,
							// infos dos inputs da tela 
							tipoOrcamento		: $scope.tipoOrcamento,
							filial				: $scope.filial,
							tabPreco			: $scope.tabPreco,
							codTpr				: $scope.codTpr,
							representante		: $scope.representante,
							qtdm3				: $scope.qtdm3,
							cliente				: $scope.frmCliente,
							frete				: $scope.frete,
							totalFrete			: $scope.totalFrete,
							tabelaFrete			: $scope.tabelaFrete,
							validadeOrcamento	: $scope.validadeOrcamento,
							emissaoOrcamento	: $scope.emissaoOrcamento,
							situacao			: $scope.situacao,
							prevEntregCli		: $scope.prevEntregCli,
							prevEntregPcp		: $scope.prevEntregPcp,
							usuarioDigitacao	: $scope.usuarioDigitacao,
							condPagamento		: $scope.condPagamento,
							formaPagamento		: $scope.formaPagamento,
							observacao			: $scope.observacao,
							numPedClienteOCPO	: $scope.numPedClienteOCPO,
							valorPrecoTotal		: $scope.valorPrecoTotal,
							valorPesoTotal		: $scope.valorPesoTotal,
							valorVolumeTotal	: $scope.valorVolumeTotal,
							valorQuantidadeTotal: $scope.valorQuantidadeTotal,
							//Metodos
							docCtrl: hashDoc,
							// pedido final
							pedido				: $scope.pedido,
							sincronizado: $scope.sincronizado == "DOCUMENTO_SINCRONIZADO" ? "DOCUMENTO_SINCRONIZADO" : "DOCUMENTO_NAO_SINCRONIZADO",
							usuarioDigitacao: { rId: dadosUserLogado.rCod, nome: dadosUserLogado.rNome },
							datEmiERP: $scope.datEmiERP,
							//Produtos
							// verificação de quantidade de produtos
							produtos: $rootScope.produtos.filter(doc => doc && doc.qtdPedida && doc.qtdPedida > 0),
							valorTotal: parseFloat($scope.valorTotal),
							//Cliente
							cliente: { id: $rootScope.cliente.id, codExterno: $rootScope.cliente.codExterno, nome: $rootScope.cliente.nome, cpfCnpjFormat: $rootScope.cliente.cpfCnpjFormat },
						}];

						dados.jsonDocs = JSON.stringify(jsonDocs);

						/*Recebe dados e para que sejam feitas as alterações necessarias*/
						var json = JSON.parse(dados.jsonDocs);

						if (rotina == 2) {
							let sendToERP = JSON.parse(dados.jsonDocs);
							
							$rootScope.pedidoAprovado = await $scope.calculoValidacaoProdutoERP(sendToERP[0]);

							if (!$rootScope.pedidoAprovado.aprovado) {
								$scope.geraNotificacao("O pedido não foi aprovado: " + $rootScope.pedidoAprovado.erro, 2500, 'warning')
								json[0].sincronizado = "ERRO: " + $rootScope.pedidoAprovado.erro;
								json[0].pedido = 0;
							} else {
								$rootScope.documentoERP = await $scope.gravaDocumentoERP(dados.jsonDocs);
								/*Atualiza numero do pedido*/
								if (!isNaN(parseInt($rootScope.documentoERP))) {
									let dataFormat = new Date();
									json[0].sincronizado = "DOCUMENTO_SINCRONIZADO";
									json[0].datEmiERP = dataFormat.toLocaleDateString("pt-BR") + " EMI";
									json[0].pedido = $rootScope.documentoERP;
								} else {
									json[0].sincronizado = "ERRO: " + $rootScope.documentoERP;
									json[0].pedido = 0;
								}
							}
						};

						if (id > 0) {
							dados.jsonDocs = JSON.stringify(json);
							let response = await $http.post('/clicVendas/rest/pedidov2/salvar/' + id, dados);

							if (rotina == 1) {
								$scope.messageNotific = 'Registro alterado com sucesso';
								$scope.geraNotificacao($scope.messageNotific, 1500, 'success');
							}
						} else {

							dados.jsonDocs = JSON.stringify(json);
							let response = await $http.post('/clicVendas/rest/pedidov2/salvar/', dados);

							if (rotina == 1) {
								$scope.messageNotific = 'Registro inserido com sucesso';
								$scope.geraNotificacao($scope.messageNotific, 1500, 'success');
							}

						};

						$scope.atualizaTabela();
						$scope.exibeFormulario = false;
						$scope.exibeListaDocumentos = true;
					};

					$scope.limparFiltros = () => {
						$scope.filCliente = '';
						$scope.filRepresentante = '';
						$scope.filDataEmissao = '';
						$scope.filPesquisaGeral = '';
						$scope.filSincronizado = { nome: "", send: "" };
						$scope.atualizaTabela();
					};

					$scope.aplicarFiltros = (valor) => {
						$scope.filDataEmissao = $scope.filDataEmissao == "" ? "" : $scope.filDataEmissao.substr(0, 2) + "/" + $scope.filDataEmissao.substr(2, 2) + "/" + $scope.filDataEmissao.substr(4, 7) + " EMI";
						$scope.filCliente = $scope.filCliente;
						$scope.filRepresentante = $scope.filRepresentante;
						$scope.filPesquisaGeral = $scope.filPesquisaGeral;
						$scope.filSincronizado = $scope.filSincronizado;
						$scope.openNav();
					};

					$scope.atualizaTabela = async (modo) => {

						$scope.dtOptions = DTOptionsBuilder.newOptions()

							.withOption('ajax', {

								url: '/clicVendas/rest/pedidov2/lista',

								type: 'POST',

								data: function (d) {

									var param = { idCvTccnpj: dadosUserLogado.cId };
									var filter = {
										fil1: $scope.filCliente.toUpperCase(),
										fil2: $scope.filRepresentante,
										fil3: $scope.filPesquisaGeral,
										fil4: $scope.filSincronizado.send,
										fil5: "",
										fil6: $scope.filDataEmissao,
										fil7: dadosUserLogado.rCod, /*Lista pedidos apenas do representante que o fez*/
										fil8: dadosUserLogado.rNome,/*Lista pedidos apenas do representante que o fez*/
										fil9: "",
										fil10: "",
										fil11: ""

									};

									d.param = param;
									d.filter = filter;

									return JSON.stringify(d);

								},

								dataSrc: function (json) {

									/*Modo 1 - 
										Atualiza tabela com valores do ERP quando o pedido há número
									*/
									if (modo != 1) {
										$rootScope.dadosGrid = json.data;

										for (ped of $rootScope.dadosGrid) {
											ped.jsonDocs = JSON.parse(ped.jsonDocs);
										};

										$scope.consultaPedidosERP($rootScope.dadosGrid);
									}

									return $rootScope.dadosGrid.sort((a) => (a.jsonDocs[0].sincronizado != "DOCUMENTO_SINCRONIZADO" && a.jsonDocs[0].sincronizado != "DOCUMENTO_NAO_SINCRONIZADO") ? -1 : 1);
								}
							})
							.withDataProp('data')
							.withOption('processing', true)
							.withOption('serverSide', true)
							.withOption('bFilter', false)
							.withOption('searchDelay', 1000)
							.withOption('scrollY', '100%')
							.withOption('scrollX', '100%') 
							.withPaginationType('full_numbers')
							.withDisplayLength(20)
							.withDOM('ftrip')
							.withButtons([
								{
									text: 'Novo',
									key: '1',
									className: 'btn_grid btn_cor_padrao',
									action: function (e, dt, node, config) {
										$scope.abreFormulario();
									}
								},
								{
									text: 'Filtrar',
									key: '2',
									className: 'btn_grid btn_cor_padrao',
									action: function (e, dt, node, config) {
										$scope.openNav();
									}
								},
								{
									text: 'Atualizar',
									key: '4',
									className: 'btn_grid btn_cor_padrao',
									action: function () {
										$scope.atualizaTabela();
									}
								},
							]);

						//Monta a grid de orçamentos na tela
						defPD = {
							'id': 									{ i: 0, vsbl: true, tlt: 'Nº Pedido', 				width: '' },
							'jsonDocs[0].pedido': 					{ i: 1, vsbl: true, tlt: 'Nº Pedido ERP', 			width: '' },
							'jsonDocs[0].cliente.nome': 			{ i: 2, vsbl: true, tlt: 'Cliente', 				width: '' },
							'jsonDocs[0].usuarioDigitacao.nome': 	{ i: 3, vsbl: true, tlt: 'Usuario de digitação ', 	width: '' },
							'jsonDocs[0].representante':			{ i: 4, vsbl: true, tlt: 'Representate', 			width: '' }
						};

						DTDefaultOptions.setLanguageSource('plugins/pt-br.json');
						var montaColunas = [];

						// botões para editar, excluir, e imprimir.
						montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '50px').renderWith(function (data, type, row) {
							var btnhtml = '';
							btnhtml += "<div class='glyphicon glyphicon-edit' style='font-size:1.5em; color:var(--cor_principal);  display:inline-block; vertical-align: middle; cursor:pointer;' title='Editar' ng-click='abreFormulario(" + JSON.stringify(row) + ")'></div>";
							btnhtml += "<div class='glyphicon glyphicon-ban-circle' style='font-size:1.5em; color:var(--cor_principal); display:inline-block; vertical-align: middle; margin-left:5px; cursor:pointer;' title='Cancelar item' ng-click='removerDocumento(" + JSON.stringify(row) + ")' ></div>";
							btnhtml += "<div class='glyphicon glyphicon-print' style='font-size:1.5em; color:var(--cor_principal);  display:inline-block;  vertical-align: middle; margin-left:5px; cursor:pointer;' title='Imprimir' ng-click='imprimeOrcamento(" + JSON.stringify(row) + ")'></div>";

							return btnhtml;
						}));

						//botão para sincronização
						montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('Sinc.').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '50px').renderWith(function (data, type, row) {
							var btnhtml1 = '';
							if (row.jsonDocs[0].sincronizado == "DOCUMENTO_NAO_SINCRONIZADO") {
								btnhtml1 += "<div class='glyphicon glyphicon-ok-sign' title='Aguardando finalização' disabled style='font-size:1.5em; color:grey;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
							} else if (row.jsonDocs[0].sincronizado === "DOCUMENTO_SINCRONIZADO") {
								btnhtml1 += "<div class='glyphicon glyphicon-ok-sign' title='Pedido sincronizado - Nº" + row.jsonDocs[0].pedido + "' style='font-size:1.5em; color:green;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
							} else if (row.jsonDocs[0].sincronizado != "DOCUMENTO_NAO_SINCRONIZADO" && row.jsonDocs[0].sincronizado != "DOCUMENTO_SINCRONIZADO") {
								btnhtml1 += "<div class='glyphicon glyphicon-exclamation-sign' title='" + row.jsonDocs[0].sincronizado + "' disabled style='font-size:1.5em; color:#D0C84F;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
							}

							return btnhtml1;
						}));

						angular.forEach(defPD, function (value, key) {
							montaColunas.push(DTColumnBuilder.newColumn(key).withTitle(value.tlt).withOption('visible', value.vsbl).withOption('sortable', false).withOption('sWidth', value.width));
						});

						//botao para valor total do pedido
						montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('Valor Total').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '150px').renderWith(function(data, type, row) {
							var btnhtmlValor = '';
							let formatedValue = row.jsonDocs[0].valorPrecoTotal!="" && row.jsonDocs[0].valorPrecoTotal != null ? row.jsonDocs[0].valorPrecoTotal.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}) : ""

							btnhtmlValor += "<div style='font-size:1.0em; color:black;  display:inline-block; vertical-align: middle; cursor:pointer;'>"+formatedValue+"</div>";
										
							return btnhtmlValor;
						}));

						// botão para data de emissao
						montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('Data emissão').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '150px').renderWith(function (data, type, row) {
							var btnhtmlData = '';
							let dataFormatadaBr = '';
							let dataFormat = row.jsonDocs[0].emissaoOrcamento != undefined ? row.jsonDocs[0].emissaoOrcamento.substr(0, 10) : ""
							dataFormatadaBr = dataFormat.split('-').reverse().join('/');
							btnhtmlData += "<div style='font-size:1.0em; color:black;  display:inline-block; vertical-align: middle; cursor:pointer;'>" + dataFormatadaBr + "</div>";
							return btnhtmlData;
						}));

						$scope.dtColumns = montaColunas;

						angular.element('#listDocuments').attr('datatable', '');
						$compile(angular.element('#listDocuments'))($scope);

						$scope.dtOptions.withOption('fnRowCallback',

							function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
								$compile(nRow)($scope);
							});

					};

					$scope.atualizaTabela();

					$scope.geraNotificacao = (message, time = 1200, tipo = 'light') => {
						/* Utiliza o Alert Bootstrap
							light   - padrao
							danger 	- aviso erro
							warning	- aviso informativo 
							success - sucesso
						*/
						$rootScope.isLoading = true;

						var dialog = bootbox.dialog({
							message: '<div class="alert alert-' + tipo + ' popup"role="alert"><p style="text-center; font-size:1.0em; font-weight:bold; text-align:center; padding:20px;">' + message + '</p></div>',
							closeButton: false
						});

						setTimeout(() => {
							dialog.modal('hide');
							$rootScope.isLoading = false;
						}, time);
					};

					$scope.removerDocumento = ($dados) => {
						var id = $dados.id;
						//caso o orçamento ja esteja no ERP ele não exclui
						if ($dados.jsonDocs[0].pedido != 0 && !isNaN(parseInt($dados.jsonDocs[0].pedido))) {
							$scope.geraNotificacao("Este pedido já está no ERP, não é possível excluí-lo.", 2500, 'warning');
						} else {
							bootbox.confirm({
								message: '<div class="alert alert-light" "role="alert"><p style="text-center; font-size:1.0em; text-align:center; padding:5px;">Confirma a exclusão do pedido?</p></div>',
								closeButton: false,
								onHidden: function (e) {
									$scope.atualizaTabela();
								},
								callback: function (confirmacao) {

									if (confirmacao) {
										$http.delete('/clicVendas/rest/pedidov2/deleta/' + id);
										setTimeout(() => {
											$scope.atualizaTabela();
										}, 1500);
									}
								},
								buttons: {
									confirm: { label: 'Confirmar', className: 'btn_grid btn_cor_padrao' },
									cancel: { label: 'Cancelar', className: 'btn-default' },
								},
							});
						};
					};

					$scope.openNav = () => {
						if (document.getElementById("mySidebar").style.width == "250px") {
							document.getElementById("mySidebar").style.width = "0";
							document.getElementById("mySidebar").style.height = "0";
							document.getElementById("main").style.marginLeft = "0";

							setTimeout(() => {
								$scope.atualizaTabela()
							}, 250)
						} else {
							document.getElementById("mySidebar").style.width = "250px";
							document.getElementById("mySidebar").style.height = "500px";
							document.getElementById("main").style.marginLeft = "255px";
						};

					};

				});
	</script>

</body>

</html>

<style>
	:root {
		--cor_principal: #006c38;
	}

	ul {
		overflow-y: auto;
		max-height: 420px;
	}

	h5 {
		font-weight: 700;
		font-size: 1.1em;
		color: #333;
	}

	p {
		font-size: 13px;
		font-weight: 400;
	}

	tr {
		height: 55px;
	}

	table {
		margin-top: -20px;
	}

	.inputNumberTable {
		width: 20vh;
	}

	.table>thead>tr>th {
		vertical-align: inherit;
	}

	#tabelaProdutos {
		border-radius: 4px;
		border-top: 1.5px solid rgb(236, 236, 236);
	}

	#tabelaProdutos tr>th {
		box-shadow: 4px 7px 7px #ededed;
	}

	#tabelaProdutos tr>td {
		font-size: 13px;
		font-weight: 400;
	}

	#tabelaProdutos td,
	th {
		vertical-align: inherit;
	}

	#tabelaProdutos tr:hover {
		background-color: rgb(248, 248, 248);
		border-radius: 8px;
	}

	.panel-body{
		padding: 0;
	}

	.panel-mid{
		width: 100vh;
	}

	th,
	td,
	a {
		font-size: 12px;
		white-space: nowrap;
		padding-right: 6vh;
		padding-left: 2vh;
	}

	th {
		background-color: #FAFAFA;
		border-radius: 2px;
		padding-right: 3vh;
	}

	#tabelaProdutos>th {
		padding-right: 30px
	}

	.dataTables_wrapper .dataTables_info {
		font-size: 8px;
	}

	.dataTables {
		border-bottom: 0;
	}

	.header-filtro-tabela {
		background-color: var(--cor_principal);
		border-radius: 3px;
		margin-top: -10px;
		margin-top: -25%;
		height: 35px;
		padding: 5px
	}

	.btn_grid {
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
	}

	.btn_acao_header {
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
		width: 80px;
		height: 35px;
		font-size: 0.88em;
	}

	.btn_cor_padrao {
		background-color: var(--cor_principal) !important;
		border-color: var(--cor_principal) !important;
	}

	.container {
		flex: 1;
		width: -webkit-fill-available;
	}

	.divider {
		border-top: 1px solid rgb(230, 230, 230);
	}

	.divider-titulo {
		border-top: 0.8px solid rgb(230, 230, 230);
		border-bottom: 0.8px solid rgb(230, 230, 230);
		height: 50px;
		background-color: #FAFAFA;
		border-radius: 3px;
		box-shadow: 5px 1px 4px grey;
	}

	.itens-titulo {
		margin-top: -15px;
	}

	.spacer-block {
		margin-top: 10px;
	}

	.spacer {
		margin-top: 20px;
	}

	.spacer-input {
		margin-top: 0px;
		margin-left: 0px;
	}

	table {
		margin-top: -2px;
	}

	.titulo {
		font-size: 14px;
		font-weight: bolder;
	}

	.input-button {
		display: table;
	}

	.vcenter {
		display: flex;
		align-items: center;
	}

	#mySidebar {
		height: 100%;
		/* 100% Full-height */
		width: 0;
		/* 0 width - change this with JavaScript */
		position: absolute;
		/* Stay in place */
		z-index: 1;
		/* Stay on top */
		top: 50;
		left: 50;
		background-color: rgba(255, 255, 255, 1);
		overflow-x: hidden;
		/* Disable horizontal scroll */
		padding-top: 60px;
		/* Place content 60px from the top */
		transition: 0.2s;
		/* 0.5 second transition effect to slide in the sidebar */
		box-shadow: 0 5px 5px 0 rgba(0, 0, 0, 0.50);

	}

	#mySidebar label {
		padding: 5px 5px 5px 10px;
		text-decoration: none;
		font-size: 14px;
		color: #000;
		display: block;
		transition: 0.2s;
	}

	#mySidebar input {
		padding: 5px 5px 5px 10px;
		margin-left: 10px;
	}

	.navbar-header,
	label {
		display: inline !important
	}

	/* When you mouse over the navigation links, change their color */
	#mySidebar a:hover {
		color: rgb(216, 216, 216);
	}

	/* The button used to open the sidebar */
	.openbtn {
		font-size: 20px;
		cursor: pointer;
		background-color: #111;
		color: white;
		padding: 10px 15px;
		border: none;
	}

	pre {
		padding: 6px;
		border: 0;
		background-color: white
	}

	.divTextTable {
		width: 10vh;
	}

	.inputTable {
		outline: 0;
		border-width: 0 0 0.5px;
		border-color: rgb(184, 184, 184);
		width: 80%;
		height: 35px;
		border-style: dashed;
	}

	.inputTable:focus {
		border-color: rgb(0, 0, 0);
		border-style: solid;
	}

	.inputTable:invalid {
		border-style: dashed;
		border-color: rgba(243, 3, 3, 0.568);
	}

	.openbtn:hover {
		background-color: #444;
	}

	/* Style page content - use this if you want to push the page content to the right when you open the side navigation */
	#main {
		transition: margin-left .2s;
		/* If you want a transition effect */
		padding: 0px;
		height: 100%;
	}

	.modal-body {
		padding: 0;
		margin-top: 15%;
	}

	.modal-content {
		margin-top: 20%;
		background-color: rgb(247, 247, 247);
		border: 0;
	}

	.modal {
		margin-left: -5%;
	}

	.bootbox-body {
		height: 50px;
		font-size: 1.1em;
		text-align: center;
		font-weight: 500;
	}

	.popup {
		height: 100px;
	}

	.modal-backdrop {
		visibility: hidden;
	}

	.new-row-enter {
		background-color: rgb(253, 249, 243);
	}

	/* On smaller screens, where height is less than 450px, change the style of the sidenav (less padding and a smaller font size) */
	@media screen and (max-height: 450px) {
		.sidebar {
			padding-top: 15px;
		}

		.sidebar a {
			font-size: 18px;
		}
	}

	input::-webkit-outer-spin-button,
	input::-webkit-inner-spin-button {
		-webkit-appearance: none;
		margin: 0;
	}

	.scroll-div {
		overflow-y: scroll;
		height: 60vh;
		margin-top:-60px;
	}
</style>