<!DOCTYPE html>  
<html ng-app="appV2">  
<meta charset="UTF-8"/>
<head> 
	<meta charset="UTF-8"/>
	<!-- Imports CSS-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" crossorigin="anonymous">
	
	<!--<link rel="stylesheet" href="http://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/bootstrap.min.css">-->
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/angular-datatables.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.colVis.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.tableTools.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/datatables.bootstrap.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/isteven-multi-select.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/font-awesome/css/all.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.min.css">
	<!-- Imports CSS-->

<!-- View --> 
</head>  
<body>
	<div class="container" ng-controller="MainController">
		
		<!--Primeira página-->
		<div ng-show="exibeListaDocumentos">
		
			<!-- Sidebar Menu FILTRO -->
			<div id="mySidebar" class="sidebar">
			
				<div class="header-filtro-tabela">
					<p style="text-align: center; color:white; font-weight: 900; ">Filtro<span ng-click="openNav()" style="color: white; margin-left:70%" class="glyphicon glyphicon-minus"></span></p>
				</div>

				<form>
					<div style="margin-top:5px" class="form-group">
						<label for="filFornecedores">Pesquisar</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input"  id="filPesquisaGeral" ng-model="filPesquisaGeral" autocomplete="off" aria-describedby=" " placeholder="Digite a palavra chave. Ex: '123'">
					</div>

					<div class="form-group">
						<label for="filStatusSituacao">Status Situação</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" id="filStatusSituacao" ng-model="filStatusSituacao" aria-describedby=" " placeholder=" " uib-typeahead="(status.nome) for status in getStatusSituacaoAmostra($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectStatusSituacaoAmostra($item, $model, $label)">
					</div>
					
					<div class="form-group">
						<label for="filCliente">Cliente</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" id="filCliente" ng-model="filCliente" aria-describedby=" " placeholder=" ">
					</div>
										
					<div class="form-group">
						<label for="projeto">Sincronização</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" ng-value="filSincronizado.nome" ng-model="filSincronizado" id="filSincronizado" uib-typeahead="(sincronizado.nome) for sincronizado in getFilScinronizacao($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectFilSincronizacao($item, $model, $label)">
					</div>
					
					<div class="form-group">
						<label for="filCarteira">Data Emissão</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" ui-mask="99/99/9999" id="filDataEmissao" ng-model="filDataEmissao">
					</div>
										
					<!-- <div class="form-group">
						<label for="filCarteira">Prioridade</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" id="filPrioridade" ng-model="filPrioridade" aria-describedby=" " placeholder=" ">
					</div> -->
					
					<div class="form-group">
						<label for="filCarteira">Produto</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" id="filProduto" ng-model="filProduto" aria-describedby=" " placeholder=" ">
					</div>
				</form>

				<div class="text-center" style="height: 50px;">
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-click="aplicarFiltros()"> Buscar </button>
					</div>
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-click="limparFiltros();"> Limpar </button>
					</div>
				</div>

			</div>
			<!--Sidebar Menu FILTRO-->
		
			<!-- Tabela -->
			<div id="main">
				<!-- Tabela Simplificada -->
				<div ng-hide="tabelaCompleta" class="col-sm-12 ">
					<table id="listDocuments"  dt-options="dtOptions" dt-columns="dtColumns" dt-instance="dtInstance" class="row-border responsive hover table-striped table-bordered"></table>					
				</div>
				<!-- Tabela completa -->
				<div ng-hide="!tabelaCompleta" class="col-sm-12">
					<table id="listDocumentsFull"  dt-options="dtOptionsFull" dt-columns="dtColumnsFull" dt-instance="dtInstanceFull" class="tabelaCompleta row-border responsive hover table-striped table-bordered"></table>					
				</div>
			</div>
			<!-- Tabela -->
		
		</div>
		<!--Primeira página-->

		<!-- FORM NOVO DOCUMENTO -->

		<div ng-show="exibeFormulario">
			<!-- <button class="btn btn_acao_header btn_cor_padrao" ng-click="changeView()"> Voltar </button> -->

			<!-- Header formulario -->
			<div class="divider-titulo row">
				<div class="spacer titulo vcenter col-sm-12">
					<div class="col-sm-6 itens-titulo">
						<button class="btn btn_acao_header btn_cor_padrao" ng-click="changeView()"><span class="glyphicon glyphicon-chevron-left"></span>  Voltar</button>
					</div>
					<div class="col-sm-6">
						<h5 style="margin-top: 0; margin-left:-15%;">{{tipoFormulario}}</h5>
					</div>
				</div>			
			</div>
			<!-- Header formulario -->
			
			<!-- Capa do pedido -->
			<div id="docAdd" class="row" ng-show="permiteEditar">
				
				<div class="col-sm-12">

					<!-- Body formulario -->
<!-- 					
					<ul style="overflow: hidden;" class="nav nav-tabs" role="tablist" id="myTab">
					  <li role="presentation" class="active"><a href="#docAdd-cliente-tab" role="tab" data-toggle="tab">Informações</a></li>
					  <li role="presentation"><a href="#docAdd-produto-tab" ng-click="atualizaTabelaProdutos()" role="tab" data-toggle="tab">Produtos</a></li>
					</ul> -->

					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active" id="docAdd-cliente-tab">
							<div id="docAdd-cliente" class="form-row">
								<div class="form-group col-md-12">
									
									<div class="col-sm-7 spacer">
										<label for="nomeCliente">Nome Cliente</label>
										<div class="input-group spacer">
											<input type="text" ng-disabled="inputDesabilitado" ng-model="frmCliente" name="frmCliente" id="frmCliente" placeholder="Informe o cliente" uib-typeahead="(cliente.nome + ' (' + cliente.cpfCnpjFormat + ')') for cliente in getClientes($viewValue)" typeahead-loading="loadingCli" typeahead-no-results="noResultsCli"  typeahead-on-select="onSelectCli($item, $model, $label)" class="form-control" required="true" autocomplete="off" typeahead-min-length="0" >
											<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaCliente()"><i class="glyphicon glyphicon-remove"></i></span>
										</div>
									</div>
									
									<div class="col-sm-2 spacer">
										<label for="codigoCliente">Cód. do Cliente</label>
										<div class="spacer">
											<input type="text" readonly class="form-control" ng-model="codigoCliente" id="codigoCliente">
										</div>
									</div>

									<div class="col-sm-3 spacer ">
										<label for="vendedor">Vendedor</label>
										<div class="spacer">
											<input type="text" readonly class="form-control" ng-value="vendedor.nome" ng-model="vendedor" id="vendedor">
										</div>
									</div>
								</div>
								
								<div class="form-group col-md-12">
									
									<div ng-show="!usuarioAprovador" class="col-sm-12 spacer">
										<label for="codPro">Localizar Produto</label>
										<!-- <input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="codigoProduto" id="codPro"> -->
										<div class="input-group spacer">
											<input type="text" ng-disabled="inputDesabilitado" ng-model="itemProd" name="itemProd" id="itemProd" placeholder="Informe o produto" uib-typeahead="retorno.produto.codExterno + ' - ' + retorno.produto.nome for retorno in getProdutos($viewValue)" typeahead-loading="loadingProd" typeahead-no-results="noResults"  typeahead-on-select="adicionarProduto($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0" typeahead-template-url="templateAutoCompleteProduto">
											<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaProduto()"><i class="glyphicon glyphicon-remove"></i></span>
										</div>
										<i ng-show="loadingProd" class="glyphicon glyphicon-refresh"></i>
										<div ng-show="noResults">
											<i class="glyphicon glyphicon-remove"></i> Sem Resultados
										</div>	
									</div>

									<!-- <div class="col-sm-5 spacer">
										<label for="despro">Descrição</label>
										<input type="text" readonly ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="descricaoProd" id="descricaoProd">
									</div>
									<div class="col-sm-2 spacer">
										<label for="consumo">Consumo (Kg/mês)</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="consumoProdutoKgMes" id="consumoProdutoKgMes">
									</div>

									<div class="col-sm-2 spacer">
										<label for="quantidadeProduto">Quantidade</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="quantidadeProduto" id="quantidadeProduto">
									</div>

									<div class="col-sm-2 spacer ">
										<label for="aplicacao">Aplicação</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="aplicacao" id="aplicacao">
									</div>
									
									<div class="col-sm-1 spacer" style="padding-top: 30px;">
										<label for="aplicacao"> </label>							
										<div class="btn-group">
											<button ng-disabled="descricaoProd == '' || consumoProdutoKgMes == ''|| quantidadeProduto == '' || aplicacao  == '' " class="btn btn_grid btn_cor_padrao" ng-click="adicionarProduto()"> + </button>
										</div>
									</div> -->
								</div>
								
								<div class="form-group col-md-12">
									<!-- <div class="col-sm-12 spacer">
										<table id="listDocumentsProdutos" dt-options="dtOptionsProd" dt-columns="dtColumnsProd" dt-instance="dtInstanceProd" class="row-border responsive hover"></table>
									</div> -->
									<table id ="listDocumentsProdutos" class="table">
										<thead>
											<tr>
												<th>Produto</th>
												<th>Quantidade</th>
												<th>Aplicação</th>
												<th>Consumo</th>
												<th>Data Teste</th>
												<!-- <th>Valor total</th> -->
												<th ng-show="!usuarioAprovador"></th>
											</tr>
										</thead>
										<tbody ng-repeat = "produto in produtos">
											<tr>
												<td>
													<div ng-show="produto.codVariacao == ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src='/clicvenda/produtos/{{subdomain}}/{{produto.codExterno}}.jpg' onerror='this.src="images/icon/semimagem.png"' style='width: 80px;'></div>
													<div ng-show="produto.codVariacao != ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src='/clicvenda/produtos/{{subdomain}}/{{produto.codExterno}}_{{produto.codVariacao}}.jpg' onerror='this.src="images/icon/semimagem.png"' style='width: 80px;'></div>
													<p style="white-space: normal;">{{produto.codExterno}} - {{produto.descricao}} <p>
													<!-- <div ng-show="produto.acoes != '' ">
														<span class='glyphicon glyphicon-exclamation-sign' style='font-size:1.2em; color:#D0C84F;  display:inline-block; vertical-align: middle; cursor:pointer;' title="Revisar"></span>
														{{produto.acoes}}
													</div>													 -->
													<!-- <p style="font-size: 0.8em;"><b style="margin-left:5px">Estoque: </b>{{produto.estoque}}</p> -->
													<!-- <p style="font-size: 0.8em;"><b style="margin-left:5px">Un. medida: </b>{{produto.unidMedida}}</p> -->
												</td>
												<td>
													<div>
														<input type="number" step="any" name="quantidadeProduto" class="inputTable" ng-value="produto.quantidade" id="quantidadeProdutoAdd" ng-model="produto.quantidade">
													</div>
												</td>
												<td>
													<div>
														<input type="text" step="any" name="aplicacao" class="inputTable" ng-model="produto.aplicacao">
													</div>
												</td>
												
												<td>
													<div>
														<input type="text" step="any" name="consumoProdutoKgMes" class="inputTable" ng-model="produto.consumoProdutoKgMes">
													</div>
												</td>

												<td>
													<div>
														<input type="text" step="any" name="dataTestes" class="inputTable" ng-model="produto.dataTestes">
													</div>
												</td>

												<td ng-show="!usuarioAprovador">
													<div class="col-sm-12">
														<div class='glyphicon glyphicon-remove col-sm-6' style='font-size:1.5em; padding-left:4px; color:var(--cor_principal); display:inline-block; vertical-align: middle; cursor:pointer;' title='Remover' ng-click='removerProduto(produto)'></div>
													</div>		
												</td>
											</tr>
											<tr>
												<td colspan ="20">
													<div>
														<textarea placeholder="Digite uma obervação para o item." style="width: 100%;" type="text" step="any" name="observacao" class="inputTable" ng-model="produto.observacao"></textarea>
													</div>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>	

			<div id="docEdit" style="margin-top:8px;" class="row spacer" ng-show="!permiteEditar">
				
				<div class="col-sm-12">	
				
					<ul style="overflow: hidden;" class="nav nav-tabs" role="tablist" id="myTab">
						<li role="presentation" class="active"><a href="#docEdit-manu-projeto" role="tab" data-toggle="tab">Manutenção</a></li>
						<li role="presentation"><a href="#docEdit-info-projeto" role="tab" data-toggle="tab">Informações do projeto</a></li>
						<li role="presentation"><a href="#docEdit-hist-projeto" role="tab" data-toggle="tab">Histórico / Observações</a></li>
					</ul>
					
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane" id="docEdit-info-projeto">

							<!-- <div class="form-row ">
								<div class="form-group col-md-12" >
									<div class="col-sm-2 spacer hidden">
										<label for="anoFat">Ano Faturamento</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="anoFat" id="anoFat" >
									</div> -->
									<!-- <div class="col-sm-3 spacer ">
										<label for="responsavel">Responsável</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="responsavel" id="responsavel">
									</div> -->
									<!-- <div class="col-sm-2 spacer ">
										<label for="projeto">Projeto</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="projeto" id="projeto" uib-typeahead="(projetos.nome) for projetos in getProjetos($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectProjeto($item, $model, $label)">
									</div>
								</div>
							</div> -->
				
							<div class="form-row " >
								<div class="form-group col-md-12">
									<div class="col-sm-2 spacer">
										<label for="codigoCliente">Cód. do Cliente</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="codigoCliente" id="codigoCliente">
									</div>
									<div class="col-sm-6 spacer">
										<label for="nomeCliente">Nome do Cliente</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="nomeCliente"  id="nomeCliente">
									</div>
									<div class="col-sm-1 spacer ">
										<label for="uf">UF</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="uf" id="uf">
									</div>
									
									<div class="col-sm-3 spacer ">
										<label for="vendedor">Vendedor</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-value="vendedor.nome" ng-model="vendedor" id="vendedor">
									</div>
									
									<div class="col-sm-4 spacer ">
										<label for="segmento">Segmento</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="segmento" id="segmento">
									</div>
									<div class="col-sm-3 spacer ">
										<label for="subsegmento">Subsegmento</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="subsegmento" id="subsegmento">
									</div>
									<div class="col-sm-3 spacer ">
										<label for="bu">BU</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="bu" id="bu">
									</div>
									<div class="col-sm-2 spacer ">
										<label for="projeto">Projeto</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="projeto" id="projeto" uib-typeahead="(projetos.nome) for projetos in getProjetos($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectProjeto($item, $model, $label)">
									</div>
								</div>
							</div>
					
					
							<div class="form-row ">
								<div class="form-group col-md-12">
									<div class="col-sm-2 spacer">
										<label for="pedNumped">Pedido</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="pedNumped" id="pedNumped">
									</div>
									<div class="col-sm-2 spacer">
										<label for="pedDatEmi">Emissão</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="pedDatEmiFormat" id="pedDatEmi">
									</div>
									<div class="col-sm-4 spacer">
										<label for="familia">Familia</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="familia" id="familia">
									</div>
									<div class="col-sm-4 spacer">
										<label for="cluster">Cluster</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="cluster" id="cluster">
									</div>
									<div class="col-sm-2 spacer">
										<label for="codPro">Cód. Produto</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="codExternoProduto" id="codExterno">
									</div>
									<div class="col-sm-4 spacer">
										<label for="despro">Descrição</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="descricao" id="despro">
									</div>
									<div class="col-sm-2 spacer">
										<label for="desagr">Ag. Comercial</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="desagr" id="desagr">
									</div>
									<div class="col-sm-2 spacer">
										<label for="quantidade">Qtde (kg)</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="quantidade" id="quantidade">
									</div>
									<div class="col-sm-2 spacer">
										<label for="dataStatus">Data Status</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="dataStatus" id="dataStatus">
									</div>
									<!-- <div class="col-sm-2 spacer">
										<label for="situacao">Situação Amostra</label>
										<input type="text" class="form-control spacer-input" ng-model="situacaoAmostra" id="situacaoAmostra" uib-typeahead="situacao.nome for situacao in getSituacaoAmostra($viewValue)" typeahead-loading="loadingProd" typeahead-no-results="noResultsIV"  typeahead-on-select="onSelectSituacaoAmostra($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">
									</div> -->
									<div class="col-sm-2 spacer">
										<label for="consumo">Consumo (Kg/mês)</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="consumoProdutoKgMes" id="consumoProdutoKgMes">
									</div>
									<!-- <div class="col-sm-8 spacer">
										<label for="justificativa">Justificativa</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="justificativa" id="justificativa">
									</div>				  		   -->
									<!-- <div class="col-sm-2 spacer"> -->
										<!-- <label for="con2021n">Con. 2021 (em nº)</label> -->
										<!-- <input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="con2021n" id="con2021n"> -->
									<!-- </div>			   -->
									<!-- <div class="col-sm-2 spacer"> -->
										<!-- <label for="con2022n">Con. 2022 (em nº)</label> -->
										<!-- <input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="con2022n" id="con2022n"> -->
									<!-- </div> -->
								</div>	
							</div>
							
							<!-- <div class="form-row ">
								<div class="form-group col-md-12">
									<div class="col-sm-2 spacer">
										<label for="ofertaData">OFERTA Data</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="ofertaData" id="ofertaData">
									</div>			  
									<div class="col-sm-2 spacer">
										<label for="ofertaUnit">OFERTA Unit. (US$)</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="ofertaUnit" id="ofertaUnit">
									</div>			  
									
									<div class="col-sm-2 spacer">
										<label for="identQtd">INDENT Qtde</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="identQtd" id="identQtd">
									</div>			  
									<div class="col-sm-2 spacer hidden">
										<label for="venda">Venda</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="venda" id="venda">
									</div>			  
									<div class="col-sm-2 spacer">
										<label for="vendaLocalKg">Venda Local (KG)</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="vendaLocalKg" id="vendaLocalKg">
									</div>			  
									<div class="col-sm-2 spacer">
										<label for="ultVendaTabdin">Últ. Venda TABDIN</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="ultVendaTabdin" id="ultVendaTabdin">
									</div>
									<div class="col-sm-2 spacer">
										<label for="primVendaTabdin">1.a Venda TABDIN</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="primVendaTabdin" id="primVendaTabdin">
									</div>			   -->
									<!-- <div class="col-sm-2 spacer"> -->
										<!-- <label for="anoPrimVenda">ANO 1.a VENDA</label> -->
										<!-- <input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="anoPrimVenda" id="anoPrimVenda"> -->
									<!-- </div> -->
									<!-- <div class="col-sm-2 spacer">
										<label for="totalFatUSD">Tot. Fat. (USD)</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="totalFatUSD" id="totalFatUSD">
									</div>			  
									<div class="col-sm-2 spacer">
										<label for="margemR">Margem (R$)</label>
										<input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="margemR" id="margemR"> 
									</div>			   -->
									<!-- <div class="col-sm-2 spacer"> -->
										<!-- <label for="preUSD">Pre. USD</label> -->
										<!-- <input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="preUSD" id="preUSD"> -->
									<!-- </div>			   -->
									<!-- <div class="col-sm-2 spacer"> -->
										<!-- <label for="potVolAg">Pot. Vol. AG</label> -->
										<!-- <input type="text" ng-disabled="inputDesabilitado" class="form-control spacer-input" ng-model="potVolAg" id="potVolAg"> -->
									<!-- </div> -->
								<!-- </div>
							</div> -->

						</div>
					
						<div role="tabpanel" class="tab-pane active" id="docEdit-manu-projeto">
					
							<div class="form-row ">
								<div class="form-group col-md-12">
									<div class="col-sm-2 spacer ">
										<label for="projeto">Projeto</label>
										<input type="text" class="form-control spacer-input" ng-model="projeto" id="projeto" uib-typeahead="(projetos.nome) for projetos in getProjetos($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectProjeto($item, $model, $label)">
									</div>
									<!-- <div class="col-sm-2 spacer ">
										<label for="responsavel">Responsável</label>
										<input type="text" class="form-control spacer-input" ng-model="responsavel" id="responsavel" >
									</div> -->
									<div class="col-sm-2 spacer">
										<label for="prioridade">Ano</label>
										<input type="text" class="form-control spacer-input" ng-value="anoAmostra.nome" ng-model="anoAmosta" id="anoAmosta" uib-typeahead="(ano.nome) for ano in getAnoAmostra($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectAnoAmostra($item, $model, $label)">
									</div>
									<div class="col-sm-2 spacer">
										<label for="prioridade">Trimestre</label>
										<input type="text" class="form-control spacer-input" ng-value="trimestreAmostra.nome" ng-model="trimestreAmostra" id="trimestreAmostra" uib-typeahead="(trimestre.nome) for trimestre in getTrimestreAmostra($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectTrimestreAmostra($item, $model, $label)">
									</div>				  
									<div class="col-sm-2 spacer">
										<label for="potencial">Potencial</label>
										<input type="text" class="form-control spacer-input" ng-model="potencial0XCM" id="potencial0XCM" >
									</div>
									<div class="col-sm-2 spacer">
										<label for="consumoAg">Consumo Ano Ger.</label>
										<input type="text" class="form-control spacer-input" ng-model="consumoAg" id="consumoAg">
									</div>
									<div class="col-sm-2 spacer">
										<label for="con2021Ident">Consumo indent</label>
										<input type="text" class="form-control spacer-input" ng-model="conIndent" id="conIndent">
									</div>	
									<div class="col-sm-2 spacer">
										<label for="conLocal">Consumo local</label>
										<input type="text" class="form-control spacer-input" ng-model="conLocal" id="conLocal" >
									</div>		
									<div class="col-sm-2 spacer">
										<label for="mesIniConsumo">Mes Início Consumo</label>
										<input type="text" class="form-control spacer-input" ng-model="mesIniConsumo" id="mesIniConsumo" >
									</div>											
									<div class="col-sm-2 spacer">
										<label for="probFechamento">% Prob. Fec.</label>
										<input type="text" class="form-control spacer-input" ng-model="probFechamento" id="probFechamento" >
									</div>			  
									<div class="col-sm-2 spacer">
										<label for="concorrencia">Concorrência</label>
										<input type="text" class="form-control spacer-input" ng-model="concorrencia" id="concorrencia" >
									</div>			  
									<div class="col-sm-2 spacer">
										<label for="precoConc">Preço Conc. US$</label>
										<input type="text" class="form-control spacer-input" ng-model="precoConc" id="precoConc" >
									</div>
									<div class="col-sm-2 spacer hidden">
										<label for="dataAtu">Data Atualização</label>
										<input type="date" class="form-control spacer-input" ng-model="dataAtu" id="dataAtu" >
									</div>
									
									<div class="col-sm-2 spacer">
										<label for="situacao">Situação Amostra</label>
										<input type="text" class="form-control spacer-input" ng-model="situacaoAmostra" id="situacaoAmostra" uib-typeahead="situacao.nome for situacao in getSituacaoAmostra($viewValue)" typeahead-loading="loadingProd" typeahead-no-results="noResultsIV"  typeahead-on-select="onSelectSituacaoAmostra($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">
									</div>
									<div class="col-sm-8 spacer">
										<label for="justificativa">Justificativa</label>
										<textarea type="text" class="form-control spacer-input" ng-model="justificativa" id="justificativa"></textarea>
									</div>		
								</div>
							</div>
							
							<div class="form-row col-md-12 spacer">
									<hr class="divider"> 
							</div>
								
							<div class="form-row ">
								<div class="form-group col-md-12">		  	   
									<div class="col-sm-10 spacer">
										<label for="acoes">Ações</label>
										<textarea class="form-control spacer-input" ng-model="acoes" id="acoes" rows="3"></textarea>
									</div>	
									<div class="col-sm-2 spacer">
										<label for="statusAcao">Status da Ação</label>
										<input type="text" class="form-control spacer-input" ng-model="statusAcao" id="statusAcao" >
									</div>		
								</div>
							</div>
							
						</div>
					
						
						<div role="tabpanel" class="tab-pane" id="docEdit-hist-projeto">
							<div class="form-row">
								<div class="col-sm-12 spacer">
										<label for="histOportunidade">Histórico</label>
										<textarea class="form-control spacer-input" ng-disabled="inputDesabilitado" ng-model="histOportunidade" id="histOportunidade" rows="10"></textarea>
									</div>
							</div>
							<div class="form-row">
								<div class="col-sm-12 spacer">
									<hr class="divider">
								</div>
							</div>
							<div class="form-row">
								<div class="col-sm-11 spacer">
									<label for="obsOportunidade">Observação</label>
									<textarea class="form-control spacer-input"  ng-model="obsOportunidade" id="obsOportunidade" rows="3"></textarea>
								</div>
								<div class="col-sm-1 spacer" style="padding-top: 30px;">
									<label for="obsOportunidade"> </label>							
									<div class="btn-group">
										<button class="btn btn_grid btn_cor_padrao" ng-disabled="obsOportunidade=='' || obsOportunidade==undefined " ng-click="addObservacaoHistorico()"> Incluir </button>
									</div>
								</div>
							</div>
						</div>
					</div>
					
				</div>	
					
			</div>
			<!-- Capa do pedido -->
						
			<hr class="divider">
			<!-- Ações sob o formulario -->
			<div class="row spacer">
				<div class="pull-right" style="padding-right: 10px;">
					<!-- <div class="btn-group">
						<button class="btn btn_grid btn-success" title="O pedido será enviado para o ERP" ng-disabled="produtos.length == 0 || isLoading || codigoCliente == '' " ng-show="pedNumped == 0 && produtos.situacao.send ==='EM_ANALISE' && dadosUserLogado.rTipoId === 3 " ng-click="finalizarDocumento()"> Enviar para o ERP </button>
					</div> -->
					<div class="btn-group dropup">
						<button type="button" class="btn btn-default dropdown-toggle" ng-disabled="produtos.length == 0 || isLoading || codigoCliente == '' " data-toggle="dropdown">
							Salvar
							<span class="caret caret-up"></span>
						</button>
						<ul ng-show="!usuarioAprovador" style="cursor: pointer;" class="dropdown-menu drop-up" role="menu">
							<li><a title="Será salvo e manterá em aberto" ng-click="salvarDocumento(1, 'EM_DIGITACAO')">Apenas Salvar</a></li>
							<!-- <li><a title="Será salvo e manterá em aberto" ng-click="salvarDocumento(1, 'EM_DIGITACAO')">Apenas Salvar</a></li> -->
							<li ng-show="!inputDesabilitado"><a title="Será salvo e enviado para análise" ng-click="salvarDocumento(1, 'EM_ANALISE')">Enviar para análise</a></li>     
						</ul>
						<ul ng-show="usuarioAprovador" style="cursor: pointer;" class="dropdown-menu drop-up" role="menu">
							<li><a title="Salvar e enviar para o ERP" ng-click="finalizarDocumento()">Enviar para o ERP</a></li>  
							<li><a title="Salvar e enviar para revisão" ng-click="salvarDocumento(1, 'EM_REVISAO')">Enviar para revisão</a></li>     
							<li><a title="Irá arquivar o pedido" ng-click="salvarDocumento(1, 'AM_FECHADA')">Arquivar</a></li>      
						</ul>
					</div>	
					<!-- <div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-disabled="produtos.length == 0 || isLoading || codigoCliente == '' "  ng-click="salvarDocumento(1)"> Salvar </button>
					</div> -->
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-click="changeView()"> Cancelar </button>
					</div>	
				</div>
			</div>
			<!-- Ações sob o formulario -->
			<hr class="divider">	

		</div>
	
	</div>

	<script type="text/ng-template" id="templateAutoCompleteProduto">
		<a>
			<table>
				<tr>
					<td style="padding-right: 25px;">
						<div ng-show="match.model.codVariacao == ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src="/clicvenda/produtos/{{$parent.$parent.$parent.subdomain}}/{{match.model.produto.codExterno}}.jpg" onerror='this.src="images/icon/semimagem.png"' style='width: 64px;'/></div>
						<div ng-show="match.model.codVariacao != ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src="/clicvenda/produtos/{{$parent.$parent.$parent.subdomain}}/{{match.model.produto.codExterno}}_{{match.model.produto.codVariacao}}.jpg" onerror='this.src="images/icon/semimagem.png"' style='width: 64px;'/></div>
					</td>			
					<td>
						<div class="row">
							<div class="col-md-12">{{match.model.produto.codExterno}} - {{match.model.produto.nome}} - {{match.model.produto.codVariacao}}</div>				
						</div>							
					</td>
				</tr>
			</table>
		</a>
	 </script>
	<!-- View --> 

<!-- Scripts importados -->
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/jquery-3.1.1.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/easytimer.min.js"></script>	
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-route.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-ui-router.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-cookies.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angular-ui-notification/angular-ui-notification.min.js"></script>  
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/ui-bootstrap-tpls-2.5.0.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/dist/jquery.dataTables.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/dist/angular-datatables.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/bootstrap.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.bootstrap.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.factory.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.options.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/dataTables.buttons.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.colVis.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.flash.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.html5.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.print.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.buttons.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-locale_pt-br.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-sanitize.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/fullcalendar-3.10.0/lib/moment.min.js"></script>	
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/ui-mask-master/dist/mask.min.js"></script>
<!-- Scripts importados -->	

<script>
var dadosUserLogado = parent.dadosUserLogadoPersonalizado();	

angular
	.module("appV2",['ngRoute', 'ngSanitize', 'ui.bootstrap', 'datatables', 'datatables.buttons', 'ui.mask'])
	.controller("MainController",
	function(DTOptionsBuilder, DTColumnDefBuilder, DTColumnBuilder, DTDefaultOptions, $scope, $rootScope, $compile, $http, $timeout, $window){
		
		$scope.exibeFormulario 		= false; 
		$scope.exibeListaDocumentos = true;

		$rootScope.subdomain		= dadosUserLogado.cSubdominio;

		$rootScope.isLoading 		= false;
		
		/* Inicializa filtros */
		$scope.filStatusSituacao		= {nome:"", send:""};
		$scope.filSegmento				= "";
		$scope.filDataEmissao 			= "";
		$scope.filCliente 				= "";
		//$scope.filStatusAmostra			= "";
		$scope.filPrioridade			= "";
		$scope.filProduto				= "";
		$scope.filSincronizado			= {nome:"", send:""};
		$scope.filPesquisaGeral			= "";
		/*Incializa produtos*/
		$rootScope.produtos 			= [];
		$scope.novoProdutoAdicionado	= false  

		/*Incializa cliente*/
		$rootScope.cliente				= {};
		$scope.usuarioAprovador 		= dadosUserLogado.rTipoId != 3 ? false : true;
	
		$scope.consultaDocumento = async (hash) => {
			/*Consulta na base ClicVenda - pedidov2*/
			$rootScope.listAllDocs = [];

			let result = await $http({
				method	: 'POST',
				url		: '/clicVendas/rest/pedidov2/consulta',
				data	: {param:{idCvTccnpj : dadosUserLogado.cId, id: hash}}	
			});

			let listAllDocs = result.data.parametros != null ? result.data.parametros.documentos : [];
			
			for(doc of listAllDocs){	
				doc.jsonDocs = JSON.parse(doc.jsonDocs);
			}
			$rootScope.listAllDocs = listAllDocs;

			return listAllDocs;
		};

		$rootScope.changeView = ($dados) => {
			if($scope.exibeFormulario == false){

				$scope.exibeFormulario = true;
				$scope.exibeListaDocumentos = false;
				
				if($dados == undefined){
					$scope.tipoFormulario = 'Novo';

					$scope.inputDesabilitado  = false;
					$scope.permiteEditar	  = true;
					
					$scope.$applyAsync();

				}else{
					$scope.tipoFormulario = $dados.jsonDocs[0].sincronizado === 'DOCUMENTO_SINCRONIZADO' ? 'Prospecção ERP Nº '+ $dados.jsonDocs[0].pedNumped : "Prospecção Nº "+$dados.jsonDocs[0].numPedidoClic;
				
					if($dados.jsonDocs[0].produtos.situacao && $dados.jsonDocs[0].produtos.situacao.send == "AM_INTEGRADA" || $dados.jsonDocs[0].produtos.situacao.send == "AM_FECHADA"){
						$scope.inputDesabilitado  = true;
						$scope.permiteEditar	  = false;

					}else{
						$scope.inputDesabilitado  = false;
						$scope.permiteEditar	  = true;

						if($dados.jsonDocs[0].produtos.situacao && $dados.jsonDocs[0].produtos.situacao.send == "EM_ANALISE"){
							$scope.inputDesabilitado  = true;
						}
					}
	
				};
				
			}else if($scope.exibeFormulario == true){

				$scope.exibeFormulario = false;
				$scope.exibeListaDocumentos = true;
				$scope.atualizaTabela();
				$scope.atualizaTabelaCompleta();
			};
		};

		$scope.getFilScinronizacao = () =>{
			$scope.listaFilSincronizacao = [ 
				{
					nome: 'Não sincronizados',
					send: "DOCUMENTO_NAO_SINCRONIZADO"
				},
				{
					nome: 'Sincronizados',
					send: "DOCUMENTO_SINCRONIZADO"
				},
				{
					nome: 'Falha na sincronização',
					send: 'ERRO: '
				},
			];
			return $scope.listaFilSincronizacao;
		};

		$scope.onSelectFilSincronizacao = ($item, $model, $label) => {
			$scope.filSincronizado	= $item;
		};

		$scope.getSituacaoAmostra = () => {
			$scope.listaSituacaoAmostra = [
				{
					nome:'SOLICITAÇÃO DE AMOSTRA',
					id:1
				},
				{
					nome:'ENVIADA',
					id:2
				},
				{
					nome:'TESTE',
					id:3
				},
				{
					nome:'TESTE INDUSTRIAL',
					id:4
				},
				{
					nome:'CATÁLOGO',
					id:5
				},
				{
					nome:'REPROVADA TECNICAMENTE',
					id:6
				},
				{
					nome:'APROVADA TECNICAMENTE',
					id:7
				},
				{
					nome:'REPROVADA COMERCIALMENTE',
					id:8
				},
				{
					nome:'APROV. TEC E REP. COMERCIAL',
					id:9
				},
				{
					nome:'STAND BY',
					id:10
				},
				{
					nome:'CANCELADA',
					id:11
				},
			];
			return $scope.listaSituacaoAmostra;
		};

		$scope.onSelectSituacaoAmostra = ($item, $model, $label) => {
			$scope.situacaoAmostra = $item;
		};

		$scope.getStatusSituacaoAmostra = () => {
			$scope.listaSituacaoAmostra = [
				{
					nome:'Em digitação',
					send:'EM_DIGITACAO'
				},
				{
					nome:'Análise',
					send:'EM_ANALISE'
				},
				{
					nome:'Revisão',
					send:'EM_REVISAO'
				},
				{
					nome:'Integrado',
					send:'AM_INTEGRADA'
				},
				{
					nome:'Fechada',
					send:'AM_FECHADA'
				}
			];
			return $scope.listaSituacaoAmostra;
		};

		$scope.onSelectStatusSituacaoAmostra = ($item, $model, $label) => {
			$scope.filStatusSituacao = $item;
		};
		
		$scope.getTrimestreAmostra = () => {
			$scope.listaTrimestreAmostra = [
				{
					nome:'1º Trimestre',
					id:1
				},
				{
					nome:'2º Trimestre',
					id:2
				},
				{
					nome:'3º Trimestre',
					id:3
				},
				{
					nome:'4º Trimestre',
					id:4
				}
			];
			return $scope.listaTrimestreAmostra;
		};

		$scope.onSelectTrimestreAmostra = ($item, $model, $label) => {
			$scope.trimestreAmostra = $item;
		};

		$scope.getAnoAmostra = () => {
			$scope.listaAnoAmostra = [
				{
					nome:'2022',
					id:1
				},
				{
					nome:'2023',
					id:2
				},
				{
					nome:'2024',
					id:3
				},
				{
					nome:'2025',
					id:4
				}
			];
			return $scope.listaAnoAmostra;
		};

		$scope.onSelectAnoAmostra = ($item, $model, $label) => {
			$scope.anoAmostra = $item;
		};

		$scope.getProjetos = () =>{
			$scope.listaProjetos = [ 
				{
					nome: 'PROSPECÇÃO',
					id: 1
				},
				{
					nome: 'OPORTUNIDADE',
					id: 2
				},
				{
					nome: 'PROJETO',
					id: 3
				},
				{
					nome: 'SUBSTITUIÇÃO',
					id: 4
				},
				{
					nome:"OUTROS",
					id: 5
				}
			];
			return $scope.listaProjetos;
		};

		$scope.onSelectProjeto = ($item, $model, $label) => {
			$scope.projeto 		= $item;
		};

		$scope.getClientes = function(val) {
			
			var idRep = dadosUserLogado.rId;

			return $http.post('/clicVendas/rest/Listas/cliente', {
				params: {
					filtro: val,
					rId: idRep
				}
			}).then(function(response){
				return response.data.map(function(item){
					return item;
				});
			});
		};

		$scope.onSelectCli = ($item, $model, $label) => {
			$rootScope.cliente = $item;	
			
			$scope.codigoCliente = $rootScope.cliente.codExterno
		};

		$scope.limpaCliente = () =>{
			$scope.frmCliente 	 = '';
			$scope.codigoCliente = '';
			var cCliente		 = angular.element(document.querySelector('#frmCliente'));
			
			$timeout(function () {
				cCliente.focus();
			}, 200);
		};
						
		/*Tempo limite para funções*/
		const setAsyncTimeout = (cb, timeout = 0) => new Promise((resolve, reject) => {
			cb(resolve);
			setTimeout(() => reject('A requisição demorou muito para responder, por favor tente novamente mais tarde.'), timeout);
		});

		$scope.executaRequisicaoExterna = async ($json, timeLimit = 15) => {
			console.log($json, "REQUISICAO EXTERNA - Envio para o ERP")
			try {
				let response;

				await setAsyncTimeout(async done => {		
					response = await $http.post(dadosUserLogado.cContextIntegracao + '/rest/Listas/executarRequisicaoExterna', $json);
					done();/*Aguarda a requisição - Se estourar o tempo, gera erro.*/
								
				}, timeLimit * 1000); // limite em segundos
				
				console.log(response.data, "Retorno ERP")
				return response.data;
			}catch(err){
				$scope.geraNotificacao("Não foi possível se comunicar com o ERP. "+err+"", 5000, 'danger')
			};
		};

		$scope.agruparPedidosAprovador = () =>{
			$rootScope.dadosGrid = $rootScope.dadosGrid.filter(aprov => aprov.jsonDocs[0].produtos.situacao && aprov.jsonDocs[0].produtos.situacao.send === "EM_ANALISE") 

			$scope.atualizaTabela(1);/* 1 - Atualiza apenas a view, não busca da base de dados */
		}

		$scope.consultaPedidosERP = async () => {
			
			let pedidosGravadosERP 	= $rootScope.dadosGrid.filter(doc => doc.jsonDocs[0].pedNumped != '' &&  parseInt(doc.jsonDocs[0].pedNumped) > 0);
			let consulta 			= [];

			for(i = 0; i < pedidosGravadosERP.length; i++){
				consulta.push(
					{
						numPed: pedidosGravadosERP[i].jsonDocs[0].pedNumped,
						codPro: pedidosGravadosERP[i].jsonDocs[0].produtos.codExterno,
						codDer: pedidosGravadosERP[i].jsonDocs[0].produtos.codVariacao,
					}
				)
			};

			let dialog = bootbox.dialog({
				message: '<div class="alert alert-light popup"role="alert"><p style="font-size:1.0em; font-weight:bold; text-align:center;">Sincronizando com o ERP...</p></div>',
				closeButton: false
			});
			$rootScope.isLoading = true;

			let result = await $scope.executaRequisicaoExterna(
				{
					idCvtccnpj 	 : dadosUserLogado.cId,
					numreg	   	 : 752,
					pRotina	   	 : 'listarPedidosAmostras',
					pCodCli    	 : dadosUserLogado.rId,
					pListaPedido : {lista:{pedidos : consulta}},
				},
				20//limite de espera em segundos
			);
						
			dialog.modal('hide');
			$rootScope.isLoading = false;
			
			if(result !=""){
				for(k = 0; k < pedidosGravadosERP.length; k++){				
					let dadosAtualizados = result.resultado.filter(res => res.pedNumped == pedidosGravadosERP[k].jsonDocs[0].pedNumped && res.produto[0].ipdCodPro == pedidosGravadosERP[k].jsonDocs[0].produtos.codExterno);

					if(dadosAtualizados && dadosAtualizados.length > 0){
						for(l=0; l < $rootScope.dadosGrid.length; l++){

							/*Verifica -
								Codigo externo - Codigo variacao - Numero pedido ERP*/
							if(($rootScope.dadosGrid[l].jsonDocs[0].pedNumped == pedidosGravadosERP[k].jsonDocs[0].pedNumped) && 
								($rootScope.dadosGrid[l].jsonDocs[0].produtos.codExterno === pedidosGravadosERP[k].jsonDocs[0].produtos.codExterno)){
																								
								/*Itens do documento geral que serão atualizados*/
								//pedidosGravadosERP[k].jsonDocs[0].pedDatEmi 						= dadosAtualizados[0].pedDatEmi;
								pedidosGravadosERP[k].jsonDocs[0].uf								= dadosAtualizados[0].cliSigUfs;
								pedidosGravadosERP[k].jsonDocs[0].bu								= dadosAtualizados[0].cliBU;
								pedidosGravadosERP[k].jsonDocs[0].subsegmento						= dadosAtualizados[0].cliSubSeg;
								pedidosGravadosERP[k].jsonDocs[0].segmento							= dadosAtualizados[0].cliDesRam;
								
									
								/*Atualiza informações do produto vinculado ao documento*/
								pedidosGravadosERP[k].jsonDocs[0].produtos.consumoProdutoKgMes		= dadosAtualizados[0].produto[0].consumoCliente;
								pedidosGravadosERP[k].jsonDocs[0].produtos.cluster					= dadosAtualizados[0].produto[0].proCluster;
								pedidosGravadosERP[k].jsonDocs[0].produtos.situacao					= dadosAtualizados[0].produto[0].ipdSitAmo;
								pedidosGravadosERP[k].jsonDocs[0].produtos.ofertaUnit				= dadosAtualizados[0].produto[0].ipvVlrBru;
								pedidosGravadosERP[k].jsonDocs[0].produtos.familia			    	= dadosAtualizados[0].produto[0].proDesFam;
								pedidosGravadosERP[k].jsonDocs[0].produtos.dataStatus				= dadosAtualizados[0].produto[0].ipdDatAmo;
								pedidosGravadosERP[k].jsonDocs[0].produtos.justificativa			= dadosAtualizados[0].produto[0].ipdObsAmo;
								pedidosGravadosERP[k].jsonDocs[0].produtos.ofertaData				= dadosAtualizados[0].produto[0].ofrDatEmi;
								
								// pedidosGravadosERP[k].jsonDocs[0].produtos.responsavel				= dadosAtualizados[0].produto[0].proResFor;
								
								// pedidosGravadosERP[k].jsonDocs[0].produtos.potencial0XCM			= dadosAtualizados[0].produto[0].
								// pedidosGravadosERP[k].jsonDocs[0].produtos.chaveCp				= dadosAtualizados[0].produto[0].
								pedidosGravadosERP[k].jsonDocs[0].produtos.identQtd					= dadosAtualizados[0].produto[0].indQtdPed;
								pedidosGravadosERP[k].jsonDocs[0].produtos.venda					= dadosAtualizados[0].produto[0].venVenda;
								pedidosGravadosERP[k].jsonDocs[0].produtos.vendaLocalKg				= dadosAtualizados[0].produto[0].venQtdFat;
								// pedidosGravadosERP[k].jsonDocs[0].produtos.totalFatUSD			= dadosAtualizados[0].produto[0].
								// pedidosGravadosERP[k].jsonDocs[0].produtos.margemR				= dadosAtualizados[0].produto[0].
								// pedidosGravadosERP[k].jsonDocs[0].produtos.preUSD				= dadosAtualizados[0].produto[0].
								// pedidosGravadosERP[k].jsonDocs[0].produtos.ofertaData			= dadosAtualizados[0].produto[0].
								// pedidosGravadosERP[k].jsonDocs[0].produtos.probFechamento		= dadosAtualizados[0].produto[0].
								// pedidosGravadosERP[k].jsonDocs[0].produtos.consumoAg				= dadosAtualizados[0].produto[0].
								pedidosGravadosERP[k].jsonDocs[0].produtos.ultVendaTabdin			= dadosAtualizados[0].produto[0].venUltDat;
								pedidosGravadosERP[k].jsonDocs[0].produtos.primVendaTabdin			= dadosAtualizados[0].produto[0].venPriDat;


								/*Adiciona ao documento campos que não estão listados*/
								pedidosGravadosERP[k].jsonDocs[0].nfvDatEmi							= dadosAtualizados[0].nfvDatEmi;
							
								continue;
							};
						};
					};
				};
			}
			
			$scope.atualizaTabela(1);/* 1 - Atualiza apenas a view, não busca da base de dados */
			$scope.atualizaTabelaCompleta(1);		
		};

		$scope.gravaDocumentoERP = async ($item) => {
			let dialog = bootbox.dialog({
				message: '<div class="alert alert-light popup"role="alert"><p style="font-size:1.0em; font-weight:bold; text-align:center;">Enviando pedido para o ERP...</p></div>',
				closeButton: false
			});

			$rootScope.isLoading = true;

			// let result = await $scope.executaRequisicaoExterna(
			// 	{
			// 		idCvtccnpj : dadosUserLogado.cId,
			// 		numreg	   : 752,
			// 		pRotina	   : 'criarPedidoAmostra',
			// 		pCodCli    : dadosUserLogado.rId,
			// 		pDocumento : {documento : $item}
			// 	}		
			// );

			result = "612"  /*Valor fixo para teste*/
			$rootScope.isLoading = false;
			
			if(!isNaN(parseInt(result))){
				dialog.modal('hide');
				$scope.geraNotificacao('O pedido foi gravado com sucesso no ERP.', 2000, 'success')
			}else{
				dialog.modal('hide');
				$scope.geraNotificacao('Houve uma falha na gravação do pedido.',2000, 'danger');
			};
			
			return result;
			
		};

		$scope.getProdutos = (val) => {			
			
			var dados = {};
			dados.filtro			= val|| '';
			dados.idCvTccnpj		= dadosUserLogado.cId;
			dados.idCvTolistapreco	= 41943//41943; //17431/*Lista de preço com ID fixo */
			
			return $http.post('/clicVendas/rest/Listas/produtosPedido', dados).then(function(response){
				return response.data.map(function(item){
					return item;
				});
			});
		};

		$scope.onSelectProd = ($item, $model, $label) => {
			
			$scope.descricaoProd = $item.produto.nome;
			$scope.codVariacao	 = $item.produto.codVariacao;
			$scope.codExterno	 = $item.produto.codExterno;
			$scope.codigoProduto = $item.produto.id;

			var focusBtn		 = angular.element(document.querySelector('#consumoProdutoKgMes'));
						
			$timeout(function () {
				focusBtn.focus();
			}, 200);

		};

		$scope.limpaProduto = (acao) =>{
			$scope.itemProd 	 		= '';
			$scope.aplicacao			= '';
			$scope.consumoProdutoKgMes  = '';
			$scope.quantidadeProduto 	= '';
			$scope.descricaoProd 		= '';
			$scope.codVariacao	 		= '';
			$scope.codExterno	 		= '';
			$scope.codigoProduto 		= '';
			$scope.cluster				= '';
			
			var produto		 = angular.element(document.querySelector('#itemProd'));
			
			if(acao == undefined){
				$timeout(function () {
					produto.focus();
				}, 200);
			};

		};
		
		$scope.agruparProdutos = ($item) => {
			let allProducts = [];
			
			for(let i = 0; i < $item.length; i++){
				allProducts.push($item[i].jsonDocs[0].produtos)
			}

			return allProducts
		}

		$scope.abreFormulario = async ($dados) =>{

			$rootScope.changeView($dados);

			if($dados == undefined){
				$rootScope.idDocumento 		= 0;

				/*Produtos*/
				$rootScope.produtos			= [];
				$scope.quantidadeProduto	= '';
				$scope.codigoProduto		= '';
				$scope.descricaoProd		= '';
				$scope.aplicacao			= '';
				$scope.itemProd				= '';
				$scope.quantidade			= '';
				$scope.situacao				= '';
				$scope.justificativa		= '';
				$scope.consumoProdutoKgMes	= '';
				$scope.familia				= '';
				$scope.probFechamento		= '';
				$scope.concorrencia			= '';
				$scope.precoConc			= '';
				$scope.consumoAg			= '';
				$scope.ofertaData			= '';
				$scope.ofertaUnit			= '';
				$scope.potencial0XCM		= '';
				$scope.chaveCp				= '';
				$scope.identQtd				= '';
				$scope.venda				= '';
				$scope.vendaLocalKg			= '';
				$scope.totalFatUSD			= '';
				$scope.margemR				= '';
				$scope.preUSD				= '';
				$scope.situacaoAmostra		= '';
			
				$scope.mesIniConsumo		= '';

				/*Cliente*/
				$scope.frmCliente			= '';
				$scope.codigoCliente		= '';
				$scope.nomeCliente			= '';

				/*Documento*/
				$scope.chave 				= '';
				$scope.anoFat 		    	= '';
				// $scope.responsavel			= '';
				$scope.projeto				= '';				
				$scope.uf					= '';
				$scope.vendedor				= {rId: dadosUserLogado.rId, nome: dadosUserLogado.rNome, rCod:dadosUserLogado.rCod},
				$scope.segmento				= '';
				$scope.subsegmento			= '';
				$scope.bu					= '';
				$scope.pedDatEmi			= '';
				$scope.pedDatEmiFormat		= '';

				$scope.pedNumped			= 0 ;
				$scope.cluster				= '';
				$scope.desagr				= '';
				$scope.dataStatus			= '';
				$scope.prioridade			= '';
				
				$scope.conIndent			= '';
				$scope.con2021n				= '';
				$scope.con2022n				= '';
				$scope.conLocal				= '';
				$scope.dataAtu				= '';
				$scope.potVolAg				= '';
				$scope.ultVendaTabdin		= '';
				$scope.primVendaTabdin		= '';
				$scope.anoPrimVenda			= '';

				$scope.statusAcao			= '';
				$scope.acoes				= '';
			
				/*Historico*/
				$scope.obsOportunidade		= '';
				$scope.histOportunidade		= '';
				
				/*Sincronização - Envio ERP*/
				$rootScope.hashDoc			= '';
				$rootScope.numPedidoClic	= '';
				$scope.sincronizado			= "DOCUMENTO_NAO_SINCRONIZADO";

				// $scope.atualizaTabelaProdutos();

			}else{
				let docs 					= $dados.jsonDocs[0];

				$rootScope.hashDoc			= docs.docCtrl;
				$rootScope.numPedidoClic	= docs.numPedidoClic;
				$rootScope.idDocumento 		= $dados.id;
				/*Cliente*/
				$rootScope.cliente			= docs.cliente;
				$scope.frmCliente			= docs.cliente;
				$scope.codigoCliente		= docs.cliente.codExterno;
				$scope.nomeCliente			= docs.cliente.nome

				/*Documento*/
				$scope.chave 				= docs.chave;
				$scope.anoFat				= docs.ano;
				$scope.projeto				= docs.projeto;
				$scope.uf					= docs.uf;
				$scope.vendedor				= docs.vendedor;
				$scope.segmento				= docs.segmento;
				$scope.subsegmento			= docs.subsegmento;
				$scope.bu					= docs.bu;
				$scope.pedDatEmi			= docs.pedDatEmi;
				$scope.pedDatEmiFormat		= docs.pedDatEmi != null ? docs.pedDatEmi.substr(0,10) : "";;
				$scope.pedNumped			= docs.pedNumped;
				$scope.desagr				= docs.desagr;
				$scope.prioridade			= docs.prioridade;
				$scope.conIndent			= docs.conIndent;
				$scope.con2021n				= docs.con2021n;
				$scope.con2022n				= docs.con2022n;
				$scope.conLocal				= docs.conLocal;

				$scope.dataAtu				= docs.dataAtu;
				$scope.potVolAg				= docs.potVolAg;
				$scope.ultVendaTabdin		= docs.produtos.ultVendaTabdin;
				$scope.primVendaTabdin		= docs.produtos.primVendaTabdin;
				$scope.anoPrimVenda			= docs.anoPrimVenda;
				$scope.statusAcao			= docs.statusAcao;
				$scope.acoes				= docs.acoes;

				/*Historico*/
				$scope.obsOportunidade		= '';
				$scope.histOportunidade		= docs.histOportunidade;

				/*Sincronização - Envio ERP*/
				$scope.sincronizado			= docs.sincronizado;

				/*Valida situação e aplica regra - Agrupa produtos pelo mesmo hashCode*/
				if(docs.produtos.situacao && (docs.produtos.situacao.send === "EM_DIGITACAO" || docs.produtos.situacao.send === "EM_ANALISE" || docs.produtos.situacao.send === "EM_REVISAO" )){
					$scope.documentosClic		= await $scope.consultaDocumento($dados.jsonDocs[0].docCtrl);
					$rootScope.produtos			= $scope.agruparProdutos($scope.documentosClic);
				
					$scope.$apply();					
				}else{
					/*Informações sobre o produto*/
					$rootScope.produtos			= docs.produtos;
					// $scope.responsavel			= docs.produtos.responsavel;
					$scope.cluster				= docs.produtos.cluster;
					$scope.quantidade			= docs.produtos.quantidade;
					$scope.codigoProduto		= docs.produtos.codigoProduto;
					$scope.descricao			= docs.produtos.descricao;
					$scope.consumoProdutoKgMes  = docs.produtos.consumoProdutoKgMes;
					$scope.codExternoProduto	= docs.produtos.codExterno
					$scope.situacao				= docs.produtos.situacao;
					$scope.ofertaUnit			= docs.produtos.ofertaUnit;
					$scope.dataStatus			= docs.produtos.dataStatus;
					$scope.justificativa		= docs.produtos.justificativa;
					$scope.potencial0XCM		= docs.produtos.potencial0XCM;
					$scope.chaveCp				= docs.produtos.chaveCp;
					$scope.identQtd				= docs.produtos.identQtd;
					$scope.venda				= docs.produtos.venda;
					$scope.vendaLocalKg			= docs.produtos.vendaLocalKg;
					$scope.totalFatUSD			= docs.produtos.totalFatUSD;
					$scope.margemR				= docs.produtos.margemR;
					$scope.preUSD				= docs.produtos.preUSD;
					$scope.ofertaData			= docs.produtos.ofertaData;
					$scope.probFechamento		= docs.produtos.probFechamento;
					$scope.consumoAg			= docs.produtos.consumoAg;
					$scope.chaveCp				= docs.produtos.chaveCp;
					$scope.familia				= docs.produtos.familia;
					$scope.concorrencia			= docs.produtos.concorrencia;
					$scope.precoConc			= docs.produtos.precoConc;
					$scope.mesIniConsumo		= docs.produtos.mesIniConsumo;

					$scope.situacaoAmostra		= docs.produtos.situacaoAmostra;
					$scope.anoAmostra			= docs.produtos.anoAmostra;
					$scope.trimestreAmostra		= docs.produtos.trimestreAmostra;
					// $scope.statusAcao			= docs.produtos.statusAcao;
					// $scope.acoes				= docs.produtos.acoes;

					$scope.consultaDocumento($rootScope.hashDoc);
				}
								
			};	
		//	$scope.$applyAsync();	
		};

		$scope.adicionarProduto = ($item) =>{

			$scope.novoProdutoAdicionado	= true;
			$scope.descricaoProd 			= $item.produto.nome;
			$scope.codVariacao	 			= $item.produto.codVariacao;
			$scope.codExterno	 			= $item.produto.codExterno;
			$scope.codigoProduto 			= $item.produto.id;
			
			$rootScope.produtos.unshift(
				{
					observacao			: $item.produto.observacao,
					dataTeste			: $item.produto.dataTeste,
					situacaoAmostra		: $scope.situacaoAmostra,
					anoAmostra			: $scope.anoAmostra,
					trimestreAmostra	: $scope.trimestreAmostra,

					consumoProdutoKgMes	: $scope.consumoProdutoKgMes,
					descricao			: $item.produto.nome,
					codigoProduto		: $item.produto.id,
					aplicacao			: $item.produto.aplicacao,
					quantidade			: $item.produto.quantidadeProduto,
					codVariacao			: $item.produto.codVariacao,
					codExterno			: $item.produto.codExterno,
					/*Grava durante a edição  do pedido*/
					cluster				: $scope.cluster,
					ofertaUnit			: $scope.ofertaUnit,
					dataStatus			: $scope.dataStatus,
					justificativa		: $scope.justificativa,
					potencial0XCM		: $scope.potencial0XCM, 
					chaveCp				: $scope.chaveCp,
					identQtd			: $scope.identQtd,
					venda				: $scope.venda,
					vendaLocalKg		: $scope.vendaLocalKg,
					totalFatUSD			: $scope.totalFatUSD,
					margemR				: $scope.margemR,
					preUSD				: $scope.preUSD,
					ofertaData			: $scope.ofertaData,
					probFechamento		: $scope.probFechamento,		
					consumoAg			: $scope.consumoAg,	
					familia				: $scope.familia,
					concorrencia		: $scope.concorrencia,
					precoConc			: $scope.precoConc,
					mesIniConsumo		: $scope.mesIniConsumo,
					statusAcao			: $scope.statusAcao,			
					acoes				: $scope.acoes,				
					hashDoc				: '',
				}
			);
			
			var buscaProduto		= angular.element(document.querySelector('#itemProd'));
			
			$timeout(function () {
				buscaProduto.blur();
				$scope.itemProd = '';

				$("table tbody tr:first-child").addClass("new-row-enter");
				$("table tbody tr:first-child input#quantidadeProdutoAdd").focus();
			}, 200);

			$timeout(()=>{
				$("table tbody tr:first-child").removeClass("new-row-enter");
			}, 1000)
			
		};

		$scope.removerProduto = async ($item) => {
			$rootScope.produtos = $rootScope.produtos.filter(item => item.codigoProduto !== $item.codigoProduto);

			if($item.situacao && $item.situacao.send === "EM_DIGITACAO"){
				let docs 		= await $scope.consultaDocumento($item.hashDoc)
				let docToRemove = docs.filter(item => item.jsonDocs[0].produtos.codigoProduto === $item.codigoProduto);

				$http.delete('/clicVendas/rest/pedidov2/deleta/'+ docToRemove[0].id); 
			}
		};
		
		$scope.addObservacaoHistorico = () => {
			/*Data*/
			var dataAtual 	= new Date();
			var horas 		= (dataAtual.getHours()<10?'0':'') + dataAtual.getHours()
			var minutos 	= (dataAtual.getMinutes()<10?'0':'') + dataAtual.getMinutes()
			var datFormat 	= dataAtual.toLocaleDateString('pt-BR')

			let strHistorico = [];

			strHistorico.push({
				item: $scope.obsOportunidade
			});

			for(let i = 0; i < strHistorico.length; i++){
				$scope.histOportunidade += `
				
- Descrição: ${strHistorico[i].item}
- Produto: ${$scope.descricao} - ${$scope.codExternoProduto}. 
- Registrado em: ${datFormat.substr(0,5)} às ${horas}:${minutos}`
			}
		
			$scope.obsOportunidade = "";
		};

		$scope.finalizarDocumento = () => {
			
			bootbox.confirm({
				message:'<div class="alert alert-light" "role="alert"><p style="text-center; font-size:1.0em; text-align:center; padding:5px;">Confirma a finalização?</p></div>',
				closeButton: false,
				callback: function(confirmacao){
					if (confirmacao){
						$scope.salvarDocumento(2, 'AM_INTEGRADA');
					}
				},
				buttons: {
					confirm: {label: 'Confirmar',className:'btn_grid btn_cor_padrao'},
					cancel: {label: 'Cancelar',className:'btn-default'},
				},
			}); 
		}

		$scope.validaCodigos = async (numPed) => {

			let validaNumPedidoClic = await $scope.consultaDocumento(numPed)

			if(validaNumPedidoClic != []){
				return false;
			}else{
				return true;
			}

		}

		$scope.atualizaProdutosPedido = async () => {
			/*Quando um novo produto é adicionado a um pedido já existente, irá excluir os antigos e salvar novamente com o novo item.*/
			if($scope.documentosClic != undefined){
				for(i = 0; i < $scope.documentosClic.length; i++){
					await $http.delete('/clicVendas/rest/pedidov2/deleta/'+ $scope.documentosClic[i].id);
				}
			}
		
		}

		$scope.salvarDocumento = async (rotina, situacao) => {
			/*
			Rotinas:
				1 - Salvar (Mantém apenas no ClicVenda)
				2 - Finalizar (Envia o pedido para ERP)

			Situação: 
				Em digitação - EM_DIGITACAO: Primeira etapa do fluxo | É possível editar e adicionar novos produtos ao pedido
				Em análise	 -
			*/
			
			let hashDoc 			= $rootScope.hashDoc == '' ? '_' + Math.random().toString(36).substr(2, 9) : $rootScope.hashDoc;
			let numPedidoClic		= $rootScope.numPedidoClic == '' ?  Math.floor(Math.random() * 87654321) +  Math.floor(Math.random() * 123456789) : $rootScope.numPedidoClic
			
			/*Verifica se o número do pedido já não foi gravado - Numero gerado aleatoriamente.*/
			if($rootScope.numPedidoClic == ''){
				let validaChaves 		=  await $scope.validaCodigos(numPedidoClic);

				if(!validaChaves){
					numPedidoClic = Math.floor(Math.random() * 120360520) +  Math.floor(Math.random() * 620340950)
				}
			}
						
			let id 						= $rootScope.idDocumento;
			let jsonDocs				= [];
			let dados 					= {};
			let erroDadosFormularioProd	= false;
						
			$scope.messageNotific	= '';

			for(i = 0; i < $rootScope.produtos.length; i++){
				/*Adiciona o hash gerado para o pedido no array de produtos*/
				if(situacao == "EM_ANALISE" && ($rootScope.produtos[i].aplicacao == undefined || $rootScope.produtos[i].consumoProdutoKgMes == undefined || $rootScope.produtos[i].dataTestes == undefined)){
					erroDadosFormularioProd = true;
				}

				$rootScope.produtos[i].hashDoc 	= hashDoc;
				switch(situacao){
					case 'EM_DIGITACAO':
						$rootScope.produtos[i].situacao = {nome:"Em digitação", send:situacao}
						break;
					
					case 'EM_ANALISE':
						$rootScope.produtos[i].situacao = {nome:"Em análise", send:situacao}
						break;
					
					case 'EM_REVISAO':
						$rootScope.produtos[i].situacao = {nome:"Em revisão", send:situacao}
						break;

					case 'AM_INTEGRADA':
						$rootScope.produtos[i].situacao = {nome:"Integrado", send:situacao}
						break;
						
					case 'AM_FECHADA':
						$rootScope.produtos[i].situacao = {nome:"Fechado", send:situacao}
						break;
				}
			}

			if(!erroDadosFormularioProd){
				dados.cnpj 				= {id: dadosUserLogado.cId};
			
				jsonDocs = [{
					chave 				: $scope.chave,
					anoFat	  			: $scope.anoFat,
					projeto     		: $scope.projeto,
					uf 					: $scope.uf,
					vendedor			: $scope.usuarioAprovador ? $scope.vendedor : {rId: dadosUserLogado.rId, nome: dadosUserLogado.rNome, rCod:dadosUserLogado.rCod},
					segmento			: $scope.segmento,
					subsegmento 		: $scope.subsegmento,
					bu 					: $scope.bu,
					pedDatEmi			: $scope.pedDatEmi,
					desagr				: $scope.desagr,
					prioridade			: $scope.prioridade,
					conIndent			: $scope.conIndent,
					con2021n			: $scope.con2021n,
					con2022n			: $scope.con2022n,
					conLocal			: $scope.conLocal,
					dataAtu				: $scope.dataAtu,
					potVolAg			: $scope.potVolAg,
					ultVendaTabdin  	: $scope.ultVendaTabdin,
					primVendaTabdin 	: $scope.primVendaTabdin,
					anoPrimVenda		: $scope.anoPrimVenda ,
					statusAcao			: $scope.statusAcao,
					acoes				: $scope.acoes,
					obsOportunidade		: $scope.obsOportunidade,
					histOportunidade	: $scope.histOportunidade,
					
					//Metodos
					sincronizado	: $scope.sincronizado == "DOCUMENTO_SINCRONIZADO" ? "DOCUMENTO_SINCRONIZADO" : "DOCUMENTO_NAO_SINCRONIZADO",
					idDocument		: $rootScope.idDocumento,
					docCtrl			: hashDoc,
					pedNumped		: $scope.pedNumped,	
					numPedidoClic	: numPedidoClic,	
					
					//Produtos
					produtos		: $rootScope.produtos,

					//Cliente
					cliente			: {id: $rootScope.cliente.id ,codExterno: $rootScope.cliente.codExterno , nome: $rootScope.cliente.nome, cpfCnpjFormat: $rootScope.cliente.cpfCnpjFormat},
					
				}];
				
				dados.jsonDocs 		= JSON.stringify(jsonDocs);
				/*Recebe dados e para que sejam feitas as alterações necessarias*/
				var json 			= JSON.parse(dados.jsonDocs);

				let amostrasPedido  = $scope.situacao && ($scope.situacao.send == 'AM_INTEGRADA' || $scope.situacao.send == 'AM_FECHADA') ? json[0].produtos : json[0].produtos[0];

				if(rotina == 2){
					/*Faz o envio dos produtos como um array para o ERP*/
					let produtos = [];
					/* Lista todos os documentos e aplica o filtro pelo HashDoc, caso o documento já exista na base Clic, adiciona os produtos ao pedido que sejam do mesmo HashDoc*/
					
					if(id > 0){
						let allDocs	= $rootScope.listAllDocs.filter(item => item.jsonDocs[0].docCtrl == hashDoc);

						for(i = 0; i < allDocs.length; i++){
							produtos.push(allDocs[i].jsonDocs[0].produtos);		
						}
					}
		
					let sendToERP 			= JSON.parse(dados.jsonDocs);

					$rootScope.documentoERP = await $scope.gravaDocumentoERP(sendToERP[0]);

					if(id > 0){
						sendToERP[0].produtos 	= produtos; /*Array de produtos*/
					}
					
					/*Atualiza numero do pedido*/
					if(!isNaN(parseInt($rootScope.documentoERP))){
						let dataFormat				= new Date();
						json[0].sincronizado    	= "DOCUMENTO_SINCRONIZADO";
						json[0].pedDatEmi			= dataFormat.toLocaleDateString("pt-BR")+" EMI";;
						json[0].pedNumped			= $rootScope.documentoERP;
					}else{
						json[0].sincronizado = "ERRO: "+$rootScope.documentoERP;
						json[0].pedNumped	 = 0;
					}

				};
				if(id > 0 && (amostrasPedido.situacao.send === "AM_FINALIZADA" ||  amostrasPedido.situacao.send === "AM_INTEGRADA")){
				//if(id > 0){
					$rootScope.docsToEdit = $rootScope.listAllDocs.filter(item => item.jsonDocs[0].docCtrl == hashDoc);

					for(j = 0; j < $rootScope.docsToEdit.length; j++){						
						json[0].produtos	= $rootScope.docsToEdit[j].jsonDocs[0].produtos; /*Recebe o produto referente ao documento - Item por pedido*/

						if(rotina == 2 || json[0].produtos.situacao.send == 'AM_INTEGRADA'){
							json[0].produtos.situacao = rotina == 2 ?  {nome:"Integrado", send:"AM_INTEGRADA"} : amostrasPedido.situacao
						}else if(json[0].produtos.situacao.send == 'AM_FECHADA'){
							json[0].produtos.situacao = {nome:"Fechado", send:"AM_FECHADA"}
						}
							
						/*Irá verificar o produto vinculado ao documento e gravar os campos do formulario vinculado ao produto - Manutenção da amostra*/
						if(json[0].produtos.codigoProduto == $scope.codigoProduto){
							
							json[0].produtos.potencial0XCM 	= $scope.potencial0XCM;
							json[0].produtos.consumoAg		= $scope.consumoAg;
							json[0].produtos.cluster		= $scope.cluster,
							json[0].produtos.ofertaUnit		= $scope.ofertaUnit,
							json[0].produtos.dataStatus		= $scope.dataStatus,
							json[0].produtos.justificativa	= $scope.justificativa,
							json[0].produtos.potencial0XCM	= $scope.potencial0XCM, //
							json[0].produtos.chaveCp		= $scope.chaveCp,
							json[0].produtos.identQtd		= $scope.identQtd,
							json[0].produtos.venda			= $scope.venda,
							json[0].produtos.vendaLocalKg	= $scope.vendaLocalKg,
							json[0].produtos.totalFatUSD	= $scope.totalFatUSD,
							json[0].produtos.margemR		= $scope.margemR,
							json[0].produtos.preUSD			= $scope.preUSD,
							json[0].produtos.ofertaData		= $scope.ofertaData,
							json[0].produtos.probFechamento	= $scope.probFechamento,		
							json[0].produtos.consumoAg		= $scope.consumoAg,	//
							json[0].produtos.familia		= $scope.familia,
							json[0].produtos.concorrencia	= $scope.concorrencia,
							json[0].produtos.precoConc		= $scope.precoConc,
							json[0].produtos.mesIniConsumo	= $scope.mesIniConsumo
							json[0].produtos.acoes			= $scope.acoes,
							json[0].produtos.statusAcao		= $scope.statusAcao,
							json[0].produtos.situacaoAmostra= $scope.situacaoAmostra,

							json[0].produtos.anoAmostra			= $scope.anoAmostra,
							json[0].produtos.trimestreAmostra	= $scope.trimestreAmostra

							if(json[0].produtos.situacao.send === "EM_DIGITACAO" || json[0].produtos.situacao.send === "EM_ANALISE" || json[0].produtos.situacao.send === "EM_REVISAO"){
								switch(situacao){
									case 'EM_DIGITACAO':
										json[0].produtos.situacao = {nome:"Em digitação", send:situacao}
										break;
									
									case 'EM_ANALISE':
										json[0].produtos.situacao = {nome:"Em análise", send:situacao}
										break;
									
									case 'EM_REVISAO':
										json[0].produtos.situacao = {nome:"Em revisão", send:situacao}
										break;
								}
							}
						}
						
						dados.jsonDocs 		= JSON.stringify(json); 
						let response 		= await $http.post('/clicVendas/rest/pedidov2/salvar/'+$rootScope.docsToEdit[j].id, dados);
					};

					$scope.messageNotific = 'Registro alterado com sucesso';
					$scope.geraNotificacao($scope.messageNotific, 1200, "success");

				}else{
					if(($scope.novoProdutoAdicionado || id > 0)){
						await $scope.atualizaProdutosPedido()
					}
					// if(($scope.novoProdutoAdicionado || id > 0) && amostrasPedido.situacao.send !=="AM_FECHADA"){
					// 	await $scope.atualizaProdutosPedido()
					// }

					for(i = 0; i < $rootScope.produtos.length; i++){

						/*Grava no base Clic um produto por pedido - Ligados por hashCode*/
						json[0].produtos 		= $rootScope.produtos[i];

						dados.jsonDocs 			= JSON.stringify(json);

						let response 			= await $http.post('/clicVendas/rest/pedidov2/salvar/', dados);
						if(rotina == 1){
							$scope.messageNotific 	= 'Registro inserido com sucesso';
							$scope.geraNotificacao($scope.messageNotific, 1200, "success");
						}
					};
				};
							
				$scope.atualizaTabela();
				$scope.atualizaTabelaCompleta();
				
				$scope.exibeFormulario 		= false;
				$scope.exibeListaDocumentos = true;
			}else{
				$scope.geraNotificacao("Para enviar para análise os campos aplicação, data teste e consumo devem estar preenchidos.", 1500, "warning")
			}

			
		};

		$scope.limparFiltros = () =>{
			$scope.filStatusSituacao	= {nome:"", send:""};
			$scope.filCliente 			= '';
			//$scope.filStatusAmostra		= '';
			$scope.filPrioridade		= '';
			$scope.filProduto			= '';
			$scope.filSegmento			= '';
			$scope.filDataEmissao 		= '';
			$scope.filPesquisaGeral		= '';
			$scope.filSincronizado		= {nome:"", send:""};

			$scope.atualizaTabela();
			$scope.atualizaTabelaCompleta();
		};

		$scope.aplicarFiltros = (valor) => {
			$scope.filStatusSituacao	= $scope.filStatusSituacao;
			$scope.filCliente 			= $scope.filCliente; 	
			//$scope.filStatusAmostra 	= $scope.filStatusAmostra; 		
			$scope.filPrioridade 		= $scope.filPrioridade; 
			$scope.filProduto 			= $scope.filProduto; 		
			$scope.filDataEmissao 		= $scope.filDataEmissao == "" ? ""  : $scope.filDataEmissao.substr(0,2) + "/" + $scope.filDataEmissao.substr(2,2)+ "/" + $scope.filDataEmissao.substr(4,7)+ " EMI";	
			$scope.filSegmento 			= $scope.filSegmento; 
			$scope.filPesquisaGeral		= $scope.filPesquisaGeral;	
			$scope.filSincronizado		= $scope.filSincronizado;	

			$scope.openNav();
		};

		$scope.atualizaTabela = async (modo) =>{

			$scope.dtOptions = DTOptionsBuilder.newOptions()            
			.withOption('ajax', {
				url	: '/clicVendas/rest/pedidov2/lista',
				type	: 'POST',
				data	: function(d) {   
							var param = {idCvTccnpj	: dadosUserLogado.cId};
							var filter = {
								fil1: $scope.filCliente,
								fil2: "",
								fil3: $scope.filPesquisaGeral,
								fil4: dadosUserLogado.rTipoId != 3 ? dadosUserLogado.rNome : "",/*Lista pedidos apenas do representante que o fez*/
								fil5: dadosUserLogado.rTipoId != 3 ? dadosUserLogado.rId : "",/*Lista pedidos apenas do representante que o fez*/
								fil6: $scope.filDataEmissao,
								fil7: $scope.filStatusSituacao.send,
								fil8: $scope.filSegmento,
								fil9: $scope.filSincronizado.send,
								fil10: $scope.filPrioridade,
								fil11: $scope.filProduto

							};
							d.param = param;
							d.filter = filter;
							return JSON.stringify(d);
						},
					dataSrc: function(json) {

						/*Modo 1 - 
							Atualiza tabela com valores do ERP quando o pedido há número
						*/
						if (modo != 1){
							$rootScope.dadosGrid = json.data;

							for(ped of $rootScope.dadosGrid){
								ped.jsonDocs = JSON.parse(ped.jsonDocs);
							};

							if(dadosUserLogado.rTipoId === 3){
								$scope.agruparPedidosAprovador($rootScope.dadosGrid)
							}

							if(!$scope.usuarioAprovador){
								$scope.consultaPedidosERP($rootScope.dadosGrid);
							}

						}	

						return $rootScope.dadosGrid.sort((a) => (a.jsonDocs[0].sincronizado !="DOCUMENTO_SINCRONIZADO" && a.jsonDocs[0].sincronizado !="DOCUMENTO_NAO_SINCRONIZADO") ? -1 : 1);					
					}
				})
					.withDataProp('data')
					.withOption('processing', true)
					.withOption('serverSide', true)
					.withOption('bFilter', false)
					.withOption('searchDelay', 1000)
					.withOption('scrollY', '100%')      
					.withOption('scrollX', '100%')       
					.withPaginationType('full_numbers')            
					.withDisplayLength(20)
					.withDOM('ftrip')
					.withButtons([
				{
					enabled: dadosUserLogado.rTipoId != 3,
					text: 'Novo',
					key: '1',
					className: dadosUserLogado.rTipoId != 3 ? 'btn_grid btn_cor_padrao' : 'btn_grid btn_cor_disabled',
					action: function (e, dt, node, config) {									
						$scope.abreFormulario();					
					}
				},		
				{
					text: 'Filtrar',
					key: '2',
					className: 'btn_grid btn_cor_padrao',
					action: function (e, dt, node, config) {									
						$scope.openNav();					
					}
				},		
				{	
					enabled: dadosUserLogado.rTipoId === 3,
					text: 'Tabela Completa',
					key: '3',
					className: dadosUserLogado.rTipoId === 3 ? 'btn_grid btn_cor_padrao' : 'btn_grid btn_cor_disabled',
					action: function () {									
						$scope.mostraTabelaCompleta();					
					}
				},		
				{
					text: 'Atualizar',
					key: '4',
					className: 'btn_grid btn_cor_padrao',
					action: function () {									
						$scope.atualizaTabela();					
					}
				},								
			]);	


			defPD = {	'jsonDocs[0].numPedidoClic'					:	{i:0, vsbl: true,	tlt: 'Nº Pedido',  		width:''	},
						'jsonDocs[0].pedNumped'						:	{i:1, vsbl: true,	tlt: 'Nº Pedido ERP',	width:''	},
						'jsonDocs[0].produtos.situacaoAmostra.nome'	:	{i:49,  vsbl: true,	tlt: 'Sit. Amostra',	width:''	},
						'jsonDocs[0].cliente.nome'					:	{i:3, vsbl: true,	tlt: 'Cliente',			width:''	},
						'jsonDocs[0].vendedor.nome'					:	{i:4, vsbl: true,	tlt: 'Vendedor',		width:''	},
						'jsonDocs[0].produtos.descricao'    		:	{i:5, vsbl: true,	tlt: 'Produto',			width:''	},
						'jsonDocs[0].produtos.situacao.nome'		:	{i:2, vsbl: true,	tlt: 'Status',			width:''	}
					
				};


			DTDefaultOptions.setLanguageSource('plugins/pt-br.json');
			var montaColunas = [];

			montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '50px').renderWith(function(data, type, row) {
				var btnhtml = '';				
				btnhtml += "<div class='glyphicon glyphicon-edit' style='font-size:1.5em; color:var(--cor_principal);  display:inline-block; vertical-align: middle; cursor:pointer;' title='Editar' ng-click='abreFormulario("+JSON.stringify(row)+")'></div>";
				
				if(!$scope.usuarioAprovador){
					btnhtml += "<div class='glyphicon glyphicon-ban-circle' style='font-size:1.5em; padding-left:4px; color:var(--cor_principal); display:inline-block; vertical-align: middle; cursor:pointer;' title='Cancelar item' ng-click='removerDocumento("+JSON.stringify(row)+")' ></div>";
				}
			
				return btnhtml;
			}));

			angular.forEach(defPD, function(value, key) {
				montaColunas.push(DTColumnBuilder.newColumn(key).withTitle(value.tlt).withOption('visible', value.vsbl).withOption('sortable', false).withOption('sWidth', value.width));
			});

			montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('Sinc.').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '50px').renderWith(function(data, type, row) {
				var btnhtml1 = '';				
				if(row.jsonDocs[0].sincronizado == "DOCUMENTO_NAO_SINCRONIZADO"){
					btnhtml1 += "<div class='glyphicon glyphicon-ok-sign' title='Aguardando finalização' disabled style='font-size:1.5em; color:grey;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}else if(row.jsonDocs[0].sincronizado  === "DOCUMENTO_SINCRONIZADO"){
					btnhtml1 += "<div class='glyphicon glyphicon-ok-sign' title='Pedido sincronizado - Nº"+row.jsonDocs[0].pedNumped+"' style='font-size:1.5em; color:green;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}else if(row.jsonDocs[0].sincronizado != "DOCUMENTO_NAO_SINCRONIZADO" && row.jsonDocs[0].sincronizado != "DOCUMENTO_SINCRONIZADO") {
					btnhtml1 += "<div class='glyphicon glyphicon-exclamation-sign' title='"+row.jsonDocs[0].sincronizado+"' disabled style='font-size:1.5em; color:#D0C84F;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}
				
				return btnhtml1;
			}));

			$scope.dtColumns = montaColunas;
											
			angular.element('#listDocuments').attr('datatable', '');
			$compile(angular.element('#listDocuments'))($scope);

			$scope.dtOptions.withOption('fnRowCallback',
				
				function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
					$compile(nRow)($scope);
			});

		};
			
		$scope.atualizaTabelaCompleta = (modo) =>{

			$scope.dtOptionsFull = DTOptionsBuilder.newOptions()            
			.withOption('ajax', {
				url	: '/clicVendas/rest/pedidov2/lista',
				type	: 'POST',
				data	: function(d) {   
							var param = {idCvTccnpj	: dadosUserLogado.cId};
							var filter = {
								fil1: $scope.filCliente,
								fil2: "",
								fil3: $scope.filPesquisaGeral,
								fil4: dadosUserLogado.rTipoId != 3 ? dadosUserLogado.rNome : "",/*Lista pedidos apenas do representante que o fez*/
								fil5: dadosUserLogado.rTipoId != 3 ? dadosUserLogado.rId : "",/*Lista pedidos apenas do representante que o fez*/
								fil6: $scope.filDataEmissao,
								fil7: $scope.filStatusSituacao.send,
								fil8: $scope.filSegmento,
								fil9: $scope.filSincronizado.send,
								fil10: $scope.filPrioridade,
								fil11: $scope.filProduto
							};
							d.param = param;
							d.filter = filter;
							return JSON.stringify(d);
						},
				dataSrc: function(json) {
						
						if (modo != 1){
							$rootScope.dadosGrid = json.data;

							for(ped of $rootScope.dadosGrid){
								ped.jsonDocs = JSON.parse(ped.jsonDocs);
							};

							if(dadosUserLogado.rTipoId === 3){
								$scope.agruparPedidosAprovador($rootScope.dadosGrid)
							}

							if(!$scope.usuarioAprovador){
								$scope.consultaPedidosERP($rootScope.dadosGrid);
							}
						};			
						
						return $rootScope.dadosGrid.sort((a) => (a.jsonDocs[0].sincronizado !="DOCUMENTO_SINCRONIZADO" && a.jsonDocs[0].sincronizado !="DOCUMENTO_NAO_SINCRONIZADO") ? -1 : 1);				
					}		
				})
					.withDataProp('data')
					.withOption('processing', true)
					.withOption('serverSide', true)
					.withOption('bFilter', false)
					.withOption('searchDelay', 1000)
					.withOption('scrollY', '100%') 
					.withOption('scrollX', '100%')            
					.withPaginationType('full_numbers')            
					.withDisplayLength(20)
					.withDOM('ftrip')
					.withButtons([
				{
					enabled: dadosUserLogado.rTipoId != 3,
					text: 'Novo',
					key: '1',
					className: dadosUserLogado.rTipoId != 3 ? 'btn_grid btn_cor_padrao' : 'btn_grid btn_cor_disabled',
					action: function (e, dt, node, config) {									
						$scope.abreFormulario();					
					}
				},		

				{
					text: 'Filtrar',
					key: '2',
					className: 'btn_grid btn_cor_padrao',
					action: function (e, dt, node, config) {									
						$scope.openNav();				
					}
				},		
				{
					text: 'Tabela Simplificada',
					key: '3',
					className: 'btn_grid btn_cor_padrao',
					action: function () {									
						$scope.mostraTabelaSimplificada();					
					}
				},	
				{
					text: 'Atualizar',
					key: '4',
					className: 'btn_grid btn_cor_padrao',
					action: function () {									
						$scope.atualizaTabelaCompleta();					
					}
				},									
			]);
			
			defPD = {	'jsonDocs[0].numPedidoClic'					:	{i:0, vsbl: true,	tlt: 'Nº Pedido',  				width:'130px'	},
						'jsonDocs[0].pedNumped'						:	{i:1,  vsbl: true,	tlt: 'Nº Pedido ERP',			width:'130px'	},
						'jsonDocs[0].produtos.situacao.nome'		:	{i:20, vsbl: true,	tlt: 'Status',					width:'130px'	},
						'jsonDocs[0].produtos.descricao'			:	{i:4,  vsbl: true,	tlt: 'Produto',					width:'130px'	},
						'jsonDocs[0].produtos.codExterno'    		:	{i:5,  vsbl: true,	tlt: 'Código',					width:'130px'	},
						'jsonDocs[0].cliente.nome'					:	{i:6,  vsbl: true,	tlt: 'Nome Cliente',			width:'350px'	},
						'jsonDocs[0].uf'							:	{i:7,  vsbl: true,	tlt: 'UF',						width:'130px'	},
						'jsonDocs[0].vendedor.nome'					:	{i:8,  vsbl: true,	tlt: 'Vendedor',				width:'130px'	},
						'jsonDocs[0].segmento'						:	{i:9,  vsbl: true,	tlt: 'Segmento',				width:'130px'	},
						'jsonDocs[0].subsegmento'					:	{i:10, vsbl: true,	tlt: 'Subsegmento',				width:'130px'	},
						'jsonDocs[0].bu'							:	{i:11, vsbl: true,	tlt: 'BU',						width:'130px'	},
						'jsonDocs[0].aplicacao'						:	{i:12, vsbl: true,	tlt: 'Aplicação',				width:'130px'	},
						'jsonDocs[0].ano'							:	{i:13, vsbl: true,	tlt: 'Ano',						width:'130px'	},
						'jsonDocs[0].familia'						:	{i:14, vsbl: true,	tlt: 'Família',					width:'130px'	},
						'jsonDocs[0].cluster'						:	{i:15, vsbl: true,	tlt: 'Cluster',					width:'130px'	},
						'jsonDocs[0].descricao'						:	{i:16, vsbl: true,	tlt: 'Descrição',				width:'130px'	},
						'jsonDocs[0].desagr'						:	{i:17, vsbl: true,	tlt: 'Agrupamento Comercial',	width:'130px'	},
						'jsonDocs[0].produtos.quantidade'			:	{i:18, vsbl: true,	tlt: 'Qtd. KG',					width:'130px'	},
						'jsonDocs[0].produtos.dataStatus'			:	{i:19, vsbl: true,	tlt: 'Data Status',				width:'130px'	},
						'jsonDocs[0].produtos.consumoProdutoKgMes'	:	{i:21, vsbl: true,	tlt: 'Consumo',					width:'130px'	},
						'jsonDocs[0].prioridade.nome'				:	{i:22, vsbl: true,	tlt: 'Prioridade',				width:'130px'	},
						'jsonDocs[0].produtos.consumoAg'      		:	{i:24, vsbl: true,	tlt: 'Consumo AG',				width:'130px'	},
						'jsonDocs[0].conIndent'     				:	{i:25, vsbl: true,	tlt: 'Con. indent',				width:'130px'	},
						'jsonDocs[0].con2021n'      				:	{i:26, vsbl: true,	tlt: 'Con. 2021(em nº)',		width:'130px'	},
						'jsonDocs[0].con2022n'      				:	{i:27, vsbl: true,	tlt: 'Con. 2022(em nº)',		width:'130px'	},
						'jsonDocs[0].conLocal'    					:	{i:28, vsbl: true,	tlt: 'Con. local',				width:'130px'	},
						'jsonDocs[0].produtos.probFechamento'  		:	{i:29, vsbl: true,	tlt: '% Prob. Fec.',			width:'130px'	},
						'jsonDocs[0].produtos.concorrencia'    		:	{i:30, vsbl: true,	tlt: 'Concorrência',			width:'130px'	},
						'jsonDocs[0].produtos.acoes'	 			:	{i:31, vsbl: true,	tlt: 'Ações',					width:'130px'	},
						'jsonDocs[0].produtos.statusAcao'			:	{i:32, vsbl: true,	tlt: 'Status Ação',				width:'130px'	},
						'jsonDocs[0].dataAtu'      					:	{i:33, vsbl: true,	tlt: 'Data Atu.',				width:'130px'	},
						'jsonDocs[0].produtos.ofertaData'			:	{i:34, vsbl: true,	tlt: 'Data Oferta',				width:'130px'	},
						'jsonDocs[0].produtos.ofertaUnit'      		:	{i:35, vsbl: true,	tlt: 'Oferta Unitário. (US$)',	width:'130px'	},
						'jsonDocs[0].produtos.potencial0XCM'		:	{i:36, vsbl: true,	tlt: 'Potencial OxCM',			width:'130px'	},
						'jsonDocs[0].produtos.chaveCp'      		:	{i:37, vsbl: true,	tlt: 'Chave CP',				width:'130px'	},
						'jsonDocs[0].produtos.identQtd'     		:	{i:38, vsbl: true,	tlt: 'INDENT Qtde',				width:'130px'	},
						'jsonDocs[0].produtos.venda'				:	{i:39, vsbl: true,	tlt: 'Venda',					width:'130px'	},
						'jsonDocs[0].vendaLocalKg'    				:	{i:40, vsbl: true,	tlt: 'Venda Local (KG)',		width:'130px'	},
						'jsonDocs[0].produtos.ultVendaTabdin'  		:	{i:41, vsbl: true,	tlt: 'ºlt. Venda TABDIN',		width:'130px'	},
						'jsonDocs[0].produtos.primVendaTabdin' 		:	{i:42, vsbl: true,	tlt: '1.a Venda TABDIN',		width:'130px'	},
						'jsonDocs[0].anoPrimVenda'     				:	{i:43, vsbl: true,	tlt: 'ANO 1.a VENDA',			width:'130px'	},
						'jsonDocs[0].produtos.totalFatUSD'      	:	{i:44, vsbl: true,	tlt: 'Tot. Fat. (USD)',			width:'130px'	},
						'jsonDocs[0].produtos.margemR'	      		:	{i:45, vsbl: true,	tlt: 'Margem (R$)',				width:'130px'	},
						'jsonDocs[0].produtos.preUSD'	      		:	{i:46, vsbl: true,	tlt: 'Pre. USD',				width:'130px'	},
						'jsonDocs[0].potVolAg'	      				:	{i:47, vsbl: true,	tlt: 'Pot. Vol. AG',			width:'130px'	},
						'jsonDocs[0].projeto.nome'					:	{i:48,  vsbl: true,	tlt: 'Projeto',					width:'130px'	},
						'jsonDocs[0].produtos.situacaoAmostra.nome'	:	{i:49,  vsbl: true,	tlt: 'Sit. Amostra',			width:'130px'	},
				};
		
			DTDefaultOptions.setLanguageSource('plugins/pt-br.json');
			var montaColunasFull = [];
			
			montaColunasFull.push(DTColumnBuilder.newColumn(null).withTitle('Editar/Exluir').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '125px').renderWith(function(data, type, row) {
				var btnhtml = '';				
				btnhtml += "<div class='glyphicon glyphicon-edit' style='font-size:1.5em; color:var(--cor_principal);  display:inline-block; vertical-align: middle; cursor:pointer;' title='Editar' ng-click='abreFormulario("+JSON.stringify(row)+")'></div>";
				
				if(!$scope.usuarioAprovador){
					btnhtml += "<div class='glyphicon glyphicon-ban-circle' style='font-size:1.5em; padding-left:4px; color:var(--cor_principal); display:inline-block; vertical-align: middle; cursor:pointer;' title='Cancelar item' ng-click='removerDocumento("+JSON.stringify(row)+")' ></div>";
				}
				return btnhtml;
			}));

			montaColunasFull.push(DTColumnBuilder.newColumn(null).withTitle('Sinc.').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '50px').renderWith(function(data, type, row) {
				var btnhtmlSinc = '';				
				if(row.jsonDocs[0].sincronizado == "DOCUMENTO_NAO_SINCRONIZADO"){
					btnhtmlSinc += "<div class='glyphicon glyphicon-ok-sign' title='Aguardando finalização' disabled style='font-size:1.5em; color:grey;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}else if(row.jsonDocs[0].sincronizado  === "DOCUMENTO_SINCRONIZADO"){
					btnhtmlSinc += "<div class='glyphicon glyphicon-ok-sign' title='Pedido sincronizado - Nº"+row.jsonDocs[0].pedNumped+"' style='font-size:1.5em; color:green;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}else if(row.jsonDocs[0].sincronizado != "DOCUMENTO_NAO_SINCRONIZADO" && row.jsonDocs[0].sincronizado != "DOCUMENTO_SINCRONIZADO") {
					btnhtmlSinc += "<div class='glyphicon glyphicon-exclamation-sign' title='"+row.jsonDocs[0].sincronizado+"' disabled style='font-size:1.5em; color:#D0C84F;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}
				
				return btnhtmlSinc;
			}));
			
			angular.forEach(defPD, function(value, key) {
				montaColunasFull.push(DTColumnBuilder.newColumn(key).withTitle(value.tlt).withOption('visible', value.vsbl).withOption('sortable', false).withOption('sWidth', value.width));
			});
			
			$scope.dtColumnsFull = montaColunasFull;
											
			angular.element('#listDocumentsFull').attr('datatable', '');
			$compile(angular.element('#listDocumentsFull'))($scope);

			$scope.dtOptionsFull.withOption('fnRowCallback',
				
				function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
					$compile(nRow)($scope);
			});

		};
		
		$scope.geraNotificacao = (message, time = 1200, tipo = 'light') =>{
			/* Utiliza o Alert Bootstrap
				light   - padrao
				danger 	- aviso erro
				warning	- aviso informativo 
				success - sucesso
			*/
			$rootScope.isLoading = true;
			var dialog = bootbox.dialog({
				message: '<div class="alert alert-'+tipo+' popup"role="alert"><p style="text-center; font-size:1.0em; font-weight:bold; text-align:center; padding:20px;">'+message+'</p></div>',
				closeButton: false
			});
			
			setTimeout(() => {
				dialog.modal('hide');
				$rootScope.isLoading = false;
			}, time);
		};	
			
		$scope.atualizaTabela();
						
		$scope.mostraTabelaCompleta = () => {
			$scope.tabelaCompleta = true;
			$scope.atualizaTabelaCompleta(); 
		};

		$scope.mostraTabelaSimplificada = () =>{
			$scope.tabelaCompleta = false;
			$scope.atualizaTabela();
		};

		$scope.removerDocumento = ($dados) =>{	
			var id = $dados.id;

			if($dados.jsonDocs[0].pedNumped != 0 &&  !isNaN(parseInt($dados.jsonDocs[0].pedNumped))){
				$scope.geraNotificacao("Este pedido já está no ERP, não é possível excluí-lo.", 2500, "warning");
			}else{
				bootbox.confirm({
					message:'<div class="alert alert-light" "role="alert"><p style="text-center; font-size:1.0em; text-align:center; padding:5px;">Confirma a exclusão?</p></div>',
					closeButton: false,
					onHidden: function(e) {
						$scope.atualizaTabela();
						$scope.atualizaTabelaCompleta();
					},
					callback: function(confirmacao){

						if (confirmacao){
							$http.delete('/clicVendas/rest/pedidov2/deleta/'+id); 
							setTimeout(() => {
								$scope.atualizaTabela();
								$scope.atualizaTabelaCompleta();
							}, 250);
						}
					},
					buttons: {
						cancel: {label: 'Cancelar',className:'btn-default'},
						confirm: {label: 'Excluir',className:'btn_grid btn_cor_padrao'},
					},
				}); 
			};
		};

		$scope.openNav = () => {
			if(document.getElementById("mySidebar").style.width =="250px"){
				document.getElementById("mySidebar").style.width = "0";
				document.getElementById("mySidebar").style.height = "0";
				document.getElementById("main").style.marginLeft = "0";
				
				setTimeout(()=>{
					$scope.atualizaTabela();
					$scope.atualizaTabelaCompleta();
				}, 250)
			}else{
				
				document.getElementById("mySidebar").style.width = "250px";
				document.getElementById("mySidebar").style.height = "655px";
				document.getElementById("main").style.marginLeft = "255px";
			};

		};

			
	});
</script> 

</body>

</html>

<style>

:root {
		--cor_principal: #1a6c95;
	}

	.btn_cor_disabled {
		background-color: #C0C0C0  !important;
		border-color: #A9A9A9 !important;
	}

	ul{
		overflow-y: auto; 
		max-height: 420px;
	}

	h5{
		font-weight: bold;
		font-size: 1.0em;
	}
	
	li{
		font-weight: 500;
		font-size: 1.0em;
	}

	.nav-tabs>li.active>a, .nav-tabs>li.active>a:hover, .nav-tabs>li.active>a:focus {
		color: #555;
		cursor: default;
		background-color: #fff;
		border: 2.5px solid #9dadc0;
		border-bottom-color: transparent;
		font-size: 13.5px;
	}

	.nav-tabs>li>a {
		color:rgb(66, 66, 66);
	}

	tr{
		height: 55px;
	}

	th, td, a{
		font-size: 12px;
		white-space: nowrap;
	}

	th{
		background-color: rgb(248, 248, 248);
		border-radius: 2px;
	}

	.dataTables_wrapper .dataTables_info{
		font-size: 12px;
	}

	.table>thead>tr>th {
    	vertical-align: inherit;
	}

	#listDocumentsProdutos {
		border-radius: 4px;
		border-top: 1.5px solid rgb(236, 236, 236);;
	}

	#listDocumentsProdutos tr>th {
   		box-shadow: 4px 7px 7px #ededed;
	}

	#listDocumentsProdutos tr>td {
		font-size: 13px;
    	font-weight: 400;
	}

	#listDocumentsProdutos td, th{
		vertical-align: inherit;
	}

	#listDocumentsProdutos tr:hover{
		background-color: rgb(248, 248, 248);
		border-radius: 8px;
	}


	.header-filtro-tabela{
		background-color: var(--cor_principal);	
		border-radius: 3px; 
		margin-top: -10px; 
		margin-top: -25%; 
		height: 35px; 
		padding:5px
	}
				
	.btn_grid{
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
	}

	.btn_acao_header{
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
		width: 80px;
		height: 35px;
		font-size: 0.88em;
	}

	.btn_cor_padrao {
		background-color: var(--cor_principal) !important;
		border-color: var(--cor_principal) !important; 
	}

	.container{
		flex:1;
		width: -webkit-fill-available;
	}

	.divider{
		border-top: 1px solid rgb(230, 230, 230);
	}
	
	.divider-titulo{
		border-top: 0.8px solid rgb(230, 230, 230);
		height: 50px;
		background-color:#f9f9f9;
		margin-top: 5px;
		box-shadow: 5px 1px 4px grey;
	}

	.spacer{
		margin-top:20px;
	}

	.spacer-input{
		margin-top:10px;
		margin-left:8px;
	}

	.titulo{
		font-size: 14px;
		font-weight: bolder;
	}

	.itens-titulo{
		margin-top:-15px;
	}

	.vcenter {
		display: flex;
		align-items: center;
	}

	#mySidebar {
	  height: 600px; /* 100% Full-height */
	  width: 0; /* 0 width - change this with JavaScript */
	  position: absolute; /* Stay in place */
	  z-index: 1; /* Stay on top */
	  top: 50;
	  left: 50;
	  background-color: rgba(255, 255, 255, 1); 
	  overflow-x: hidden; /* Disable horizontal scroll */
	  padding-top: 60px; /* Place content 60px from the top */
	  transition: 0.2s; /* 0.5 second transition effect to slide in the sidebar */ 
	  box-shadow: 0 5px 5px 0 rgba(0,0,0,0.50);
  
	}

	#mySidebar label {
	  padding: 5px 5px 5px 10px;
	  text-decoration: none;
	  font-size: 14px;
	  color: #000;
	  display: block;
	  transition: 0.2s;
	}
	
	#mySidebar input {
	  padding: 5px 5px 5px 10px;
	  margin-left: 10px;
	}

	.navbar-header, label {
	  display: inline !important
	}
	
	/* When you mouse over the navigation links, change their color */
	#mySidebar a:hover {
	  color: rgb(216, 216, 216);
	}

	/* The button used to open the sidebar */
	.openbtn {
	  font-size: 20px;
	  cursor: pointer;
	  background-color: #111;
	  color: white;
	  padding: 10px 15px;
	  border: none;
	}

	.inputTable{
		outline: 0;
		border-width: 0 0 0.5px;
		border-color: rgb(184, 184, 184);
		width: 50%;
		height: 35px;
		border-style: dashed;
	}

	.inputTable:focus{
		border-color: rgb(0, 0, 0);
		border-style: solid;
	}

	.inputTable:invalid{
		border-style: dashed;
		border-color: rgba(243, 3, 3, 0.568);
	}

	.openbtn:hover {
	  background-color: #444;
	}

	/* Style page content - use this if you want to push the page content to the right when you open the side navigation */
	#main {
	  transition: margin-left .2s; /* If you want a transition effect */
	  padding: 0px;
	  height: 100%;
	}

	.modal-body{
		padding:0;
		margin-top:15%;
	}

	.modal-content{
		margin-top:20%;
		background-color: rgb(247, 247, 247);
		border:0;
	}

	.modal{
		margin-left:-5%;
	}

	.bootbox-body{
		height: 50px;
		font-size: 1.1em;
		text-align: center;
		font-weight: 500;
	}

	.popup{
		height: 100px;
	}

	.modal-backdrop{
		visibility:hidden;
	}

	/* On smaller screens, where height is less than 450px, change the style of the sidenav (less padding and a smaller font size) */
	@media screen and (max-height: 450px) {
	  .sidebar {padding-top: 15px;}
	  .sidebar a {font-size: 18px;}
	}
	</style>