<!DOCTYPE html>  
<html ng-app="appV2">  
<head> 
	<meta charset="utf-8"/>
	<!-- Imports CSS-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" crossorigin="anonymous">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/angular-datatables.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.colVis.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/dataTables.tableTools.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/datatables.bootstrap.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/isteven-multi-select.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/font-awesome/css/all.min.css">
	<link rel="stylesheet" href="https://sistema.clicvenda.com.br/clicVendas/plugins/angCSS/buttons.dataTables.min.css">
	<!-- Imports CSS-->

<!-- View --> 
</head>  
<body>
	<div class="container" ng-controller="MainController">
		
		<!--Primeira pï¿½gina-->
		<div ng-show="exibeListaDocumentos">
		
			<!-- Sidebar Menu FILTRO -->
			<div id="mySidebar" class="sidebar">

				<div class="header-filtro-tabela">
					<p style="text-align: center; color:white; font-weight: 900; ">Filtro<span ng-click="openNav()" style="color: white; margin-left:70%" class="glyphicon glyphicon-minus"></span></p>
				</div>

				<form style="margin-top:5px">
					<div class="form-group">
						<label for="filFornecedores">Pesquisar</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input"  id="filPesquisaGeral" ng-model="filPesquisaGeral" autocomplete="off" aria-describedby=" " placeholder="Digite a palavra chave. Ex: '123'">
					</div>
					<!-- <div class="form-group">
						<label for="filFornecedores">Representante</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input"  id="filRepresentante" ng-model="filRepresentante" aria-describedby=" " placeholder=" ">
					</div> -->
					
					<div class="form-group">
						<label for="filCliente">Cliente</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" id="filCliente" autocomplete="off" ng-model="filCliente" aria-describedby=" " placeholder=" ">
					</div>
																			
					<div class="form-group">
						<label for="filCarteira">Data Emissão</label>
						<input type="text" style="width: 220px;" ui-mask="99/99/9999" class="form-control spacer-input" autocomplete="off" id="filDataEmissao" ng-model="filDataEmissao" aria-describedby=" ">
					</div>

					<div class="form-group">
						<label for="projeto">Sincronização</label>
						<input type="text" style="width: 220px;" class="form-control spacer-input" ng-value="filSincronizado.nome" ng-model="filSincronizado" id="filSincronizado" uib-typeahead="(sincronizado.nome) for sincronizado in getFilScinronizacao($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectFilSincronizacao($item, $model, $label)">
					</div>
									
				</form>

				<div class="text-center" style="height: 50px;">
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-click="aplicarFiltros()"> Buscar </button>
					</div>
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" ng-click="limparFiltros();"> Limpar </button>
					</div>
				</div>

			</div>
			<!--Sidebar Menu FILTRO-->
		
			<!-- Tabela -->
			<div id="main">
				<!-- Tabela Simplificada -->
				<div class="col-sm-12 col-md-12 col-xs-12">
					<table id="listDocuments"  dt-options="dtOptions" dt-columns="dtColumns" dt-instance="dtInstance" class="row-border responsive hover"></table>					
				</div>
			</div>
			<!-- Tabela -->
		
		</div>
		<!--Primeira pï¿½gina-->

		<!-- FORM NOVO DOCUMENTO -->

		<div ng-show="exibeFormulario">
			<!-- Header formulario -->
			<div class="divider-titulo row">
				<div class="spacer titulo vcenter col-sm-12">
					<div class="col-sm-6 itens-titulo">
						<button class="btn btn_acao_header btn_cor_padrao" ng-click="changeView()"><span class="glyphicon glyphicon-menu-left"></span>  Voltar</button>
						<button style="text-align: center; width: 120px;" class="btn btn_acao_header btn_cor_padrao" ng-hide="exibeHistoricos" ng-click="abreHistoricos()"><span class="glyphicon glyphicon-list-alt"></span> Histórico </button>
					</div>

					<div class="col-sm-6">
						<h5 style="margin-top: 0; margin-left:-15%; font-size: 14px;">{{tipoFormulario}}</h5>
					</div>
				</div>			
			</div>
			<!-- Header formulario -->
			
			<!-- Capa do pedido -->
			<div class="row">

				<form name="cadastroPedido">
				
					<div ng-hide="exibeHistoricos" class="col-sm-12 spacer">

						<!-- Informaï¿½ï¿½es resumidas do pedido -->

						<div class="row">
							
							<div ng-show="sincronizado === 'DOCUMENTO_SINCRONIZADO'" class="form-group col-md-12">
								<div style="background-color: #FBFBFB">
									<div class="panel panel-default spacer">
										<div class="panel-heading">Informações do pedido</div>
										<div class="panel-body">
											
											<div class="col-sm-3">
												<h5>Cliente</h5>
												<p>{{frmCliente.nome}}<p>
											</div>
											<div class="col-sm-3">
												<h5>Endereço de entrega</h5>
												<p>{{frmEndEntrega}}</p>
											</div>

											<div class="col-sm-3">
												<h5>Data de emissão</h5>
												<p>{{dataEmissaoFormat}}</p>
											</div>
											<div class="col-sm-3">
												<h5>Previsão de entrega</h5>
												<p>{{dataPrevEntregaFormatada || "Não Informado"}}</p>
											</div>
											<div class="col-sm-3">
												<h5>Condição de pagamento</h5>
												<p>{{condPagamento.desCpg || "Não Informado "}}</p>
											</div>
											<div class="col-sm-3">
												<h5>Forma de pagamento</h5>
												<p>{{formaPagamento.desFpg}}</p>
											</div>
											<div class="col-sm-3">
												<h5>Total</h5>
												<p>{{valorTotal | currency:'R$ '}}</p>
											</div>	
											<div class="col-sm-3">
												<h5>Representante</h5>
												<p>{{representante}}</p>
											</div>

										</div>
									</div>
								</div>
								
								<div style="margin-top: 2%; padding:0;" class="col-sm-12 spacer">
									<table style="margin-top: 1%;" id="tabelaProdutos" class="table">
										<thead>
											<tr>
												<th>Produto</th>
												<th>Quantidade</th>
												<th>Valor und.</th>
												<th>Faixa</th>
												<th>Desc. / Acrésc.</th>
												<th>Total item</th>
											</tr>
										</thead>
										<tbody>
											<tr ng-repeat = "produto in produtos">
												<td>
													<div class="col-sm-12">
														<div ng-show="produto.codVariacao == ''" class='col-sm-1 thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src='/clicvenda/produtos/{{subdomain}}/{{produto.codExterno}}.jpg' onerror='this.src="images/icon/semimagem.png"' style='width: 80px;'></div>
														<div ng-show="produto.codVariacao != ''" class='col-sm-1 thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src='/clicvenda/produtos/{{subdomain}}/{{produto.codExterno}}_{{produto.codVariacao}}.jpg' onerror='this.src="images/icon/semimagem.png"' style='width: 80px;'></div>
														<div class="col-sm-11">{{produto.codExterno}} - {{produto.descricao}} - {{produto.codVariacao}}</div>
													</div>
												</td>
												<td>
													{{produto.quantidade}}
												</td>
												<td>
													{{produto.valorNegociado | currency:'R$'}}
												</td>
												<td>
													{{produto.valorFaixa | currency:'R$'}}
												</td>
												<td>
													<p ng-show="produto.opcaoDescAcresc === 'DESCONTO' && produto.descAcresc != undefined ">- {{produto.descAcresc}}%</p>
													<p ng-show="produto.opcaoDescAcresc === 'ACRESCIMO' && produto.descAcresc != undefined">+ {{produto.descAcresc}}%</p>
													<p ng-show="produto.descAcresc == undefined"></p>
													
												</td>
												<td>
													{{produto.valorTotalItem | currency:'R$ '}}
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>

							<div style="margin-top:-25px" ng-show="sincronizado != 'DOCUMENTO_SINCRONIZADO' "  class="form-group col-md-12">
								
								<div class="col-sm-8 spacer">
									<label for="frmCliente">Cliente <span style="color: red;" ng-show="cadastroPedido.frmCliente.$error.required">*</span></label>
									<div class="input-group spacer">
										<input type="text" ng-model="frmCliente" name="frmCliente" required id="frmCliente" placeholder="Informe o cliente" uib-typeahead="(cliente.nome + ' (' + cliente.codExterno + ')') for cliente in getClienteERP($viewValue)" typeahead-loading="loadingCli" typeahead-no-results="noResultsCli"  typeahead-on-select="onSelectCliente($item, $model, $label)" class="form-control" required="true" autocomplete="off" typeahead-min-length="3" >
										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaCliente()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
								</div>
								
								<div class="col-sm-4 spacer">
									<label for="tipoVenda">Tipo de Venda / Transação <span style="color: red;" ng-show="cadastroPedido.tipoVenda.$error.required">*</span></label>
									<div class="input-group spacer">
										<input type="text" ng-model="tipoVenda" name="tipoVenda" required id="tipoVenda" placeholder="Informe o tipo de Venda / Transação" uib-typeahead="tipven.codExterno + ' - ' + tipven.nome for tipven in getTipoVendaERP($viewValue)" typeahead-loading="loadingTipVen" typeahead-no-results="noResultsTipVen"  typeahead-on-select="onSelectTransacaoERP($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">
										
										<!-- <input type="text" ng-model="condPagamento" name="condPagamento" required id="condPagamento" placeholder="Informe a condiï¿½ï¿½o de pagamento" uib-typeahead="cond.nome for cond in getCondicaoPagamentoERP($viewValue)" typeahead-loading="loadingCond" typeahead-no-results="noResultsCond"  typeahead-on-select="onSelectCond($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0"> -->

										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaTipoVenda()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
								</div>
								
								<div class="col-sm-4 spacer ">
									<label for="predCliente">Pedido / O.C. do Cliente </label>
									<input type="text" placeholder="Número do pedido do cliente" class="form-control spacer" name="predCliente" ng-model="predCliente" id="predCliente">
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="pedMoeda">Moeda </label>
									<input type="text" placeholder="Selecione a moeda" class="form-control spacer" name="pedMoeda" ng-model="pedMoeda" id="pedMoeda">
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="predDatEmi">Data do Pedido</label>
									<input type="text" readonly class="form-control spacer" name="predDatEmi" ng-model="predDatEmi" id="predDatEmi">
								</div>
								
								<div class="col-sm-4 spacer ">
									<label for="representante">Responsável</label>
									<input type="text" readonly class="form-control spacer" ng-model="representante" id="representante">
								</div>
								
								
								<div class="col-sm-6 spacer">
									<label for="transportadora">Transportadora <span style="color: red;" ng-show="cadastroPedido.transportadora.$error.required">*</span></label>
									<div class="input-group spacer">
										<input type="text" ng-model="transportadora" name="transportadora" required id="transportadora" placeholder="Informe a Transportadora" uib-typeahead="transportadora.codExterno + ' - ' + transportadora.nome for transportadora in getTransportadoraERP($viewValue)" typeahead-loading="loadingTransportadora" typeahead-no-results="noResultsTransportadora"  typeahead-on-select="onSelectTransportadoraERP($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">
										
										<!-- <input type="text" ng-model="condPagamento" name="condPagamento" required id="condPagamento" placeholder="Informe a condiï¿½ï¿½o de pagamento" uib-typeahead="cond.nome for cond in getCondicaoPagamentoERP($viewValue)" typeahead-loading="loadingCond" typeahead-no-results="noResultsCond"  typeahead-on-select="onSelectCond($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0"> -->

										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaTransportadora()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
								</div>
								
								<div class="col-sm-6 spacer">
									<label for="redespacho">Redespacho <span style="color: red;" ng-show="cadastroPedido.redespacho.$error.required">*</span></label>
									<div class="input-group spacer">
										<input type="text" ng-model="redespacho" name="redespacho" required id="redespacho" placeholder="Informe o Redespacho" uib-typeahead="redespacho.codExterno + ' - ' + redespacho.nome for redespacho in getTransportadoraERP($viewValue)" typeahead-loading="loadingRedespacho" typeahead-no-results="noResultsRedespacho"  typeahead-on-select="onSelectRedespachoERP($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">
										
										<!-- <input type="text" ng-model="condPagamento" name="condPagamento" required id="condPagamento" placeholder="Informe a condiï¿½ï¿½o de pagamento" uib-typeahead="cond.nome for cond in getCondicaoPagamentoERP($viewValue)" typeahead-loading="loadingCond" typeahead-no-results="noResultsCond"  typeahead-on-select="onSelectCond($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0"> -->

										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaRedespacho()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
								</div>
								
								<div class="col-sm-6 spacer">
									<label for="frmEndEntrega">Endereço de entrega</label>
									<div class="input-group spacer">
										<input type="text" ng-model="frmEndEntrega" name="frmEndEntrega" placeholder="Informe o endereço de entrega" uib-typeahead="ee.EndEnt for ee in getEnderecoEntregaERP($viewValue)" typeahead-loading="loadingEE" typeahead-no-results="noResultsEE"  typeahead-on-select="onSelectEndEnt($item, $model, $label)" class="form-control"  autocomplete="off" typeahead-min-length="0">
										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaEndEnt()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="tipFrete">Tipo de Frete </label>
									<div class="input-group spacer">
										<input class="form-control" ng-value="tipoFrete.nome" uib-typeahead="tipoFrete.id + ' - ' + tipoFrete.nome for tipoFrete in getListaTipoFrete($viewValue)"  autocomplete="off" typeahead-min-length="0" typeahead-on-select="onSelectListaTipoFrete($item, $model, $label)" ng-model="tipoFrete">
									</div>
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="valFrete">Valor do Frete </label>
									<input type="text" placeholder="Informe o valor do frete" class="form-control spacer" name="valFrete" ng-model="valFrete" id="valFrete">
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="prevEntrega">Previsão de entrega </label>
									<input type="text" ui-mask="99/99/9999" model-view-value="true" class="form-control spacer" name="prevEntrega" ng-model="prevEntrega" id="prevEntrega">
								</div>
							
								<div class="col-sm-6 spacer">
									<label for="condPagamento">Condição de pagamento <span style="color: red;" ng-show="cadastroPedido.condPagamento.$error.required">*</span></label>
									<div class="input-group spacer">
										<input type="text" ng-model="condPagamento" name="condPagamento" required id="condPagamento" placeholder="Informe a condição de pagamento" uib-typeahead="cond.codCpg + ' - ' + cond.desCpg for cond in getCondicaoPagamentoERP($viewValue)" typeahead-loading="loadingCond" typeahead-no-results="noResultsCond"  typeahead-on-select="onSelectCond($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">
										
										<!-- <input type="text" ng-model="condPagamento" name="condPagamento" required id="condPagamento" placeholder="Informe a condiï¿½ï¿½o de pagamento" uib-typeahead="cond.nome for cond in getCondicaoPagamentoERP($viewValue)" typeahead-loading="loadingCond" typeahead-no-results="noResultsCond"  typeahead-on-select="onSelectCond($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0"> -->

										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaCondicaoPagamento()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
								</div>
								
								<div class="col-sm-6 spacer">
									<label for="formaPagamento">Forma de pagamento  <span style="color: red;" ng-show="cadastroPedido.formaPagamento.$error.required">*</span></label>
									<div class="input-group spacer">
										<input type="text" ng-model="formaPagamento" name="formaPagamento" required id="formaPagamento" placeholder="Informe a forma de pagamento" uib-typeahead="forma.codFpg + ' - ' + forma.desFpg for forma in getFormasPagamentoERP($viewValue)" typeahead-loading="loadingForma" typeahead-no-results="noResultsForma"  typeahead-on-select="onSelectForma($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">

										<!-- <input type="text" ng-model="formaPagamento" name="formaPagamento" required id="formaPagamento" placeholder="Informe a forma de pagamento" uib-typeahead="forma.nome for forma in getFormasPagamentoERP($viewValue)" typeahead-loading="loadingForma" typeahead-no-results="noResultsForma"  typeahead-on-select="onSelectForma($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0"> -->
										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaFormaPagamento()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
								</div>
								
								
								<div class="col-sm-6 spacer ">
									<label for="opcoes">Opções </label>
									<div class="input-group spacer">
										<form>
											<label class="checkbox-inline">
											  <input type="checkbox" ng-value="true" ng-model="emiteCertificado" id="emiteCertificado" value="emiteCertificado"> Emite Certificado
											</label>
											<label class="checkbox-inline">
											  <input type="checkbox"  ng-value="true" ng-model="emitePPAP" id="emitePPAP" value="emitePPAP"> Emite PPAP
											</label>
											<label class="checkbox-inline">
											  <input type="checkbox"  ng-value="true" ng-model="mantemSaldo" id="mantemSaldo" value="mantemSaldo"> Mantém Saldo
											</label>
											<label class="checkbox-inline">
											  <input type="checkbox"  ng-value="true" ng-model="aceitaParcial" id="aceitaParcial" value="aceitaParcial"> Aceita Recebimento Parcial
											</label>
										</form>
									</div>
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="valMinFat">Valor Mín Faturamento </label>
									<input type="text" placeholder=" " class="form-control spacer" name="valMinFat" ng-model="valMinFat" id="valMinFat">
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="valMinDup">Valor Máximo Duplicata </label>
									<input type="text" placeholder=" " class="form-control spacer" name="valMinDup" ng-model="valMinDup" id="valMinDup">
								</div>
								
								<div class="col-sm-2 spacer ">
									<label for="validade">Validade Orçamento </label>
									<input type="text" placeholder=" " class="form-control spacer" name="validade" ng-model="validade" id="validade">
								</div>
								
								<div class="col-sm-12 spacer">
									<label for="obsPed">Observação</label>
									<textarea class="form-control spacer-input"  ng-model="obsPed" placeholder="Máximo de 250 caracteres" id="obsPed" rows="3"></textarea>
								</div>
								

								<div style="margin-top:1.5%" class="col-sm-12">
									<label class="spacer" for="codPro">Adicionar Produto</label>
									<div class="input-group spacer">
										<input type="text" ng-model="itemProd" name="itemProd" id="itemProd" placeholder="Informe o nome do produto desejado..." uib-typeahead="retorno.codExterno + ' - ' + retorno.nome + ' - ' + retorno.codVariacao  + ' | Tab. Preço - ' + retorno.codTpr for retorno in getProdutosERP($viewValue)" typeahead-loading="loadingProd" typeahead-no-results="noResults"  typeahead-on-select="verificaProduto($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="3" typeahead-template-url="templateAutoCompleteProduto" >
										<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaProduto()"><i class="glyphicon glyphicon-remove"></i></span>
									</div>
									<i ng-show="loadingProd" class="glyphicon glyphicon-refresh"></i>
									<div ng-show="noResults">
										<i class="glyphicon glyphicon-remove"></i> Sem Resultados
									</div>	
								</div>

								<!-- Modal -->
								
								<div class="modal" id="modalProduto">
									<div class="modal-dialog modal-lg" style="margin-top: -150px;">
									
										<div class="modal-content">
											
											<div class="modal-header">
												<label class="modal-title">Adicionar Produto</label>
											</div>
											
											<div class="modal-body" style="margin-top: 0;">
											
												<div class="form-group col-md-12">
													<div class="col-sm-12 spacer">
													
														<div class="col-sm-2 spacer">
															<label>Código</label>	
															<div class="spacer">
																{{itensModal.codExterno}}
															</div>
														</div>	
														
														<div class="col-sm-8 spacer">
															<label>Descrição</label>	
															<div class="spacer">
																{{itensModal.descricao}}
															</div>
														</div>		
														
														<div class="col-sm-2 spacer"> 
															<label>Derivação</label>
															<div class="spacer">
																{{itensModal.codVariacao}}
															</div>
														</div>
														
														<div class="col-sm-2 spacer">
															<label>Quantidade</label>
															<input type="number" step="any" name="quantidadeProduto" min="1" class="inputTable spacer" required ng-value="itensModal.quantidade" id="quantidadeProdutoAdd" ng-model="itensModal.quantidade" ng-change="calcularTotalItem()">
														</div>
													
														<div class="col-sm-1 spacer"> 
															<label>Unidade</label>
															<div class="spacer">
																{{itensModal.unidMedida}} 
															</div>
														</div>
														
														<div class="col-sm-2 spacer"> 
															<label>Preço Tabela</label>
															<div class="spacer">
																{{itensModal.valorNegociado}}
															</div>
														</div>
																		
														<div class="col-sm-5 spacer"> 
															<label>Faixas de preço</label>
															<form>													
																<div class="spacer">
																	<input class="spacer" checked type="radio" name="valorFaixa-{{$index}}" ng-model="itensModal.valorFaixa" ng-value="itensModal.valorFaixa1" ng-click="calcularTotalItem();"> {{itensModal.valorFaixa1 | currency:'R$ '}}
																	<input class="spacer" type="radio" name="valorFaixa-{{$index}}" ng-model="itensModal.valorFaixa" ng-value="itensModal.valorFaixa2" ng-click="calcularTotalItem();"> {{itensModal.valorFaixa2 | currency:'R$ '}}
																	<input class="spacer" type="radio" name="valorFaixa-{{$index}}" ng-model="itensModal.valorFaixa" ng-value="itensModal.valorFaixa3" ng-click="calcularTotalItem();"> {{itensModal.valorFaixa3 | currency:'R$ '}}
																	<input class="spacer" type="radio" name="valorFaixa-{{$index}}" ng-model="itensModal.valorFaixa" ng-value="itensModal.valorFaixa4" ng-click="calcularTotalItem();"> {{itensModal.valorFaixa4 | currency:'R$ '}}
																</div>
															</form>
														</div>
																		
														<div class="col-sm-2 spacer">
															<label>Total Item</label>
																<div class="spacer">
																	{{itensModal.valorTotalItem | currency:'R$ '}}
																</div>
														</div>
														
														
														<div class="col-sm-12"> <!--Informações sobre o Produto -->

															<div class="panel panel-default spacer">

																<div class="panel-heading">Informações sobre o Produto</div>

																<div class="panel-body">
																	
																	<div class="col-sm-6 spacer">
																		<label for="tipoVendaItem">Transação do produto</label>
																		<div class="input-group spacer">
																			<input type="text" ng-model="itensModal.tipoVendaItem" name="tipoVendaItem" id="tipoVendaItem" placeholder="Selecione uma transasão para este item" uib-typeahead="tipven.nome for tipven in getTipoVendaERP($viewValue)" typeahead-loading="loadingTipVen" typeahead-no-results="noResultsTipVen"  typeahead-on-select="onSelectTransacaoPro($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="0">
																			<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaTipoVendaItem()"><i class="glyphicon glyphicon-remove"></i></span>
																		</div>
										
																	</div>
																	<div class="col-sm-6 spacer ">
																		<label for="prevEntregaItem">Data de entrega do item </label>
																		<input type="text"  ui-mask="99/99/9999" class="form-control spacer" name="prevEntregaItem" ng-model="produto.prevEntregaItem" id="prevEntregaItem">
																	</div>
																	<div class="col-sm-12 spacer">
																		<label for="obsItem">Observação</label>
																		<textarea class="form-control spacer-input"  ng-model="itensModal.obsItem" placeholder="Máximo de 250 caracteres" id="obsItem" rows="1"></textarea>
																	</div>		
																</div>
															</div>
														</div>

														<div class="col-sm-12"> <!--Informações adicionais -->

															<div class="panel panel-default spacer">
															  <div class="panel-heading">Informações adicionais</div>
															  <div class="panel-body">
															  
																<div class="col-sm-3 spacer ">
																	<label for="numPedCliItem">Núm. Pedido Cliente </label>
																	<input type="text" placeholder=" " class="form-control spacer" name="numPedCliItem" ng-model="itensModal.numPedCliItem" id="numPedCliItem">
																</div>
																
																<div class="col-sm-3 spacer ">
																	<label for="numPedCliItem">Cód. Produto Cliente </label>
																	<input type="text" placeholder=" " class="form-control spacer" name="codPedCliItem" ng-model="itensModal.codPedCliItem" id="codPedCliItem">
																</div>
															
																<div class="col-sm-3 spacer ">
																	<label for="numPedCliItem">Rev. Produto Cliente </label>
																	<input type="text" placeholder=" " class="form-control spacer" name="revPedCliItem" ng-model="itensModal.revPedCliItem" id="revPedCliItem">
																</div>	
																
																<div class="col-sm-3 spacer ">
																	<label for="numPedCliItem">Seq. Produto Cliente </label>
																	<input type="text" placeholder=" " class="form-control spacer" name="seqPedCliItem" ng-model="itensModal.seqPedCliItem" id="seqPedCliItem">
																</div>	
																
																<div class="col-sm-3 spacer ">
																	<label for="numPedCliItem">Entrega Produto Cliente </label>
																	<input type="text" ui-mask="99/99/9999"  class="form-control spacer" name="entregaProdPedCliItem" ng-model="itensModal.entregaProdPedCliItem" id="entregaProdPedCliItem">
																</div>	
															  </div>
															</div>
														</div>

														<div class="col-sm-12"> <!--Estoque -->
															<div class="panel panel-default spacer">
																<div class="panel-heading">Estoque</div>
																<div class="panel-body">
																	<table id="produto_estoque" class="table">
																		<thead>
																			<tr>
																				<th>Deposito</th>
																				<th>Estoque</th>
																				<th>Reserva</th>
																				<th>Prefatura</th>
																				<th>Disponivel</th>
																			</tr>
																		</thead>
																		<tbody>
																			<tr ng-repeat="deposito in itensModal.depositos">
																				<td>
																					{{deposito.deposito}}
																				</td>
																				<td>
																					{{deposito.estoque}}
																				</td>
																				<td>
																					{{deposito.reserva}}
																				</td>
																				<td>
																					{{deposito.prefatura}}
																				</td>
																				<td>
																					{{deposito.disponivel}}
																				</td>
																			</tr>
																		</tbody>
																	</table>
																</div>
															</div>
														</div>
																		
														<div class="col-sm-12"> <!--Acabamentos -->
															<div class="panel panel-default spacer">
																<div class="panel-heading">Acabamento</div>
																<div class="panel-body">
																	<table id="produto_acabamentos" class="table">
																		<thead>
																			<tr>
																				<th>
																					Código
																				</th>
																				<th>
																					Consignado
																				</th>
																				<th>
																					Derivação
																				</th>
																				<th>
																					Dísponivel
																				</th>
																				<th>
																					Matriz
																				</th>
																				<th>
																					MG
																				</th>
																				<th>
																					Reserva Pedido
																				</th>
																				<th>
																					Reserva Pré Fatura
																				</th>
																			</tr>
																		</thead>
																		<tbody>
																			<tr ng-repeat="acabamento in itensModal.acabamento">
																				<td>
																					{{acabamento.codigo}}
																				</td>
																				<td>
																					{{acabamento.consignado}}
																				</td>
																				<td>
																					{{acabamento.derivacao}}
																				</td>
																				<td>
																					{{acabamento.disponivel}}
																				</td>
																				<td>
																					{{acabamento.matriz}}
																				</td>
																				<td>
																					{{acabamento.mg}}
																				</td>
																				<td>
																					{{acabamento.resPedidos}}
																				</td>
																				<td>
																					{{acabamento.resPreFat}}
																				</td>
																			</tr>
																		</tbody>
																	</table>
																</div>
															</div>
														</div>	
													</div>
												</div>
											</div> <!-- fecha o body do modal-->


									
									<div class="modal-footer">
										<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
										<button type="button" class="btn btn-primary" ng-click="montaListaProduto()">Adicionar</button>
										<button type="button" class="btn btn-primary" ng-click="atualizarProduto()">Salvar</button>
									</div>
									
								</div><!-- /.modal-content -->
							</div><!-- /.modal-dialog -->
						</div><!-- /.modal -->
								
						
						<div style="margin-top:5px" class="form-group col-md-12">
							<div style="padding:0;" class="col-sm-12 spacer">
							
								<table id ="tabelaProdutos" class="table">
									<thead>
										<tr>
											<th>Código</th>
											<th>Descrição</th>
											<th>Quantidade</th>
											<th>Unid. Medida</th>
											<th>Preço Unitário</th>
											<th>Valor total</th>
											<th></th>
										</tr>
									</thead>
									<tbody ng-repeat = "produto in produtos">
										<tr class="parent">

											<div>
												<td>
													<div class="spacer">
														{{produto.codExterno}}
													</div>
												</td>
												
												<td>
													<div class="spacer">
														{{produto.descricao}}
													</div>
												</td>
												
												<td>
													<div class="spacer">
														{{produto.quantidade}}
													</div>
												</td>
												<td>
													<div class="spacer">
														{{produto.unidMedida}}
													</div>
												</td>
												<td>
													<div class="spacer">
														{{produto.valorFaixa | currency:'R$ '}}
													</div>
												</td>	
												<td>
													<div class="spacer">
														{{produto.valorTotalItem | currency:'R$ '}}
													</div>
												</td>
												<td>
													<div class="col-sm-12">
														<div class='glyphicon glyphicon-remove col-sm-6' style='font-size:1.5em; padding-left:4px; color:var(--cor_principal); display:inline-block; vertical-align: middle; cursor:pointer;' title='Remover' ng-click='removerProduto(produto)'></div>
														<div class='glyphicon glyphicon-edit col-sm-6' style='font-size:1.5em; padding-left:4px; color:var(--cor_principal); display:inline-block; vertical-align: middle; cursor:pointer;' title='Editar' ng-click='editarProdutoModal(produto);'></div>
													</div>		
												</td>
											</div>
										</tr>
									</tbody>
								</table>

							</div>

							<div class="col-sm-12 spacer">
								<h5>Total: </h5><h5 id="valorTotalPedido">{{valorTotal | currency:'R$ '}}</h5>
							</div>	
						</div>

					</div>
					
					
					</div>

					<div ng-show="exibeHistoricos" class="col-sm-12">
						<div class="form-row">
							<div class="col-sm-12 spacer">
									<label for="histOportunidade">Histórico</label>
									<textarea readonly class="form-control spacer-input" ng-disabled="inputDesabilitado" ng-model="histOportunidade" id="histOportunidade" rows="10"></textarea>
							</div>
						</div>
						<div class="form-row">
							<div class="col-sm-12 spacer">
								<hr class="divider">
							</div>
						</div>
						<div class="form-row">
							<div class="col-sm-11 spacer">
								<label for="obsOportunidade">Observação</label>
								<textarea class="form-control spacer-input"  ng-model="obsOportunidade" id="obsOportunidade" rows="1"></textarea>
							</div>
							<div class="col-sm-1 spacer" style="padding-top: 30px;">
								<label for="obsOportunidade"> </label>							
								<div class="btn-group">
									<button class="btn btn_grid btn_cor_padrao" ng-disabled="obsOportunidade=='' || obsOportunidade==undefined || isLoading" ng-click="addObservacaoHistorico()"> Incluir </button>
								</div>
							</div>
						</div>
					</div>
				</form>
				
			</div>	

			<!-- Capa do pedido -->
						
			<hr class="divider">
			<!-- Aï¿½ï¿½es sob o formulario -->
			<div class="row spacer">
				<div class="pull-right" style="padding-right: 10px;">
					<div class="btn-group">
						<button class="btn btn_grid btn-success" title="O pedido será finalizado e enviado ao ERP" ng-disabled="produtos.length == 0 || cadastroPedido.$error.required || isLoading" ng-show="pedido == 0 " ng-click="finalizarDocumento()"> Finalizar </button>
					</div>	
					<div class="btn-group">
						<button class="btn" ng-click="changeView()"> Cancelar </button>
					</div>
					<div class="btn-group">
						<button class="btn btn_grid btn_cor_padrao" title="O pedido será salvo. Você ainda poderá editar e finalizar o pedido." ng-disabled="produtos.length == 0 || cadastroPedido.$error.required || isLoading" ng-click="salvarDocumento(1)"> Salvar </button>
					</div>	
				</div>
			</div>
			<!-- Aï¿½ï¿½es sob o formulario -->
			<hr class="divider">	

		</div>

		<div ng-show="exibeConsultaEstoque">
			<!-- Header Consulta estoque -->
			<div class="divider-titulo row">
				<div class="spacer titulo vcenter col-sm-12">
					<div class="col-sm-6 itens-titulo">
						<button class="btn btn_acao_header btn_cor_padrao" ng-click="exibirConsultaEstoque()"><span class="glyphicon glyphicon-menu-left"></span> Voltar</button>
					</div>
					<div class="col-sm-6">
						<h5 style="margin-top: 0; margin-left:-15%; font-size: 14px;">Consulta Estoque</h5>
					</div>
				</div>			
			</div>
			
			<!-- Body -->
			<div class="row spacer">
				<div class="col-sm-12">
					<!-- Conteï¿½do pï¿½gina -->
					
					<div class="panel panel-default">
					  <div class="panel-body">
						<div style="margin-top:1.5%" class="col-sm-12">
							<div class="col-sm-1">
								<label for="codProEst">Produto</label>
							</div>
							<div class="col-sm-11">
								<div class="input-group">
									<input type="text" ng-model="codProEst" name="codProEst"id="codProEst" placeholder="Localize o produto por código, nome ou referência" uib-typeahead="retorno.produto.codErp + ' - ' + retorno.produto.descricao for retorno in getEstoqueProdutoERP($viewValue)" typeahead-loading="loadingEst" typeahead-no-results="noResults"  typeahead-on-select="onSelectDadosEstoque($item, $model, $label)" class="form-control" autocomplete="off" typeahead-min-length="3" >
									<span class="input-group-addon" style="cursor: pointer;" ng-click="limpaProdutoEstoque()"><i class="glyphicon glyphicon-remove"></i></span>
								</div>
							</div>
							<i ng-show="loadingEst" class="glyphicon glyphicon-refresh"></i>
							<div ng-show="noResults">
								<i class="glyphicon glyphicon-remove"></i> Sem Resultados
							</div>	
						</div>
					  </div>
					</div>
					
					
				</div>
				
				<div style="margin-top:5px" ng-show="produtoEstoque != undefined" class="form-group col-md-12">
				
				
					<div class="panel panel-default spacer">
					
						<div class="panel-heading">
							<h3 class="panel-title">{{produtoEstoque.produto.descricao}}</h3>
						</div>
						<div class="panel-body">
							<div class="form-group col-md-4">
								<label class="spacer" for="codProEst">Derivação:</label> {{produtoEstoque.produto.derivacao}}
							</div>
							<div class="form-group col-md-4">
								<label class="spacer" for="codProEst">Preço Bruto:</label> {{produtoEstoque.produto.precoBruto}}
							</div>
							<div class="form-group col-md-4">
								<label class="spacer" for="codProEst"> Peso:</label> {{produtoEstoque.produto.peso}}	
							</div>
							<div class="form-group col-md-4">
								<label class="spacer" for="codProEst">Unidade de Medida:</label> {{produtoEstoque.produto.uniMed}}	
							</div>
							<div class="form-group col-md-4">
								<label class="spacer" for="codProEst">Qtd. Embalagem:</label> {{produtoEstoque.produto.qtdEmb}}	
							</div>
							<div class="form-group col-md-4">
								<label class="spacer" for="codProEst">Código Sapiens:</label> {{produtoEstoque.produto.codErp}}	
							</div>
							<div class="form-group col-md-4">
								<label class="spacer" for="codProEst">Classificação Fiscal:</label> {{produtoEstoque.produto.claFiscal}}	
							</div>
						
							<div style="margin-top:5px" class="form-group col-md-12">
								<div style="padding:0;" class="col-sm-12 spacer">
								
									<div class="panel panel-default">
										<!-- Default panel contents -->
										<div class="panel-heading">Depósitos</div>
										<div class="panel-body">Estoque do produto por depósito</div>

										<!-- Table -->
										<table id ="tabelaDepositos" class="table">
											<thead>
												<tr>
													<th>Depósito</th>
													<th>Estoque</th>
													<th>Res. Pedidos</th>
													<th>Res. Pré-Fatura</th>
													<th>Tot. Disponível</th>
												</tr>
											</thead>
											<tbody>
												<tr ng-repeat = "depositos in produtoEstoque.produto.depositos">
													<div>
														<td>
															{{depositos.deposito}}
														</td>
													</div>
													<div>
														<td>
															{{depositos.estoque}}
														</td>
													</div>
													<div>
														<td>
															{{depositos.reserva}}
														</td>
													</div>
													<div>
														<td>
															{{depositos.prefatura}}
														</td>
													</div>
													<div>
														<td>
															{{depositos.disponivel}}
														</td>
													</div>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
					
							<div style="margin-top:5px" class="form-group col-md-12">
								<div style="padding:0;" class="col-sm-12 spacer">
									
									<div class="panel panel-default">
										<!-- Default panel contents -->
										<div class="panel-heading">Ordens de Produção do Produto</div>
										<div class="panel-body"></div>

										<!-- Table -->
										<table id ="tabelaOrdensProducao" class="table">
											<thead>
												<tr>
													<th>Numero OP</th>
													<th>Emissão</th>
													<th>Prev. Ini</th>
													<th>Prev. Fim</th>
													<th>Realiz. Ini</th>
													<th>Realiz. Fim</th>
													<th>Qtde Prev</th>
													<th>Qtde Realiz</th>
													<th>Saldo</th>
													<th>Situação</th>
												</tr>
											</thead>
											<tbody>
												<tr ng-repeat = "ops in produtoEstoque.produto.ordensProducao">
													<div>
														<td>
															{{ops.numeroOP}}
														</td>
													</div>
													<div>
														<td>
															{{ops.datEmissao}}
														</td>
													</div>
													<div>
														<td>
															{{ops.prevIni}}
														</td>
													</div>
													<div>
														<td>
															{{ops.prevFim}}
														</td>
													</div>
													<div>
														<td>
															{{ops.realizadoIni}}
														</td>
													</div>
													<div>
														<td>
															{{ops.realizadoFim}}
														</td>
													</div>
													<div>
														<td>
															{{ops.qtdPrev}}
														</td>
													</div>
													<div>
														<td>
															{{ops.qtdReal}}
														</td>
													</div>
													<div>
														<td>
															{{ops.saldo}}
														</td>
													</div>
													<div>
														<td>
															{{ops.situacao}}
														</td>
													</div>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
					
							<!-- <div style="margin-top:5px" class="form-group col-md-12"> -->
								<!-- <div style="padding:0;" class="col-sm-12 spacer"> -->
									<!-- <h5>Roteiros da OP {{produtoEstoque.produto.ordensProducao[0].numeroOP}}</h5> -->
									<!-- <table id ="tabelaRoteiroOp" class="table"> -->
										<!-- <thead> -->
											<!-- <tr> -->
												<!-- <th>Estï¿½gio</th> -->
												<!-- <th>Operaï¿½ï¿½o</th> -->
												<!-- <th>Inï¿½cio</th> -->
												<!-- <th>Tï¿½rmino</th> -->
												<!-- <th>Previsto</th> -->
												<!-- <th>Realizado</th> -->
												<!-- <th>Saldo</th> -->
											<!-- </tr> -->
										<!-- </thead> -->
										<!-- <tbody> -->
											<!-- <tr ng-repeat = "roteiro in produtoEstoque.produto.ordensProducao[0].roteiroOp"> -->
												<!-- <div> -->
													<!-- <td> -->
														<!-- {{roteiro.estagio}} -->
													<!-- </td> -->
												<!-- </div> -->
												<!-- <div> -->
													<!-- <td> -->
														<!-- {{roteiro.operacao}} -->
													<!-- </td> -->
												<!-- </div> -->
												<!-- <div> -->
													<!-- <td> -->
														<!-- {{roteiro.inicio}} -->
													<!-- </td> -->
												<!-- </div> -->
												<!-- <div> -->
													<!-- <td> -->
														<!-- {{roteiro.termino}} -->
													<!-- </td> -->
												<!-- </div> -->
												<!-- <div> -->
													<!-- <td> -->
														<!-- {{roteiro.previsto}} -->
													<!-- </td> -->
												<!-- </div> -->
												<!-- <div> -->
													<!-- <td> -->
														<!-- {{roteiro.realizado}} -->
													<!-- </td> -->
												<!-- </div> -->
												<!-- <div> -->
													<!-- <td> -->
														<!-- {{roteiro.saldo}} -->
													<!-- </td> -->
												<!-- </div> -->
											<!-- </tr> -->
										<!-- </tbody> -->
									<!-- </table> -->
								<!-- </div> -->
							<!-- </div> -->
					
							<div style="margin-top:5px" class="form-group col-md-12">
								<div style="padding:0;" class="col-sm-12 spacer">
									<div class="panel panel-default">
										<!-- Default panel contents -->
										<div class="panel-heading">Derivaçôes do Produto
										</div>
										
										<div class="panel-body">
										</div>

										<!-- Table -->
										<table id ="tabelaDerivacoes" class="table">
											<thead>
												<tr>
													<th>Código</th>
													<th>Derivação</th>
													<th>Matriz [04]</th>
													<th>MG [12]</th>
													<th>Consignado</th>
													<th>Res. Pedidos</th>
													<th>Res. Pré-Fat.</th>
													<th>Disponível</th>
												</tr>
											</thead>
											<tbody>
												<tr ng-repeat = "derivacoes in produtoEstoque.produto.derivacoes">
													<div>
														<td>
															<button type="button" class="btn btn-link" ng-click="onClickDerivacao(derivacoes.codigo)">{{derivacoes.codigo}}</button>
														</td>
													</div>
													<div>
														<td>
															{{derivacoes.derivacao}}
														</td>
													</div>
													<div>
														<td>
															{{derivacoes.matriz}}
														</td>
													</div>
													<div>
														<td>
															{{derivacoes.mg}}
														</td>
													</div>
													<div>
														<td>
															{{derivacoes.consignado}}
														</td>
													</div>
													<div>
														<td>
															{{derivacoes.resPedidos}}
														</td>
													</div>
													<div>
														<td>
															{{derivacoes.resPreFat}}
														</td>
													</div>
													<div>
														<td>
															{{derivacoes.disponivel}}
														</td>
													</div>
												</tr>
											</tbody>
											<tfoot>
												<tr>
													<td>Totais</td>
													<td></td>
													<td>{{somaTotalMatriz}}</td>
													<td>{{somaTotalMg}}</td>
													<td>{{somaTotalConsignado}}</td>
													<td>{{somaTotalResPedidos}}</td>
													<td>{{somaTotalResPreFat}}</td>
													<td>{{somaTotalDisponivelDer}}</td>
												</tr>
											</tfoot>
										</table>
									</div>
								</div>
							</div>
							
						</div> <!--  Fecha o panel body principal -->
					</div><!--  Painel que contem todo mundo -->

				</div>

			</div>
	
		</div> 

	<script type="text/ng-template" id="templateAutoCompleteProduto">
		<a>
			<table>
				<tr>
					<td style="padding-right: 25px;">
						<div ng-show="match.model.codVariacao == ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src="/clicvenda/produtos/{{$parent.$parent.$parent.subdomain}}/{{match.model.codExterno}}.jpg" onerror='this.src="images/icon/semimagem.png"' style='width: 64px;'/></div>
						<div ng-show="match.model.codVariacao != ''" class='thumbnail pull-left' style='margin:0'> <img class='media-object' ng-src="/clicvenda/produtos/{{$parent.$parent.$parent.subdomain}}/{{match.model.codExterno}}_{{match.model.codVariacao}}.jpg" onerror='this.src="images/icon/semimagem.png"' style='width: 64px;'/></div>
					</td>			
					<td>
						<div class="row">
							<div class="col-md-12">{{match.model.codExterno}} <b>|</b> {{match.model.nome}} <b>-</b> {{match.model.codVariacao}}</div>				
						</div>
						<div class="row">
							<div class="col-md-12">Estoque: {{match.model.qtdeEstoque}}</div>				
						</div>				
						<div class="row">
							<div class="col-md-12">Preço: {{match.model.preco}}</div>				
						</div>
						<div class="row">
							<div class="col-md-12">Tab. Preço: {{match.model.codTpr}}</div>				
						</div>												
					</td>
				</tr>
			</table>
		</a>
	 </script>
	<!-- View --> 

<!-- Scripts importados -->
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/jquery-3.1.1.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/easytimer.min.js"></script>	
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-route.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-ui-router.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-cookies.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angular-ui-notification/angular-ui-notification.min.js"></script>  
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/ui-bootstrap-tpls-2.5.0.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/dist/jquery.dataTables.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/dist/angular-datatables.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/bootstrap.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.bootstrap.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.factory.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.options.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/dataTables.buttons.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.colVis.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.flash.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.html5.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/buttons.print.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-datatables.buttons.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-locale_pt-br.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/angJS/angular-sanitize.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/fullcalendar-3.10.0/lib/moment.min.js"></script>	
	<script src="https://sistema.clicvenda.com.br/clicVendas/plugins/ui-mask-master/dist/mask.min.js"></script>
<!-- Scripts importados -->	

<script>
	//console.log("testes 188")
var dadosUserLogado = parent.dadosUserLogadoPersonalizado();	

angular
	.module("appV2",['ngRoute', 'ngSanitize', 'ui.bootstrap', 'datatables', 'datatables.buttons', 'ui.mask'])
	.controller("MainController",
	function(DTOptionsBuilder, DTColumnDefBuilder, DTColumnBuilder, DTDefaultOptions, $scope, $rootScope, $compile, $http, $timeout, $window){
		
		$scope.exibeFormulario 		= false; 
		$scope.exibeListaDocumentos = true;
		$scope.exibeHistoricos		= false;
		$scope.exibeConsultaEstoque = false;

		$rootScope.isLoading 		= false;

		$rootScope.subdomain		= dadosUserLogado.cSubdominio;
		
		/* Inicializa filtros */
		$scope.filCliente 			= "";
		$scope.filRepresentante		= "";
		$scope.filDataEmissao 		= "";
		$scope.filPesquisaGeral		= "";
		$scope.filSincronizado		= {nome:"", send:""};

		/*Incializa produtos*/
		$rootScope.produtos 		= [];
		
		/*Incializa cliente*/
		$rootScope.cliente			= {};

		$scope.exibirConsultaEstoque = () =>{
			$scope.exibeListaDocumentos = $scope.exibeListaDocumentos ? false : true
			$scope.exibeConsultaEstoque = $scope.exibeConsultaEstoque ? false : true
			$scope.$applyAsync();
		}

		$scope.consultarEstoqueERP = async () =>{
			
			/*A fazer
				Requisiï¿½ï¿½o para o ERP trazendo as informaï¿½ï¿½es 
			*/
		}
	
		$scope.consultaDocumento = async (hash) => {
			/*Consulta na base ClicVenda - pedidov2*/
			$rootScope.listAllDocs = [];

			let result = await $http({
				method	: 'POST',
				url		: '/clicVendas/rest/pedidov2/consulta',
				data	: {param:{idCvTccnpj : dadosUserLogado.cId, id: hash}}	
			});

			let listAllDocs = result.data.parametros.documentos;

			for(doc of listAllDocs){
				doc.jsonDocs = JSON.parse(doc.jsonDocs);
			}
			$rootScope.listAllDocs = listAllDocs;

			return listAllDocs;
		};

		$rootScope.changeView = ($dados) => {
			if($scope.exibeFormulario == false && !$scope.exibeConsultaEstoque){

				$scope.exibeFormulario = true;
				$scope.exibeListaDocumentos = false;
				
				if($dados == undefined){
					$scope.tipoFormulario = 'Novo';

					$scope.inputDesabilitado  = false;
					$scope.permiteEditar	  = true;
					
					$scope.$apply();

				}else{
					$scope.tipoFormulario = $dados.jsonDocs[0].sincronizado === 'DOCUMENTO_SINCRONIZADO' ? 'Pedido ERP N° '+ $dados.jsonDocs[0].pedido : "Pedido N° "+$dados.id
										
					$scope.inputDesabilitado  = true;
					$scope.permiteEditar	  = false;
				};
				
			}else if($scope.exibeFormulario == true && !$scope.exibeHistoricos){
				$scope.exibeFormulario = false;
				$scope.exibeListaDocumentos = true;
				$scope.atualizaTabela();

			}else if($scope.exibeFormulario == true && $scope.exibeHistoricos){
				$scope.exibeHistoricos = false;
			}
		};

		$scope.abreHistoricos = (acao) => {
			$scope.exibeHistoricos = true;
		};
	
		// <!-- $scope.getEndEntrega = function(val) { -->
		// 	<!-- if(angular.isUndefined($scope.frmCliente) || $scope.frmCliente == ""){ -->
		// 		<!-- $scope.critInfClienteEe = true; -->
		// 	<!-- }else{ -->
		// 		<!-- $scope.critInfClienteEe = false; -->
				
		// 		<!-- return $http({ -->
		// 			<!-- method	: 'GET', -->
		// 			<!-- url		: '/clicVendas/rest/ClienteEndEntrega/enderecosCliente/'+$rootScope.cliente.id, -->
		// 			<!-- params 	: {filtro : val || ''} -->
		// 		<!-- }).then(	 -->
		// 		<!-- function(response) {     -->
		// 			<!-- //Sucesso -->
		// 			<!-- if(response.data.length == 1){				 -->
		// 				<!-- var ee = response.data[0];		 -->
		// 				<!-- $scope.endEntrega = ee; -->
		// 				<!-- $scope.frmEndEntrega = ee.endereco + ', ' + ee.numero + ', ' + ee.bairro + ', ' + ee.cidade + ', ' + ee.uf + ', ' + ee.cep + ', ' + (ee.complemento || ''); -->
		// 			<!-- } -->

		// 			<!-- return response.data.map(function(item){ -->
		// 				<!-- return item; -->
		// 			<!-- }); -->
		// 		<!-- },  -->
		// 		<!-- function(response) {					 -->
		// 		<!-- }); -->
		// 	<!-- } -->
		// <!-- }; -->

		// <!-- $scope.onSelectEE = function ($item, $model, $label) {			 -->
		// 	<!-- $scope.endEntrega = $item;			 -->
		// <!-- }; -->

		// <!-- $scope.limpaEndEntrega = function(){ -->
		// 	<!-- $scope.frmEndEntrega = ""; -->
		// 	<!-- $scope.endEntrega	 = {}; -->
		// <!-- }; -->

		$scope.getListaTipoFrete = () =>{
			$scope.listaTipoFrete = [ 
				{
				    id: 'C',
					nome: 'CIF',
				},
				{
					id: 'F',
					nome: 'FOB',
				},
				{
					id: 'X',
					nome: 'SEM FRETE',
				},
			];
			return $scope.listaTipoFrete;
		};

		$scope.onSelectListaTipoFrete = ($item, $model, $label) => {
			$scope.tipoFrete = $item;
		};

		$scope.getCondicoesP = function(val) {
			return $http.post('/clicVendas/rest/Listas/condicaoPagamento', {
			params: {
				filtro		: val || '',
				idCvTccnpj	: dadosUserLogado.cId 
			}
			}).then(function(response){              
				return response.data.map(function(item){
					return item;
				});
			});
		};

		// condiï¿½ï¿½es de pagamento
		$scope.getCondicaoPagamentoERP = async (consulta) => {
			try{
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'filtrarCondPag',
						pCodCli    : dadosUserLogado.rId,
						pFilter    : {filtro:{filtroCondPag : consulta}},
					}
				);
										
				if(result.resultado != undefined){
					return result.resultado.map((item)=>{
						return item
					})
				}else{
					return [];
				}
			}catch(err){
				console.log("Ocorreu um erro na requisiï¿½ï¿½o: ", err);
			};

		}

		$scope.onSelectCond = function ($item, $model, $label) {		
			$scope.condPagamento = $item;
		};

		$scope.limpaCondicaoPagamento = function(){
			$scope.condPagamento = "";
		}

		// <!-- $scope.getFormasP = function(val) {			 -->
		// 	<!-- if	($scope.condPagamento != null){ -->
		// 		<!-- return $http.post('/clicVendas/rest/Listas/formaPagamento/'+$scope.condPagamento.id, { -->
		// 			<!-- params: { -->
		// 				<!-- filtro: val || '', -->
		// 				<!-- idCvTccnpj	: dadosUserLogado.cId -->
		// 			<!-- } -->
		// 		<!-- }).then(function(response){ -->
		// 			<!-- return response.data.map(function(item){ -->
		// 				<!-- return item; -->
		// 			<!-- }); -->
		// 		<!-- }); -->
		// 	<!-- } else { -->
		// 		<!-- return ""; -->
		// 	<!-- }			 -->
		// <!-- }; -->

		
		// formas de pagamento
		$scope.getFormasPagamentoERP = async (consulta) => {

			try{
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'filtrarFormaPag',
						pCodCli    : dadosUserLogado.rId,
						pFilter    : {filtro:{filtroFormaPag : consulta}},
					}
				);
										
				if(result.resultado != undefined){
					return result.resultado.map((item)=>{
						return item
					})
				}else{
					return [];
				}
			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};

		}
		
		
		//Minha nova funï¿½ï¿½o para obter estoque do produto
		
		$scope.getEstoqueProdutoERP = async (consulta) => {

			try{
				
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'listaEstoqueERP',
						pCodCli    : dadosUserLogado.rId,
						pFilter    : {filtro:{filtroProduto : consulta}},
					}
				);
				
				
				if(result.resultado != undefined){
					return result.resultado.map((item)=>{
						return item
					})
				}else{
					return [];
				}
			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};

		}
		
		// Carrega dados de Estoque 
		
		$scope.onSelectDadosEstoque = ($item) =>{
			//console.log("XXX");
			//console.log($item);
			
			$scope.produtoEstoque = $item;
			$scope.calcularTotalEstoqueDepositos();
			$scope.calcularTotalEstoqueDerivacoes();
			
			//console.log($scope.produtoEstoque);
		}
		
		//Nova funï¿½ï¿½o para calcular os totais de produtos da consulta de estoque
	
		$scope.calcularTotalEstoqueDepositos = () =>{

			let valorEstoque 	= 0;
			let valorReserva 	= 0;
			let valorPrefatura 	= 0;
			let valorDisponivel	= 0;

			for(let i=0; i < $scope.produtoEstoque.produto.depositos.length ; i++){

				if($scope.produtoEstoque.produto.depositos[i].estoque != null ){
					valorEstoque += parseFloat($scope.produtoEstoque.produto.depositos[i].estoque.replace('.',''));
				}

				if($scope.produtoEstoque.produto.depositos[i].reserva != null ){
					valorReserva += parseFloat($scope.produtoEstoque.produto.depositos[i].reserva.replace('.',''));
				}
				
				if($scope.produtoEstoque.produto.depositos[i].prefatura != null ){
					valorPrefatura += parseFloat($scope.produtoEstoque.produto.depositos[i].prefatura.replace('.',''));
				}
			}
			
			//console.log(valorEstoque);
			$scope.somaTotalEstoque = valorEstoque.toFixed(2);
			
			$scope.somaTotalReserva = valorReserva.toFixed(2);
			
			$scope.somaTotalPrefatura = valorPrefatura.toFixed(2);
			
			$scope.somaTotalDisponivel = (parseFloat($scope.somaTotalEstoque) - parseFloat($scope.somaTotalReserva) - parseFloat($scope.somaTotalPrefatura));
			
			$scope.somaTotalDisponivel = $scope.somaTotalDisponivel.toFixed(2);

		}
		
		
		$scope.calcularTotalEstoqueDerivacoes = () =>{

			let valorMatriz 	= 0;
			let valorMg 		= 0;
			let valorConsignado	= 0;
			let valorResPedidos = 0;
			let valorResPreFat	= 0;
			let valorDisponivel	= 0;
			

			for(let i=0; i < $scope.produtoEstoque.produto.derivacoes.length ; i++){

				if($scope.produtoEstoque.produto.derivacoes[i].matriz != null ){
					valorMatriz += parseFloat($scope.produtoEstoque.produto.derivacoes[i].matriz.replace('.',''));
					
				}
				
				if($scope.produtoEstoque.produto.derivacoes[i].mg != null ){
					valorMg += parseFloat($scope.produtoEstoque.produto.derivacoes[i].mg.replace('.',''));
				}
				
				if($scope.produtoEstoque.produto.derivacoes[i].consignado != null ){
					valorConsignado += parseFloat($scope.produtoEstoque.produto.derivacoes[i].consignado.replace('.',''));
				}
				
				if($scope.produtoEstoque.produto.derivacoes[i].resPedidos != null ){
					valorResPedidos += parseFloat($scope.produtoEstoque.produto.derivacoes[i].resPedidos.replace('.',''));
				}
				
				if($scope.produtoEstoque.produto.derivacoes[i].resPreFat != null ){
					valorResPreFat += parseFloat($scope.produtoEstoque.produto.derivacoes[i].resPreFat.replace('.',''));
				}
			}
			

			$scope.somaTotalMatriz 			= valorMatriz.toFixed(2);
			$scope.somaTotalMg 				= valorMg.toFixed(2);
			$scope.somaTotalConsignado 		= valorConsignado.toFixed(2);
			$scope.somaTotalResPedidos 		= valorResPedidos.toFixed(2);
			$scope.somaTotalResPreFat 		= valorResPreFat.toFixed(2);
			
			$scope.somaTotalDisponivelDer = (parseFloat($scope.somaTotalMatriz) + parseFloat($scope.somaTotalMg) + 
											 parseFloat($scope.somaTotalConsignado) + parseFloat($scope.somaTotalResPedidos) +
											 parseFloat($scope.somaTotalResPreFat));
			$scope.somaTotalDisponivelDer = $scope.somaTotalDisponivelDer.toFixed(2);
			

		}
		
		$scope.onClickDerivacao = async function(codDer){
			var cCodProEst		 = angular.element(document.querySelector('#codProEst'));
			
			$timeout(function () {
				cCodProEst.focus();
			}, 200);
			
			// <!-- $scope.codProEst = ''; -->
			// <!-- $scope.codProEst = codDer; -->
			
			let result = await $scope.getEstoqueProdutoERP(codDer);
			console.log('result teste');
			//console.log(result);
			$scope.onSelectDadosEstoque(result[0]);
			
			$scope.codProEst = result[0].produto.codErp + " - " + result[0].produto.descricao;
		}
		
		$scope.limpaProdutoEstoque = function(){
			$scope.codProEst = "";
		}
		

		$scope.onSelectForma = function ($item, $model, $label) {					
			$scope.formaPagamento = $item;			
		};
		
		$scope.limpaFormaPagamento = function(){
			$scope.formaPagamento = "";
		}
		
		// cliente
		// AQUI	
		$scope.getClienteERP = async (consulta) => {

			try{
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'filtrarCliente',
						pCodCli    : dadosUserLogado.rId,
						pFilter    : {filtro:{filtroCliente : consulta}},
					},
					1000
				);
				console.log(result)
		
				if(result != undefined && result.resultado != undefined){
					return result.resultado.map((item)=>{
						//console.log(item);
						return item
					})
				}else{
					return [];
				}
			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};

		}

		$scope.onSelectCliente = function ($item, $model, $label) {	

			$scope.nomeCliente = $item;	
			$rootScope.cliente = $item;	

			$scope.tipoVenda = {codExterno: $scope.nomeCliente.codTns, nome: $scope.nomeCliente.nomeTns};

			if($scope.nomeCliente.codTra == "0"){
				console.log("chegou no if")
				$scope.transportadora = ""
			}else{
				console.log("else")
				$scope.transportadora = {codExterno: $scope.nomeCliente.codTra, nome: $scope.nomeCliente.nomTra};
			}

			$scope.frmEndEntrega = $scope.nomeCliente.endCli;
			$scope.condPagamento = {codCpg: $scope.nomeCliente.codCpg, desCpg: $scope.nomeCliente.desCpg };
			$scope.formaPagamento = {codFpg: $scope.nomeCliente.codFpg, desFpg: $scope.nomeCliente.desFpg };
			$scope.pedMoeda = "01 - Real (R$)";
			$scope.valMinFat = "2.500,00";
			$scope.valMinDup = "1.000,00";
			$scope.validade = "10 dias";
			
		};
		
		$scope.limpaCliente = function(){
			$scope.nomeCliente = "";
			$scope.frmCliente  = "";
		}

		//endereï¿½o de entrega
		$scope.getEnderecoEntregaERP = async (consulta) => {

			try{
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'filtrarEndEnt',
						pCodCli    : $scope.nomeCliente.codExterno,
						pFilter    : {filtro:{filtroEndEnt : consulta}},
					},
					1000
				);
		
				if(result != undefined && result.resultado != undefined){
					return result.resultado.map((item)=>{
						return item
					})
				}else{
					return [];
				}
			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};

		}

		$scope.onSelectEndEnt = function ($item, $model, $label) {					
			$scope.frmEndEntrega = $item;			
		};
		
		$scope.limpaEndEnt = function(){
			$scope.frmEndEntrega = "";
		}
		
		
		//transportadoras
		$scope.getTransportadoraERP = async (consulta) => {

			try{
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'filtrarTransportadora',
						pCodCli    : dadosUserLogado.rId,
						pFilter    : {filtro:{filtroTra : consulta}},
					},
					1000
				);
		
				if(result != undefined && result.resultado != undefined){
					return result.resultado.map((item)=>{
						return item
					})
				}else{
					return [];
				}
			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};

		}

		$scope.onSelectTransportadoraERP = function ($item, $model, $label) {					
			$scope.transportadora = $item;			
		};
		
		$scope.onSelectRedespachoERP = function ($item, $model, $label) {					
			$scope.redespacho = $item;			
		};
		
		//Transações de venda
		$scope.getTipoVendaERP = async (consulta) => {

			try{
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'filtrarTransacao',
						pCodCli    : dadosUserLogado.rId,
						pFilter    : {filtro:{filtroTns : consulta}},
					},
					1000
				);
		
				if(result != undefined && result.resultado != undefined){
					return result.resultado.map((item)=>{
						return item
					})
				}else{
					return [];
				}
			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};

		}

		$scope.onSelectTransacaoERP = function ($item, $model, $label) {					
			$scope.tipoVenda = $item;			
		};
		
		$scope.limpaTipoVenda = function(){
			$scope.tipoVenda = "";
		}
		
		$scope.onSelectTransacaoPro = function ($item, $model, $label) {					
			$scope.tipoVendaItem = $item;			
		};
		
		$scope.limpaTransacaoPro = function(){
			$scope.tipoVendaItem = "";
		}
		
		$scope.limpaTransportadora = function(){
			$scope.transportadora = "";
		}
		
		$scope.limpaRedespacho = function(){
			$scope.redespacho = "";
		}
																
		
		// <!-- $scope.getClientes = function(val) { -->
			
		// 	<!-- var idRep = dadosUserLogado.rId; -->

		// 	<!-- return $http.post('/clicVendas/rest/Listas/cliente', { -->
		// 		<!-- params: { -->
		// 			<!-- filtro: val, -->
		// 			<!-- rId: idRep -->
		// 		<!-- } -->
		// 	<!-- }).then(function(response){ -->
		// 		<!-- return response.data.map(function(item){ -->
		// 			<!-- return item; -->
		// 		<!-- }); -->
		// 	<!-- }); -->
		// <!-- }; -->

		// <!-- $scope.onSelectCli = ($item, $model, $label) => { -->
		// 	<!-- $rootScope.cliente = $item;	 -->
		// 	<!-- $scope.codigoCliente = $rootScope.cliente.codExterno -->

		// 	<!-- $scope.getEndEntrega(); -->
		// <!-- }; -->

		// <!-- $scope.limpaCliente = () =>{ -->
		// 	<!-- $scope.frmCliente 	 = ''; -->
		// 	<!-- $scope.codigoCliente = ''; -->
		// 	<!-- var cCliente		 = angular.element(document.querySelector('#frmCliente')); -->
			
		// 	<!-- $timeout(function () { -->
		// 		<!-- cCliente.focus(); -->
		// 	<!-- }, 200); -->
		// <!-- }; -->

		$scope.getFilScinronizacao = () =>{
			$scope.listaFilSincronizacao = [ 
				{
					nome: 'Não sincronizados',
					send: "DOCUMENTO_NAO_SINCRONIZADO"
				},
				{
					nome: 'Sincronizados',
					send: "DOCUMENTO_SINCRONIZADO"
				},
				{
					nome: 'Falha na sincronização',
					send: 'ERRO: '
				},
			];
			return $scope.listaFilSincronizacao;
		};

		$scope.onSelectFilSincronizacao = ($item, $model, $label) => {
			$scope.filSincronizado	= $item;
		};

		/*Tempo limite para funï¿½ï¿½es*/
		const setAsyncTimeout = (cb, timeout = 0) => new Promise((resolve, reject) => {
			cb(resolve);
			setTimeout(() => reject('A requisição demorou muito para responder, por favor tente novamente mais tarde.'), timeout);
		});

		$scope.executaRequisicaoExterna = async ($json, timeLimit = 15) => {
			console.log($json, 'Requisicao Externa ENTRADA');
			
			try {
				let response;

				await setAsyncTimeout(async done => {		
					response = await $http.post(dadosUserLogado.cContextIntegracao + '/rest/Listas/executarRequisicaoExterna', $json);
					done();/*Aguarda a requisiï¿½ï¿½o - Se estourar o tempo, gera erro.*/
								
				}, timeLimit * 1000); // limite em segundos
			
				console.log(response, "SAIDA Req Ext.");
				return response.data;
			}catch(err){
				console.log(err, "erro")
				$scope.geraNotificacao("Não foi possível se comunicar com o ERP. "+err+"", 5000, 'danger')
				console.error('[Timeout] Não foi possível se comunicar com o ERP.', err);
			};
		};

		$scope.consultaPedidosERP = async () => {
			
			let pedidosGravadosERP 	= $rootScope.dadosGrid.filter(doc => doc && Number(doc.jsonDocs[0].pedido) > 0);
			let consulta 			= [];
			/*Ira consultar com base apenas no numero do pedido*/
			for(i = 0; i < pedidosGravadosERP.length; i++){
				consulta.push(
					{
						numPed: pedidosGravadosERP[i].jsonDocs[0].pedido
					}
				)
			};
			
			let dialog = bootbox.dialog({
				message: '<div class="alert alert-light popup"role="alert"><p style="font-size:1.0em; font-weight:bold; text-align:center;">Sincronizando com o ERP...</p></div>',
				closeButton: false
			});
			$rootScope.isLoading = true;


			let result = await $scope.executaRequisicaoExterna(
				{
					idCvtccnpj 	 : dadosUserLogado.cId,
					numreg	   	 : 750,
					pRotina	   	 : 'listarPedidosERP',
					pCodCli    	 : dadosUserLogado.rId,
					pListaPedido : {lista:{pedidos : consulta}},
				},
				15//limite de espera em segundos
			);

			dialog.modal('hide');
			$rootScope.isLoading = false;
		
			if(result !="" && !isNaN(parseInt(result))){
				for(k = 0; k < pedidosGravadosERP.length; k++){				
					
					let dadosAtualizados = result.resultado.filter(res => res.numped == pedidosGravadosERP[k].jsonDocs[0].pedido);
				
					if(dadosAtualizados && dadosAtualizados.length > 0){
						for(l=0; l < $rootScope.dadosGrid.length; l++){
							/*Verifica -
								Codigo externo - Codigo variacao - Numero pedido ERP*/
							if($rootScope.dadosGrid[l].jsonDocs[0].pedido == pedidosGravadosERP[k].jsonDocs[0].pedido){
								
								/*Itens que serï¿½o atualizados*/							
								/*Atualiza informaï¿½ï¿½es do produto vinculado ao pedido*/
								//pedidosGravadosERP[k].jsonDocs[0].produtos.		= "5"

								continue;
							};
						};
					};
				};
			}
						
			$scope.atualizaTabela(1);/* 1 - Atualiza apenas a view, nï¿½o busca da base de dados */
		};
		
		$scope.gravaDocumentoERP = async ($item) => {
			let produtoToSend = [];

			for(let i = 0; i < $item.produtos.length; i++){
				produtoToSend.push({
					codExterno  		: $item.produtos[i].codExterno,
					codTpr				: $item.produtos[i].codTpr,
					codVariacao			: $item.produtos[i].codVariacao,
					descricao			: $item.produtos[i].descricao,
					estoque				: $item.produtos[i].estoque,
					hashDoc				: $item.produtos[i].hashDoc,
					opcaoDescAcresc		: $item.produtos[i].opcaoDescAcresc,
					precoTabela			: $item.produtos[i].precoTabela,
					prevEntregaItem		: $item.produtos[i].prevEntregaItem,
					quantidade			: $item.produtos[i].quantidade,
					unidMedida			: $item.produtos[i].unidMedida,
					valorFaixa			: $item.produtos[i].valorFaixa,
					valorFaixa1			: $item.produtos[i].valorFaixa1,
					valorFaixa2			: $item.produtos[i].valorFaixa2,
					valorFaixa3			: $item.produtos[i].valorFaixa3,
					valorFaixa4			: $item.produtos[i].valorFaixa4,
					valorNegociado		: $item.produtos[i].valorNegociado,
					valorTotalItem		: $item.produtos[i].valorTotalItem
				})
			}
			$item.produtos = produtoToSend;

			let dialog = bootbox.dialog({
				message: '<div class="alert alert-light popup"role="alert"><p style="font-size:1.0em; font-weight:bold; text-align:center;">Enviando pedido para o ERP...</p></div>',
				closeButton: false
			});
			$rootScope.isLoading = true;

			let result = await $scope.executaRequisicaoExterna(
				{
					idCvtccnpj : dadosUserLogado.cId,
					numreg	   : 750,
					pRotina	   : 'criarPedidoERP',
					pCodCli    : dadosUserLogado.rId,
					pCodRep	   : dadosUserLogado.rCod,
					pDocumento : {documento : $item}
				},
				20//limite tempo		
			);
			$rootScope.isLoading = false;
						
			if(!isNaN(parseInt(result))){
				dialog.modal('hide');
				$scope.geraNotificacao('O pedido '+result+' foi gravado com sucesso no ERP.', 2000, 'success')
			}else{
				let formatText = result != undefined ? result.replace(/[\\"]/g, '').replace(/[''"]/g, "") : " Ocorreu uma falha de comunicação com o ERP. Por favor, tente novamente mais tarde."
				result = formatText
				dialog.modal('hide');
				$scope.geraNotificacao('Houve falha uma ao gravar o pedido no ERP.',2000, 'danger');
			};
							
			return result
		};

		$scope.getProdutosERP = async (consulta) => {
			//data vem do input data de entrega 
			//console.log($scope.prevEntrega)

			//$scope.prevEntrega = $scope.prevEntrega.toLocaleDateString('pt-br')

			try{
				let result = await $scope.executaRequisicaoExterna(
					{
						idCvtccnpj : dadosUserLogado.cId,
						numreg	   : 750,
						pRotina	   : 'filtrarProduto',
						pCodCli    : dadosUserLogado.rId,
						pCliente   : $scope.nomeCliente.codExterno,
						pDatEnt    : $scope.prevEntrega,
						pFilter    : {filtro:{filtroProd : consulta}},
					}
				);
		
				if(result != undefined && result.resultado != undefined){
					return result.resultado.slice(0, 8).map((item)=>{
						return item
					})
				}else{
					return [];
				}				
			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};

		}

		$scope.limpaProduto = (acao) =>{
			$scope.itemProd = '';
			
			var produto		= angular.element(document.querySelector('#itemProd'));
			
			$timeout(function () {
				produto.focus();
			}, 200);

		};

		$scope.abreFormulario = ($dados) =>{

			//var today = new Date();
			//var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();

			//$scope.todayTest = new Date();
			//$scope.dateTest =  $scope.todayTest.getDate() + '/' + ($scope.todayTest.getMonth() + 1) + '/' + $scope.todayTest.getFullYear();
			//console.log($scope.dateTest)

			//$scope.dateTest =   ($scope.todayTest.getMonth() + 1) + '-' +  $scope.todayTest.getDate() + '-' + $scope.todayTest.getFullYear();
			//console.log($scope.dateTest)

			//$scope.dateTeste = new Date($scope.dateTest)
			//console.log($scope.dateTeste)

			//console.log($dados)
			if($dados == undefined){
				$scope.tipoFrete				= '';
				
				$rootScope.idDocumento 			= 0;
				$scope.pedido			 		= 0,
				$rootScope.produtos 			= [];
				$scope.tipoVenda				= "";
				$scope.condPagamento			= '';
				$scope.formaPagamento			= '';

				$scope.frmCliente				= '';
				$scope.codigoCliente			= '';
				$scope.frmEndEntrega			= '';
				$scope.redespacho				= '';
				$scope.predCliente				= '';
				$scope.pedMoeda					= '';

				$scope.predDatEmi				= new Date().toLocaleDateString('pt-br');
				$scope.transportadora			= '';
				$scope.valFrete					= '';
				$scope.valMinFat				= '';
				$scope.valMinDup				= '';
				$scope.validade					= '';
				$scope.obsPed					= '';
				$scope.emiteCertificado			= '';
				$scope.emitePPAP				= '';
				$scope.mantemSaldo				= '';
				$scope.aceitaParcial			= '';

				$scope.tipoFreteCif				= '';
				$scope.tipoFrenteFob			= '';

				$scope.prevEntrega				= new Date().toLocaleDateString('pt-br')
				$scope.codigoProduto			= '';				
				$scope.representante			= dadosUserLogado.rNome;
				$scope.datEmiERP				= '';
				$scope.obsOportunidade			= '';
				$scope.histOportunidade			= '';
				$rootScope.hashDoc				= '';
				$scope.sincronizado				= 'DOCUMENTO_NAO_SINCRONIZADO';
				$scope.dataEmissaoFormat		= '';
				$scope.dataPrevEntregaFormatada	= '';
				// $scope.dataEmissaoErpFormatada	= "";

				$scope.valorTotal				= 0;

			}else{
				
				let docs 					= $dados.jsonDocs[0];

				$rootScope.hashDoc			= docs.docCtrl;
				$rootScope.idDocumento 		= $dados.id;
				$rootScope.cliente			= docs.cliente;
				$scope.condPagamento		= docs.condPagamento;
				$scope.formaPagamento		= docs.formaPagamento;
				$scope.frmCliente			= docs.cliente;
				$scope.codigoCliente		= docs.cliente.codExterno;
				$scope.nomeCliente			= docs.cliente.nome;
				$scope.representante		= docs.representante.nome;
				$scope.prevEntrega			= docs.prevEntrega;
				$scope.datEmiERP			= docs.datEmiERP;
				$scope.dataEmissaoFormat	= docs.datEmiERP != null ? docs.datEmiERP.substr(0,10) : "";
				$scope.obsOportunidade		= '';
				$scope.histOportunidade		= docs.histOportunidade;
				$scope.frmEndEntrega		= docs.endEntrega;
				$scope.pedido				= docs.pedido;
				$scope.sincronizado			= docs.sincronizado;

				$scope.previsaoEntregra		= docs.previsaoEntregra;

				$scope.tipoVenda			= docs.tipoVenda;
				$scope.redespacho			= docs.redespacho;
				$scope.predCliente			= docs.predCliente;
				$scope.pedMoeda				= docs.pedMoeda;
				$scope.predDatEmi			= docs.predDatEmi;
				$scope.transportadora		= docs.transportadora;
				$scope.valFrete				= docs.valFrete;
				$scope.valMinFat			= docs.valMinFat;
				$scope.valMinDup			= docs.valMinDup;
				$scope.validade				= docs.validade;
				$scope.obsPed				= docs.obsPed;
				
				$scope.emiteCertificado		= docs.emiteCertificado;
				$scope.emitePPAP			= docs.emitePPAP;
				$scope.mantemSaldo			= docs.mantemSaldo;
				$scope.aceitaParcial		= docs.aceitaParcial;
				
				$scope.tipoFrete			= docs.tipoFrete;
				
				$scope.valorTotal			= docs.valorTotal;

				/*Informações sobre o produto*/
				$rootScope.produtos			= docs.produtos;
				$scope.codigoProduto		= docs.produtos.codigoProduto;
				$scope.descricao			= docs.produtos.descricao;
				$scope.codExternoProduto	= docs.produtos.codExterno;

				
				$scope.dataPrevEntregaFormatada = $scope.prevEntrega;


				//scope.dataPrevEntregaFormatada = $scope.dataPrevEntregaFormatada != "" ? $scope.dataPrevEntregaFormatada.toLocaleDateString('pt-br') : null;
			};
			
			$rootScope.changeView($dados);
			
		};

		$scope.calcularTotalItem = () => 
		{
			let valorTotalItem 	= 0;
			let ValorFaixa		= 0;

			if(
				($scope.itensModal.quantidade != null && $scope.itensModal.quantidade > 0
				) && $scope.itensModal.valorNegociado != null
			)
			{				
				ValorFaixa	=  parseFloat($scope.itensModal.valorFaixa);
				
				if(ValorFaixa != null && ValorFaixa > 0)
				{
					valorTotalItem 	= parseFloat($scope.itensModal.quantidade) * ValorFaixa;
				}
							
				/*Grava o valor total do item*/
				$scope.itensModal.valorTotalItem = valorTotalItem;
			}
			else
			{
				$scope.geraNotificacao('Informe o valor e quantidade do produto.', 2000, 'warning');
			}
		};
		
		// xcalc
		$scope.calcularProdutos = () =>{

			let valorTotalCalc 	= 0;
			let valorTotalItem 	= 0;
			let descontoAcresc 	= 0;
			let calcDescAcresc	= 0;
			let ValorFaixa		= 0;

			for(let i=0; i < $rootScope.produtos.length; i++){
				
				console.log('calcularProdutos');
				console.log($rootScope.produtos);
				
				if(($rootScope.produtos[i].quantidade != null && $rootScope.produtos[i].quantidade > 0) && $rootScope.produtos[i].valorNegociado != null){

					
					ValorFaixa	=  parseFloat($rootScope.produtos[i].valorFaixa);
					
					
					if(ValorFaixa != null && ValorFaixa > 0){
						valorTotalItem 	= parseFloat($rootScope.produtos[i].quantidade) * ValorFaixa
					}
								
					/*Grava o valor total do item*/
					$rootScope.produtos[i].valorTotalItem = valorTotalItem;

					valorTotalCalc += $rootScope.produtos[i].valorTotalItem		
				}else{
					$scope.geraNotificacao('Informe o valor e quantidade do produto.', 2000, 'warning')
					valorTotalCalc = parseFloat($scope.valorTotal);
				}
			}
			
			$scope.valorTotal = valorTotalCalc.toFixed(2);

			$('#valorTotalPedido').css({'font-weight':'800','color':'black', 'fontSize':'19px', }).fadeOut(400)
			setTimeout(()=>{
				$('#valorTotalPedido').css({'font-weight':'600','color':'#787878', 'fontSize':'17px', }).fadeIn(300)
			}, 350)

		}
		
		$scope.calculoValidacaoProdutoERP = async ($dados) =>{
			
			try{
				// let result = await $scope.executaRequisicaoExterna(
				// 	{
				// 		idCvtccnpj : dadosUserLogado.cId,
				// 		numreg	   : 752,
				// 		pRotina	   : 'calculo',
				// 		pCodCli    : dadosUserLogado.rId,
				// 		filter 	   : {valores : $dados}
				// 	}
				// );

				//return result /*Verdadeiro ou falso para prosseguir inserï¿½ï¿½o do produto*/

				// let result = {
				// 	erro: "O produto X estï¿½ fora da margem de lucro",
				// 	aprovado:false,
				// }

				/*Retorna sempre true - 
					TO DO: Calculo de validaï¿½ï¿½o no ERP
				*/

				result = {
					erro: "",
					aprovado:true,
				}

				$rootScope.pedidoAprovado = {
					erro: result.erro,
					aprovado: result.aprovado
				}

				return $rootScope.pedidoAprovado

			}catch(err){
				console.log("Ocorreu um erro na requisição: ", err);
			};
		}

		$scope.verificaProduto = ($item) =>{
			console.log("entrou no onSelect")
			console.log($item);
			
			if($item.tipoErro == "BLOQUEIA"){
				alert($item.msgErro)
			}else if($item.tipoErro == "AVISA"){
				alert($item.msgErro)
				$scope.adicionarProdutoModal($item)
			}else{
				$scope.adicionarProdutoModal($item)
			}
		}
		
			
		$scope.adicionarProdutoModal = ($item) =>{
			
			$scope.itensModal = {};
			
			$scope.itensModal = {
			
				descricao			: $item.nome,
				codigoProduto		: $item.id,
				codVariacao			: $item.codVariacao,
				codExterno			: $item.codExterno,
				opcaoDescAcresc		: 'DESCONTO',
				quantidade			: 1,
				valorNegociado		: parseFloat($item.preco),
				precoTabela			: $item.preco,
				unidMedida			: $item.unimed,
				estoque				: $item.qtdeEstoque,
				codTpr				: $item.codTpr,
				prevEntregaItem      : $item.datEnt,
				hashDoc				: '',
				valorFaixa1			: parseFloat($item.valorFaixa1),
				valorFaixa2			: parseFloat($item.valorFaixa2),
				valorFaixa3			: parseFloat($item.valorFaixa3),
				valorFaixa4			: parseFloat($item.valorFaixa4),
				acabamento			: $item.acabamento,
				depositos			: $item.depositos
    
			};
			
			
			
			$('#modalProduto').modal('show');
		};
		
		
		// <!--Chama a função que adiciona o produto na lista-->
		$scope.montaListaProduto = () => {
		
		$scope.adicionarProdutoLista($scope.itensModal);
		
		}
		
		
		// <!-- Lista Produtos do pedido -->
		// <!-- Incluir produto na tabela de itens do pedido -->
		
		$scope.adicionarProdutoLista = ($item) =>{
		
					console.log('Item do modal');
					console.log($item);
						
					$rootScope.produtos.unshift(
						{ 
							codigoProduto		: $item.id,
							descricao			: $item.descricao,
							codVariacao			: $item.codVariacao,
							codExterno			: $item.codExterno,
							opcaoDescAcresc		: 'DESCONTO',
							quantidade			: $item.quantidade,
							valorNegociado		: parseFloat($item.valorNegociado),
							precoTabela			: $item.preco,
							unidMedida			: $item.unidMedida,
							estoque				: $item.qtdeEstoque,
							codTpr				: $item.codTpr,
							prevEntregaItem     : $item.datEnt,
							hashDoc				: '',
							valorFaixa			: parseFloat($item.valorFaixa),
							valorFaixa1			: parseFloat($item.valorFaixa1),
							valorFaixa2			: parseFloat($item.valorFaixa2),
							valorFaixa3			: parseFloat($item.valorFaixa3),
							valorFaixa4			: parseFloat($item.valorFaixa4),
							acabamento			: $item.acabamento,
							depositos			: $item.depositos,
							valorTotalItem		: parseFloat($item.valorTotalItem),
						}
					);
					
			var buscaProduto	= angular.element(document.querySelector('#itemProd'));
			$timeout(function () {
				buscaProduto.blur();
				$scope.itemProd = '';
			}, 200);
			
			$scope.calcularProdutos();
		};
		
		
		
		$scope.editarProdutoModal = ($item) => {
			console.log('editando o item');
			console.log($item);
			
			$scope.itensModal = {};
			
			$scope.itensModal = {
			
				descricao			: $item.descricao,
				codigoProduto		: $item.id,
				codVariacao			: $item.codVariacao,
				codExterno			: $item.codExterno,
				opcaoDescAcresc		: 'DESCONTO',
				quantidade			: $item.quantidade,
				valorNegociado		: parseFloat($item.valorNegociado),
				precoTabela			: $item.precoTabela,
				unidMedida			: $item.unidMedida,
				estoque				: $item.qtdeEstoque,
				codTpr				: $item.codTpr,
				prevEntregaItem     : $item.datEnt,
				hashDoc				: '',
				valorFaixa1			: parseFloat($item.valorFaixa1),
				valorFaixa2			: parseFloat($item.valorFaixa2),
				valorFaixa3			: parseFloat($item.valorFaixa3),
				valorFaixa4			: parseFloat($item.valorFaixa4),
				acabamento			: $item.acabamento,
				depositos			: $item.depositos
    
			};
			
			$('#modalProduto').modal('show');
		}
		
		$scope.salvarProduto = ($item) => {
			console.log('SALVANDO O ITEM');
			console.log($item);
		}

		$scope.removerProduto = ($item) => {
			console.log($item.codExterno);
			console.log($item.codVariacao);
			//$rootScope.produtos = $rootScope.produtos.filter(item => item.codExterno !== $item.codExterno && item.codVariacao !== $item.codVariacao);
			$rootScope.produtos = $rootScope.produtos.filter(item => item.codExterno+"_"+item.codVariacao !== $item.codExterno+"_"+$item.codVariacao);

			$scope.calcularProdutos();
		};

		$scope.addObservacaoHistorico = () => {
			/*Data*/
			var dataAtual 	= new Date();

			var horas 		= (dataAtual.getHours()<10?'0':'') + dataAtual.getHours()
			var minutos 	= (dataAtual.getMinutes()<10?'0':'') + dataAtual.getMinutes()

			let strHistorico = [];

			strHistorico.push({
				item: $scope.obsOportunidade
			});

			for(let i = 0; i < strHistorico.length; i++){
				$scope.histOportunidade += `
				
				- Descrição: ${strHistorico[i].item}
				- Registrado em: ${dataAtual.toLocaleDateString('pt-BR')} às ${horas}:${minutos}`
			}
		
			$scope.obsOportunidade = "";
		};

		$scope.finalizarDocumento = () => {
			
			bootbox.confirm({
				message:'<div class="alert alert-light" "role="alert"><p style="text-center; font-size:1.0em; text-align:center; padding:5px;">Confirma a finalização do pedido?</p></div>',
				closeButton: false,
				callback: function(confirmacao){
					if (confirmacao){
						$scope.salvarDocumento(2);
					}
				},
				buttons: {
					confirm: {label: 'Confirmar',className:'btn_grid btn_cor_padrao'},
					cancel: {label: 'Cancelar',className:'btn-default'},
				},
			}); 
		}

		$scope.salvarDocumento = async (rotina) => {
			/*
			Rotinas:
				1 - Salvar (Mantém apenas no ClicVenda)
				2 - Finalizar (Envia o pedido para ERP)
			*/			
			let hashDoc 			= $rootScope.hashDoc == '' ? '_' + Math.random().toString(36).substr(2, 9) : $rootScope.hashDoc;						
			let id 					= $rootScope.idDocumento;
			let jsonDocs			= [];
			let dados 				= {};

			$scope.messageNotific	= '';
			
			dados.cnpj 				= {id: dadosUserLogado.cId};
			//console.log($scope.tipoFrete, "tp")
			jsonDocs = [{
				/*Historico*/
				obsOportunidade	: $scope.obsOportunidade,
				histOportunidade: $scope.histOportunidade,
				
				tipoVenda		: $scope.tipoVenda,
				redespacho		: $scope.redespacho,
				predCliente		: $scope.predCliente,
				pedMoeda		: $scope.pedMoeda,
				predDatEmi		: $scope.predDatEmi,
				transportadora	: $scope.transportadora,
				valMinFat		: $scope.valMinFat,
				valMinDup		: $scope.valMinDup,
				validade		: $scope.validade,
				valFrete		: $scope.valFrete,
				obsPed			: $scope.obsPed,
				//opcaoPedido		: $scope.opcaoPedido,
				emiteCertificado: $scope.emiteCertificado,
				emitePPAP		: $scope.emitePPAP,
				mantemSaldo		: $scope.mantemSaldo,
				aceitaParcial	: $scope.aceitaParcial,

				tipoFrete		: $scope.tipoFrete,

				condPagamento	: $scope.condPagamento,
				formaPagamento	: $scope.formaPagamento,

				endEntrega		: $scope.frmEndEntrega,
				prevEntrega		: $scope.prevEntrega != "" || $scope.prevEntrega != undefined ? $scope.prevEntrega : null,
				
				//Metodos
				docCtrl			: hashDoc,
				pedido			: $scope.pedido,
				sincronizado	: $scope.sincronizado == "DOCUMENTO_SINCRONIZADO" ? "DOCUMENTO_SINCRONIZADO" : "DOCUMENTO_NAO_SINCRONIZADO",
				
				representante	: {rId: dadosUserLogado.rId, nome: dadosUserLogado.rNome},

				datEmiERP		: $scope.datEmiERP,
				
				//Produtos
				produtos		: $rootScope.produtos,
				valorTotal		: parseFloat($scope.valorTotal),

				//Cliente
				cliente			: {id: $rootScope.cliente.id ,codExterno: $rootScope.cliente.codExterno , nome: $rootScope.cliente.nome, cpfCnpjFormat: $rootScope.cliente.cpfCnpjFormat},
				
			}];
			
			dados.jsonDocs 		= JSON.stringify(jsonDocs);
			/*Recebe dados e para que sejam feitas as alteraï¿½ï¿½es necessarias*/
			var json 			= JSON.parse(dados.jsonDocs);
			
			if(rotina == 2){					
				let sendToERP 				= JSON.parse(dados.jsonDocs);

				console.log(sendToERP)

				$rootScope.pedidoAprovado	= await $scope.calculoValidacaoProdutoERP(sendToERP[0]);

				if(!$rootScope.pedidoAprovado.aprovado){
					$scope.geraNotificacao("O pedido não foi aprovado: "+$rootScope.pedidoAprovado.erro, 2500, 'warning')
					json[0].sincronizado = "ERRO: "+$rootScope.pedidoAprovado.erro;
					json[0].pedido		 = 0;
				}else{
					$rootScope.documentoERP 	= await $scope.gravaDocumentoERP(sendToERP[0]);
				
					/*Atualiza numero do pedido*/
					if(!isNaN(parseInt($rootScope.documentoERP))){
						let dataFormat			= new Date();
						json[0].sincronizado	= "DOCUMENTO_SINCRONIZADO";
						json[0].datEmiERP		= dataFormat.toLocaleDateString("pt-BR")+" EMI";
						json[0].pedido			= $rootScope.documentoERP;
					}else{
						json[0].sincronizado = "ERRO: "+$rootScope.documentoERP;
						json[0].pedido		 = 0;
					}
				}
			};
	
			if(id > 0){
				dados.jsonDocs 	= JSON.stringify(json); 
				let response 	= await $http.post('/clicVendas/rest/pedidov2/salvar/'+id, dados);
				
				if(rotina == 1){
					$scope.messageNotific = 'Registro alterado com sucesso';
					$scope.geraNotificacao($scope.messageNotific, 1500, 'success');
				}
			}else{
				dados.jsonDocs 			= JSON.stringify(json);
				let response 			= await $http.post('/clicVendas/rest/pedidov2/salvar/', dados);

				if(rotina == 1){
					$scope.messageNotific 	= 'Registro inserido com sucesso';
					$scope.geraNotificacao($scope.messageNotific, 1500, 'success');
				}
				
			};
			
			$scope.atualizaTabela();
						
			$scope.exibeFormulario 		= false;
			$scope.exibeListaDocumentos = true;
		};

		$scope.limparFiltros = () =>{
			
			$scope.filCliente 			= '';
			$scope.filRepresentante		= '';
			$scope.filDataEmissao 		= '';
			$scope.filPesquisaGeral		= '';
			$scope.filSincronizado		= {nome:"", send:""};
			
			$scope.atualizaTabela();
		};

		$scope.aplicarFiltros = (valor) => {
			
			$scope.filDataEmissao		= $scope.filDataEmissao == "" ? ""  : $scope.filDataEmissao.substr(0,2) + "/" + $scope.filDataEmissao.substr(2,2)+ "/" + $scope.filDataEmissao.substr(4,7)+" EMI";
			$scope.filCliente 			= $scope.filCliente; 		
			$scope.filRepresentante		= $scope.filRepresentante;
			$scope.filPesquisaGeral		= $scope.filPesquisaGeral;	
			$scope.filSincronizado		= $scope.filSincronizado;	

			$scope.openNav();
		};
	
		$scope.atualizaTabela = async (modo) =>{
			$scope.dtOptions = DTOptionsBuilder.newOptions()            
			.withOption('ajax', {
				url	: '/clicVendas/rest/pedidov2/lista',
				type	: 'POST',
				data	: function(d) {   
							var param = {idCvTccnpj	: dadosUserLogado.cId};
							var filter = {
								fil1:  $scope.filCliente.toUpperCase(),
								fil2:  $scope.filRepresentante,
								fil3:  $scope.filPesquisaGeral,
								fil4:  $scope.filSincronizado.send,
								fil5:  "",
								fil6:  $scope.filDataEmissao,
								fil7:  dadosUserLogado.rId, /*Lista pedidos apenas do representante que o fez*/
								fil8:  dadosUserLogado.rNome,/*Lista pedidos apenas do representante que o fez*/
								fil9:  "",
								fil10: "",
								fil11: ""
							};
							d.param = param;
							d.filter = filter;
							return JSON.stringify(d);
						},
					dataSrc: function(json) {

						/*Modo 1 - 
							Atualiza tabela com valores do ERP quando o pedido hï¿½ nï¿½mero
						*/
						if (modo != 1){
							$rootScope.dadosGrid = json.data;

							for(ped of $rootScope.dadosGrid){
								ped.jsonDocs  = JSON.parse(ped.jsonDocs);
							};

							$scope.consultaPedidosERP($rootScope.dadosGrid);
						}	

						return $rootScope.dadosGrid.sort((a) => (a.jsonDocs[0].sincronizado !="DOCUMENTO_SINCRONIZADO" && a.jsonDocs[0].sincronizado !="DOCUMENTO_NAO_SINCRONIZADO") ? -1 : 1);				
					}
				})
					.withDataProp('data')
					.withOption('processing', true)
					.withOption('serverSide', true)
					.withOption('bFilter', false)
					.withOption('searchDelay', 1000)
					.withOption('scrollY', '100%')
					.withPaginationType('full_numbers')            
					.withDisplayLength(20)
					.withDOM('ftrip')
					.withButtons([
				{
					text: 'Novo',
					key: '1',
					className: 'btn_grid btn_cor_padrao',
					action: function (e, dt, node, config) {									
						$scope.abreFormulario();					
					}
				},		
				{
					text: 'Filtrar',
					key: '2',
					className: 'btn_grid btn_cor_padrao',
					action: function (e, dt, node, config) {									
						$scope.openNav();				
					}
				},			
				{
					text: 'Atualizar',
					key: '4',
					className: 'btn_grid btn_cor_padrao',
					action: function () {									
						$scope.atualizaTabela();					
					}
				},
				{
					text: 'Consultar Estoque',
					key: '5',
					className: 'btn_grid btn_cor_padrao',
					action: function () {									
						$scope.exibirConsultaEstoque();
					}
				},				
			]);	


			defPD = {	'id'								:	{i:0, vsbl: true,	tlt: 'N° Pedido',   	width:''	},
						'jsonDocs[0].pedido'				:	{i:1, vsbl: true,	tlt: 'N° Pedido ERP',	width:''	},
						'jsonDocs[0].cliente.nome'			:	{i:1, vsbl: true,	tlt: 'Cliente',			width:''	},
				};


			DTDefaultOptions.setLanguageSource('plugins/pt-br.json');
			var montaColunas = [];

			angular.forEach(defPD, function(value, key) {
				montaColunas.push(DTColumnBuilder.newColumn(key).withTitle(value.tlt).withOption('visible', value.vsbl).withOption('sortable', false).withOption('sWidth', value.width));
			});

			montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('Data emissão').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '150px').renderWith(function(data, type, row) {
				var btnhtmlData 	  = '';

				let dataFormat= row.jsonDocs[0].datEmiERP != undefined ? row.jsonDocs[0].datEmiERP.substr(0,10) : ""

				btnhtmlData += "<div style='font-size:1.0em; color:black;  display:inline-block; vertical-align: middle; cursor:pointer;'>"+dataFormat+"</div>";
							
				return btnhtmlData;
			}));

			montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('Valor Total').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '150px').renderWith(function(data, type, row) {
				var btnhtmlValor = '';
				let formatedValue = row.jsonDocs[0].valorTotal!="" ? row.jsonDocs[0].valorTotal.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}) : ""

				btnhtmlValor += "<div style='font-size:1.0em; color:black;  display:inline-block; vertical-align: middle; cursor:pointer;'>"+formatedValue+"</div>";
							
				return btnhtmlValor;
			}));
			
			montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('Sinc.').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '50px').renderWith(function(data, type, row) {
				var btnhtml1 = '';				
				if(row.jsonDocs[0].sincronizado == "DOCUMENTO_NAO_SINCRONIZADO"){
					btnhtml1 += "<div class='glyphicon glyphicon-ok-sign' title='Aguardando finalização' disabled style='font-size:1.5em; color:grey;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}else if(row.jsonDocs[0].sincronizado  === "DOCUMENTO_SINCRONIZADO"){
					btnhtml1 += "<div class='glyphicon glyphicon-ok-sign' title='Pedido sincronizado - N°"+row.jsonDocs[0].pedido+"' style='font-size:1.5em; color:green;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}else if(row.jsonDocs[0].sincronizado != "DOCUMENTO_NAO_SINCRONIZADO" && row.jsonDocs[0].sincronizado != "DOCUMENTO_SINCRONIZADO") {
					btnhtml1 += "<div class='glyphicon glyphicon-exclamation-sign' title='"+row.jsonDocs[0].sincronizado+"' disabled style='font-size:1.5em; color:#D0C84F;  display:inline-block; vertical-align: middle; cursor:pointer;'></div>";
				}
				
				return btnhtml1;
			}));

			montaColunas.push(DTColumnBuilder.newColumn(null).withTitle('').withOption('sortable', false).withClass('colBtn').withOption('sWidth', '50px').renderWith(function(data, type, row) {
				var btnhtml = '';				
				btnhtml += "<div class='glyphicon glyphicon-edit' style='font-size:1.5em; color:var(--cor_principal);  display:inline-block; vertical-align: middle; cursor:pointer;' title='Editar' ng-click='abreFormulario("+JSON.stringify(row)+")'></div>";
				btnhtml += "<div class='glyphicon glyphicon-ban-circle' style='font-size:1.5em; padding-left:4px; color:var(--cor_principal); display:inline-block; vertical-align: middle; cursor:pointer;' title='Cancelar item' ng-click='removerDocumento("+JSON.stringify(row)+")' ></div>";
				return btnhtml;
			}));

			$scope.dtColumns = montaColunas;
											
			angular.element('#listDocuments').attr('datatable', '');
			$compile(angular.element('#listDocuments'))($scope);

			$scope.dtOptions.withOption('fnRowCallback',
				
			function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
				$compile(nRow)($scope);
			});

		};

		$scope.atualizaTabela();

		$scope.geraNotificacao = (message, time = 1200, tipo = 'light') =>{
			/* Utiliza o Alert Bootstrap
				light   - padrao
				danger 	- aviso erro
				warning	- aviso informativo 
				success - sucesso
			*/
			$rootScope.isLoading = true;

			var dialog = bootbox.dialog({
				message: '<div class="alert alert-'+tipo+' popup"role="alert"><p style="text-center; font-size:1.0em; font-weight:bold; text-align:center; padding:20px;">'+message+'</p></div>',
				closeButton: false
			});
			
			setTimeout(() => {
				dialog.modal('hide');
				$rootScope.isLoading = false;
			}, time);
		};	
		
		$scope.removerDocumento = ($dados) =>{	
			var id = $dados.id;

			if($dados.jsonDocs[0].pedido != 0 &&  !isNaN(parseInt($dados.jsonDocs[0].pedido))){
				$scope.geraNotificacao("Este pedido já está no ERP, não é possível excluí-lo.", 2500, 'warning');
			}else{
				bootbox.confirm({
					message:'<div class="alert alert-light" "role="alert"><p style="text-center; font-size:1.0em; text-align:center; padding:5px;">Confirma a exclusão do pedido?</p></div>',
					closeButton: false,
					onHidden: function(e) {
						$scope.atualizaTabela();
					},
					callback: function(confirmacao){

						if (confirmacao){
							$http.delete('/clicVendas/rest/pedidov2/deleta/'+id); 
							setTimeout(() => {
								$scope.atualizaTabela();
							}, 1500);
						}
					},
					buttons: {
						confirm: {label: 'Confirmar',className:'btn_grid btn_cor_padrao'},
						cancel: {label: 'Cancelar',className:'btn-default'},
					},
				}); 
			};
		};

		$scope.openNav = () => {
			if(document.getElementById("mySidebar").style.width =="250px"){
				document.getElementById("mySidebar").style.width = "0";
				document.getElementById("mySidebar").style.height = "0";
				document.getElementById("main").style.marginLeft = "0";
				
				setTimeout(()=>{
					$scope.atualizaTabela()
				}, 250)
			}else{
				
				document.getElementById("mySidebar").style.width = "250px";
				document.getElementById("mySidebar").style.height = "500px";
				document.getElementById("main").style.marginLeft = "255px";
			};

		};

		
		/*Tabela produtos - Abre \ fecha dados complementares*/
		$('table').on('click', 'tr.parent .glyphicon-chevron-down', function(){
			$(this).closest('tbody').toggleClass('open');
		});
			
	});
</script> 

</body>

</html>

<style>

:root {
		--cor_principal: #1a6c95;
	}

	ul{
		overflow-y: auto; 
		max-height: 420px;
	}

	h5{
		font-weight: bold;
		font-size: 1.1em;
		color:#747474;
	}

	p{
		font-size: 13px;
    	font-weight: 400;
	}

	tr{
		height: 45px;
	}

	.table>thead>tr>th {
    	vertical-align: inherit;
	}

	#tabelaProdutos {
		border-radius: 4px;
		border-top: 1.5px solid rgb(236, 236, 236);;
	}

	#tabelaProdutos tr>th {
   		box-shadow: 4px 7px 7px #ededed;
	}

	#tabelaProdutos tr>td {
		font-size: 13px;
    	font-weight: 400;
	}

	#tabelaProdutos td, th{
		vertical-align: inherit;
	}

	#tabelaProdutos tr:hover{
		background-color: rgb(248, 248, 248);
		border-radius: 8px;
	}

	th, td, a{
		font-size: 12px;
		white-space: nowrap;
		padding-right: 6vh;
		padding-left: 2vh
	}

	.thLarge{
		padding-right: 33vh;

	}

	th{
		background-color: #FAFAFA;
		border-radius: 2px;
		padding-right: 17vh;
	}

	.dataTables_wrapper .dataTables_info{
		font-size: 12px;
	}

	.dataTables {
		border-bottom:0;
	}

	.header-filtro-tabela{
		background-color: var(--cor_principal);	
		border-radius: 3px; 
		margin-top: -10px; 
		margin-top: -25%; 
		height: 35px; 
		padding:5px
	}
				
	.btn_grid{
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
	}

	.btn_acao_header{
		background-image: none !important;
		color: #fff !important;
		font-weight: 600;
		width: 80px;
		height: 35px;
		font-size: 0.88em;
	}

	.btn_cor_padrao {
		background-color: var(--cor_principal) !important;
		border-color: var(--cor_principal) !important; 
	}

	.container{
		flex:1;
		width: -webkit-fill-available;
	}

	.divider{
		border-top: 1px solid rgb(230, 230, 230);
	}
	
	.divider-titulo{
		border-top: 0.8px solid rgb(230, 230, 230);
		border-bottom: 0.8px solid rgb(230, 230, 230);
		height: 50px;
		background-color:#FAFAFA;
		border-radius: 3px;
		box-shadow: 5px 1px 4px grey;
	}

	.itens-titulo{
		margin-top:-15px;
	}

	.spacer{
		margin-top:20px;
	}

	.spacer-input{
		margin-top:10px;
		margin-left:8px;
	}

	.titulo{
		font-size: 14px;
		font-weight: bolder;
	}

	.vcenter {
		display: flex;
		align-items: center;
	}

	#mySidebar {
	  height: 100%; /* 100% Full-height */
	  width: 0; /* 0 width - change this with JavaScript */
	  position: absolute; /* Stay in place */
	  z-index: 1; /* Stay on top */
	  top: 50;
	  left: 50;
	  background-color: rgba(255, 255, 255, 1); 
	  overflow-x: hidden; /* Disable horizontal scroll */
	  padding-top: 60px; /* Place content 60px from the top */
	  transition: 0.2s; /* 0.5 second transition effect to slide in the sidebar */ 
	  box-shadow: 0 5px 5px 0 rgba(0,0,0,0.50);
  
	}

	#mySidebar label {
	  padding: 5px 5px 5px 10px;
	  text-decoration: none;
	  font-size: 14px;
	  color: #000;
	  display: block;
	  transition: 0.2s;
	}
	
	#mySidebar input {
	  padding: 5px 5px 5px 10px;
	  margin-left: 10px;
	}

	.navbar-header, label {
	  display: inline !important
	}
	
	/* When you mouse over the navigation links, change their color */
	#mySidebar a:hover {
	  color: rgb(216, 216, 216);
	}

	/* The button used to open the sidebar */
	.openbtn {
	  font-size: 20px;
	  cursor: pointer;
	  background-color: #111;
	  color: white;
	  padding: 10px 15px;
	  border: none;
	}

	.inputTable{
		outline: 0;
		border-width: 0 0 0.5px;
		border-color: rgb(184, 184, 184);
		width: 50%;
		height: 35px;
		border-style: dashed;
	}

	.inputTable:focus{
		border-color: rgb(0, 0, 0);
		border-style: solid;
	}

	.inputTable:invalid{
		border-style: dashed;
		border-color: rgba(243, 3, 3, 0.568);
	}

	.openbtn:hover {
	  background-color: #444;
	}

	/* Style page content - use this if you want to push the page content to the right when you open the side navigation */
	#main {
	  transition: margin-left .2s; /* If you want a transition effect */
	  padding: 0px;
	  height: 100%;
	}

	.modal-body{
		padding:0;
		margin-top:15%;
	}

	.modal-content{
		margin-top:20%;
		background-color: rgb(247, 247, 247);
		border:0;
	}

	.modal{
		margin-left:-5%;
	}

	.bootbox-body{
		height: 50px;
		font-size: 1.1em;
		text-align: center;
		font-weight: 500;
	}

	.popup{
		height: 100px;
	}

	.modal-backdrop{
		visibility:hidden;
	}

	.new-row-enter{
		background-color: rgb(253, 249, 243);
	}

	/* On smaller screens, where height is less than 450px, change the style of the sidenav (less padding and a smaller font size) */
	@media screen and (max-height: 450px) {
	  .sidebar {padding-top: 15px;}
	  .sidebar a {font-size: 18px;}
	}

	/*Tabela produtos - Child rows*/
	.parent ~ .cchild {
		display: none;
	}
	.open .parent ~ .cchild {
		display: table-row;
	}
	.parent {
		cursor: pointer;
	}
	tbody {
		color: #212121;
	}
	.parent i {
		transform: rotate(0deg);
		transition: transform .3s cubic-bezier(.4,0,.2,1);
		margin: -.5rem;
		padding: .5rem;
	
	}

	.tableChange{
		margin-top: -2vh;
   		margin-left: 1px;
	}
	.open .parent i {
		transform: rotate(180deg)
	}
	</style>